<!-- 
  KERTASES PRO V9.0 - CYBER GLASS EDITION
  Fitur: Solid Connection Protocol, Cyber UI, Kres+, Split Workflow
-->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertases Pro V9.0</title>
    
    <!-- LIBRARIES -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- FONT TECHNO -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: #111111;
            --border: #333;
            --accent: #00f2ff; /* Cyber Cyan */
            --accent-glow: rgba(0, 242, 255, 0.3);
            --secondary: #bd00ff; /* Cyber Purple */
            --text-main: #e0e0e0;
            --text-dim: #666;
            --success: #00ff9d;
            --danger: #ff0055;
        }

        * { box-sizing: border-box; outline: none; }
        
        body, html {
            margin: 0; padding: 0;
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            height: 100vh; overflow: hidden;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: rgba(17, 17, 17, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .cyber-input {
            background: #000;
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 10px;
            width: 100%;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .cyber-input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .cyber-btn {
            background: linear-gradient(45deg, var(--bg-panel), #222);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        .cyber-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent-glow); }
        .cyber-btn.danger { border-color: var(--danger); color: var(--danger); }
        .cyber-btn.danger:hover { background: var(--danger); color: #fff; }

        /* --- SCREEN: LOGIN --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        
        .role-grid { display: flex; gap: 20px; margin-top: 30px; }
        .role-card {
            width: 200px; padding: 30px; text-align: center;
            border: 1px solid var(--border); cursor: pointer;
            transition: 0.3s; background: rgba(0,0,0,0.5);
        }
        .role-card:hover { transform: scale(1.05); border-color: var(--accent); background: var(--accent-glow); }
        .role-icon { font-size: 3rem; display: block; margin-bottom: 10px; }

        /* --- LAYOUT --- */
        #app-layout { display: none; height: 100vh; flex-direction: row; }
        
        .sidebar {
            width: 260px; background: #080808; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; flex-shrink: 0;
        }

        .main-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* --- SIDEBAR WIDGETS --- */
        .status-widget {
            border: 1px solid var(--border); padding: 15px; margin-bottom: 20px;
            position: relative; overflow: hidden;
        }
        .status-widget::before { content:''; position:absolute; top:0; left:0; width:4px; height:100%; background:var(--danger); transition:0.3s; }
        .status-widget.online::before { background: var(--success); }
        .status-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }
        .status-val { font-size: 1.2rem; font-weight: bold; color: #fff; font-family: 'Roboto Mono', monospace; }

        /* --- DESIGNER SPLIT VIEW --- */
        .split-container { display: flex; height: 100%; }
        .chat-panel { flex: 1; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: rgba(0,0,0,0.3); }
        .control-panel { width: 320px; background: #0c0c0c; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }

        .log-area { flex: 1; overflow-y: auto; padding: 20px; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; }
        .log-item { margin-bottom: 10px; padding: 10px; border-left: 2px solid var(--border); background: rgba(255,255,255,0.02); }
        .log-item.in { border-color: var(--success); }
        .log-item.out { border-color: var(--accent); }

        .upload-zone {
            border: 2px dashed var(--border); border-radius: 10px;
            padding: 30px; text-align: center; margin-bottom: 20px;
            cursor: pointer; transition: 0.3s; color: var(--text-dim);
        }
        .upload-zone:hover { border-color: var(--accent); color: var(--accent); background: rgba(0, 242, 255, 0.05); }
        
        .preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
        .preview-item { width: 100%; aspect-ratio: 1; background: #222; object-fit: cover; border: 1px solid #444; }

        /* --- OPERATOR GRID --- */
        .op-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; overflow-y: auto; height: 100%; }
        .job-card { 
            background: #111; border: 1px solid var(--border); 
            display: flex; flex-direction: column; transition: 0.2s; position: relative;
        }
        .job-card:hover { border-color: var(--success); transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0, 255, 157, 0.1); }
        .job-card img { width: 100%; height: 150px; object-fit: cover; background: #222; }
        .job-details { padding: 15px; }
        .job-inv { color: var(--success); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }

        /* --- MODAL PRINT --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 500px; background: #111; border: 1px solid var(--accent); padding: 30px; box-shadow: 0 0 50px var(--accent-glow); position: relative; }
        .modal-title { color: var(--accent); font-size: 1.5rem; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        label { display: block; color: var(--text-dim); font-size: 0.8rem; margin-bottom: 5px; }

        /* Connection Type Selector */
        .conn-type { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .type-btn { padding: 8px 15px; border: 1px solid var(--border); cursor: pointer; color: var(--text-dim); }
        .type-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

        @media (max-width: 768px) {
            #app-layout { flex-direction: column; }
            .sidebar { width: 100%; height: auto; padding: 10px; flex-direction: row; align-items: center; justify-content: space-between; }
            .split-container { flex-direction: column-reverse; }
            .control-panel { width: 100%; height: 50%; }
            .status-widget { display: none; } /* Hide on mobile to save space */
        }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <!-- STEP 1: CONNECTION TYPE & ROLE -->
    <div id="login-screen">
        <h1 style="font-size:3rem; color:var(--accent); text-shadow:0 0 20px var(--accent-glow); margin:0;">KERTASES <span style="color:#fff">PRO</span></h1>
        <div style="color:var(--text-dim); letter-spacing:3px; margin-bottom:40px;">V9.0 CYBER EDITION</div>

        <div class="conn-type">
            <div class="type-btn active" id="btn-cloud" onclick="setMode('cloud')">CLOUD (INTERNET)</div>
            <div class="type-btn" id="btn-local" onclick="setMode('local')">LOCAL (LAN)</div>
        </div>
        
        <div id="local-ip-box" style="display:none; margin-bottom:20px; width: 300px;">
            <input type="text" id="server-ip" class="cyber-input" placeholder="IP Server (Ex: 192.168.1.5)" style="text-align:center;">
        </div>

        <div class="role-grid">
            <div class="role-card" onclick="enterRole('admin')">
                <div class="role-icon">üï∂Ô∏è</div>
                <div>ADMIN</div>
            </div>
            <div class="role-card" onclick="enterRole('designer')">
                <div class="role-icon">üé®</div>
                <div>DESIGNER</div>
            </div>
            <div class="role-card" onclick="enterRole('operator')">
                <div class="role-icon">üñ®Ô∏è</div>
                <div>OPERATOR</div>
            </div>
        </div>
    </div>

    <!-- STEP 2: MAIN APP -->
    <div id="app-layout">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div style="font-size:1.5rem; font-weight:bold; color:var(--accent); margin-bottom:30px;">KERTASES</div>
            
            <div id="status-widget" class="status-widget">
                <div class="status-label">STATUS JARINGAN</div>
                <div id="status-text" class="status-val" style="color:var(--danger)">OFFLINE</div>
                <div class="status-label" style="margin-top:10px;">ID PERANGKAT</div>
                <div id="my-id-display" class="status-val" style="font-size:0.9rem; word-break:break-all;">...</div>
            </div>

            <div style="margin-bottom:20px;">
                <label>TARGET ID:</label>
                <input type="text" id="target-id" class="cyber-input" placeholder="ID Lawan Bicara...">
                <button class="cyber-btn" style="width:100%; margin-top:10px;" onclick="connectToPeer()">CONNECT</button>
            </div>

            <div style="margin-top:auto;">
                <button class="cyber-btn" style="width:100%; border-color:var(--text-dim); color:var(--text-dim);" onclick="toggleHistory()">DATA RIWAYAT</button>
                <button class="cyber-btn danger" style="width:100%; margin-top:10px;" onclick="location.reload()">LOGOUT</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-view">
            
            <!-- VIEW: DESIGNER (SPLIT VIEW) -->
            <div id="view-designer" class="split-container" style="display:none;">
                <!-- Left: Log / Chat -->
                <div class="chat-panel">
                    <div style="padding:15px; border-bottom:1px solid var(--border); color:var(--text-dim); font-size:0.8rem;">LOG AKTIVITAS</div>
                    <div id="chat-box" class="log-area">
                        <div style="text-align:center; color:var(--text-dim); margin-top:50px;">-- Menunggu Koneksi --</div>
                    </div>
                </div>
                
                <!-- Right: Controls -->
                <div class="control-panel">
                    <div class="upload-zone" onclick="document.getElementById('file-in').click()">
                        <div style="font-size:2rem; margin-bottom:10px;">üìÅ</div>
                        KLIK UNTUK PILIH FILE
                    </div>
                    
                    <div id="preview-area" class="preview-grid"></div>
                    
                    <label>NOMOR INVOICE</label>
                    <input type="text" id="inv-in" class="cyber-input" style="margin-bottom:10px;">
                    
                    <label>CATATAN OPERATOR</label>
                    <input type="text" id="cap-in" class="cyber-input" style="margin-bottom:10px;">
                    
                    <div style="display:flex; align-items:center; margin-bottom:20px; gap:10px;">
                        <input type="checkbox" id="hd-mode" checked> <span style="font-size:0.8rem;">MODE HD (Kualitas Tinggi)</span>
                    </div>

                    <input type="file" id="file-in" multiple style="display:none;" onchange="prepareFiles(this)">
                    <button class="cyber-btn" onclick="sendData()">KIRIM KE OPERATOR</button>
                </div>
            </div>

            <!-- VIEW: OPERATOR -->
            <div id="view-operator" style="display:none; flex-direction:column; height:100%;">
                <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:bold; color:var(--success);">ANTREAN MASUK</div>
                    <div>
                        <input type="file" id="op-upload" multiple style="display:none;" onchange="handleOpUpload(this)">
                        <button class="cyber-btn" style="padding:5px 15px; font-size:0.8rem;" onclick="document.getElementById('op-upload').click()">+ MANUAL</button>
                        <button class="cyber-btn danger" style="padding:5px 15px; font-size:0.8rem;" onclick="clearQueue()">BERSIHKAN</button>
                    </div>
                </div>
                <div id="print-queue" class="op-grid"></div>
            </div>

        </div>
    </div>

    <!-- MODAL PRINT -->
    <div id="modal-print" class="modal">
        <div class="modal-box">
            <div class="modal-title">SETUP CETAK</div>
            
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="width:120px; height:120px; background:#222; display:flex; align-items:center; justify-content:center; border:1px solid var(--border);">
                    <img id="p-img" style="max-width:100%; max-height:100%;">
                    <div id="p-pdf-icon" style="display:none; font-size:2rem;">PDF</div>
                </div>
                <div style="flex:1;">
                    <label>INVOICE</label>
                    <input type="text" id="p-inv" class="cyber-input" style="margin-bottom:10px;">
                    <label>JENIS BAHAN</label>
                    <select id="p-mat" class="cyber-input">
                        <option>Chromo</option><option>Vinyl Glossy</option><option>Vinyl Matte</option><option>Transparan</option><option>HVS</option><option>Art Carton</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div style="flex:1;">
                    <label>UKURAN KERTAS</label>
                    <select id="p-size" class="cyber-input" onchange="calc()">
                        <option value="a3plus">A3+ (32x48)</option>
                        <option value="a3">A3 (29.7x42)</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>ORDER (DATA)</label>
                    <input type="text" id="p-order" class="cyber-input" placeholder="Qty Pcs">
                </div>
            </div>

            <div id="img-dim-box" class="form-row">
                <div style="flex:1;"><label>W (cm)</label><input type="number" id="p-w" value="5" step="0.1" class="cyber-input" oninput="calc()"></div>
                <div style="flex:1;"><label>H (cm)</label><input type="number" id="p-h" value="5" step="0.1" class="cyber-input" oninput="calc()"></div>
                <div style="display:flex; align-items:end;"><button class="cyber-btn" onclick="toggleRot()" style="padding:10px;">üîÑ</button></div>
            </div>

            <label>TARGET CETAK (LEMBAR)</label>
            <input type="number" id="p-target" value="1" class="cyber-input" style="font-size:1.5rem; text-align:center; color:var(--success); font-weight:bold;" oninput="calc()">
            
            <div id="p-res" style="text-align:center; color:var(--text-dim); margin:15px 0; font-family:'Roboto Mono';">...</div>

            <div style="display:flex; gap:10px;">
                <button class="cyber-btn danger" style="flex:1;" onclick="document.getElementById('modal-print').style.display='none'">BATAL</button>
                <button class="cyber-btn" style="flex:2;" onclick="doPrint()">PROSES</button>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORY -->
    <div id="modal-hist" class="modal">
        <div class="modal-box" style="width:700px;">
            <div class="modal-title">RIWAYAT PRODUKSI</div>
            <div style="height:300px; overflow-y:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.8rem; color:var(--text-dim);">
                    <thead style="border-bottom:1px solid var(--accent); color:var(--accent);"><tr><th>WAKTU</th><th>INV</th><th>BAHAN</th><th>OUT</th><th>DATA</th></tr></thead>
                    <tbody id="hist-body"></tbody>
                </table>
            </div>
            <button class="cyber-btn" style="width:100%; margin-top:15px;" onclick="toggleHistory()">TUTUP</button>
        </div>
    </div>

    <iframe id="p-frame" style="display:none;"></iframe>

    <script>
        const ROLES = { admin: "calik", designer: "melengkung", operator: "nangtung" };
        let cfg = { mode: 'cloud', host: 'localhost' };
        let myId = localStorage.getItem('kts_id') || 'CYBER-' + Math.floor(Math.random()*9999);
        let role, peer, conn, db, activeJob, tempFiles = [];

        // --- 1. INITIALIZATION & DB ---
        let req = indexedDB.open("KertasesCyberV9", 1);
        req.onupgradeneeded = e => {
            let d = e.target.result;
            d.createObjectStore("queue", { keyPath: "id", autoIncrement:true });
            d.createObjectStore("history", { keyPath: "id", autoIncrement:true });
        };
        req.onsuccess = e => db = e.target.result;

        // --- 2. LOGIN & CONNECTION SETUP ---
        function setMode(m) {
            cfg.mode = m;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+m).classList.add('active');
            document.getElementById('local-ip-box').style.display = m === 'local' ? 'block' : 'none';
        }

        function enterRole(r) {
            if(prompt(`KODE AKSES ${r.toUpperCase()}:`) === ROLES[r]) {
                role = r;
                if(cfg.mode === 'local') cfg.host = document.getElementById('server-ip').value || 'localhost';
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-layout').style.display = 'flex';
                document.getElementById('my-id-display').innerText = myId;
                
                // Restore last target
                document.getElementById('target-id').value = localStorage.getItem('kts_last_target') || '';

                if(r === 'operator') {
                    document.getElementById('view-operator').style.display = 'flex';
                    if(db) renderQ();
                } else {
                    document.getElementById('view-designer').style.display = 'flex';
                }
                
                initPeer();
            } else alert("AKSES DITOLAK!");
        }

        // --- 3. PEERJS LOGIC (FIXED) ---
        function initPeer() {
            updateStatus('offline');
            
            if(cfg.mode === 'local') {
                peer = new Peer(myId, { host: cfg.host, port: 9000, path: '/kertases-app' });
            } else {
                peer = new Peer(myId); // Default Cloud
            }

            peer.on('open', id => {
                updateStatus('ready');
                console.log("ID Active:", id);
            });

            peer.on('connection', c => {
                conn = c;
                setupConn(c);
            });

            peer.on('error', err => {
                console.error(err);
                logChat(`SYSTEM ERROR: ${err.type}`);
                updateStatus('offline');
            });
            
            peer.on('disconnected', () => updateStatus('offline'));
        }

        function connectToPeer() {
            let t = document.getElementById('target-id').value.trim();
            if(!t) return alert("INPUT ID TARGET!");
            localStorage.setItem('kts_last_target', t);
            
            conn = peer.connect(t, { reliable: true });
            setupConn(conn);
        }

        function setupConn(c) {
            c.on('open', () => {
                updateStatus('online');
                // Handshake to ensure connection is really alive
                c.send({type: 'handshake', from: myId});
            });

            c.on('data', d => {
                document.getElementById('notif-sound').play().catch(()=>{});
                
                if(d.type === 'handshake') {
                    logChat(`TERHUBUNG DENGAN: ${d.from}`);
                } else if(role === 'operator' && d.type === 'job') {
                    pushToDB(d);
                } else if(d.type === 'done') {
                    logChat(`‚úÖ JOB ${d.inv} SELESAI DICETAK`);
                } else if(d.type === 'msg') {
                    logChat(`MSG: ${d.text}`);
                }
            });

            c.on('close', () => updateStatus('ready'));
            c.on('error', () => updateStatus('ready'));
        }

        function updateStatus(s) {
            const el = document.getElementById('status-widget');
            const txt = document.getElementById('status-text');
            el.className = 'status-widget'; // reset
            if(s === 'online') {
                el.classList.add('online');
                txt.innerText = "TERHUBUNG";
                txt.style.color = "var(--success)";
            } else if(s === 'ready') {
                txt.innerText = "STANDBY";
                txt.style.color = "var(--warning)";
            } else {
                txt.innerText = "OFFLINE";
                txt.style.color = "var(--danger)";
            }
        }

        function logChat(msg) {
            const b = document.getElementById('chat-box');
            b.innerHTML += `<div class="log-item in">${msg} <span style="float:right; font-size:0.7rem; opacity:0.5;">${new Date().toLocaleTimeString()}</span></div>`;
            b.scrollTop = b.scrollHeight;
        }

        // --- 4. DESIGNER LOGIC ---
        async function prepareFiles(input) {
            tempFiles = [];
            const grid = document.getElementById('preview-area');
            grid.innerHTML = '';
            
            for(let f of input.files) {
                let isPdf = f.type === 'application/pdf';
                let data = isPdf ? await toBase64(f) : (document.getElementById('hd-mode').checked ? await toBase64(f) : await compress(f));
                
                tempFiles.push({ data, isPdf });
                
                let div = document.createElement('div');
                div.className = 'preview-item';
                if(isPdf) {
                    div.style.background = '#ff0055';
                    div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.justifyContent = 'center';
                    div.innerHTML = '<b>PDF</b>';
                } else {
                    div.style.backgroundImage = `url(${data})`;
                    div.style.backgroundSize = 'cover';
                }
                grid.appendChild(div);
            }
        }

        function sendData() {
            if(!conn || !conn.open) return alert("BELUM TERHUBUNG!");
            if(tempFiles.length === 0) return alert("FILE KOSONG!");
            
            let d = { 
                type: 'job', 
                files: tempFiles, 
                inv: document.getElementById('inv-in').value || 'NO-INV',
                cap: document.getElementById('cap-in').value,
                id: Date.now()
            };
            
            try {
                conn.send(d);
                logChat(`üì§ TERKIRIM: ${d.inv} (${tempFiles.length} File)`);
                saveHist(tempFiles.length, "KIRIM", d.inv, "-");
                
                // Reset
                tempFiles = []; 
                document.getElementById('preview-area').innerHTML = '';
                document.getElementById('inv-in').value = '';
                document.getElementById('cap-in').value = '';
            } catch(e) {
                alert("GAGAL KIRIM. KONEKSI TIDAK STABIL.");
            }
        }

        // --- 5. OPERATOR LOGIC ---
        function pushToDB(d) {
            let tx = db.transaction("queue", "readwrite");
            d.files.forEach(f => {
                tx.objectStore("queue").add({ ...f, inv: d.inv, batchId: d.id });
            });
            tx.oncomplete = renderQ;
        }

        async function handleOpUpload(input) {
            for(let f of input.files) {
                let isPdf = f.type === 'application/pdf';
                let data = await toBase64(f);
                let tx = db.transaction("queue", "readwrite");
                tx.objectStore("queue").add({ data, isPdf, inv: 'MANUAL', batchId: Date.now() });
                tx.oncomplete = renderQ;
            }
        }

        function renderQ() {
            const q = document.getElementById('print-queue'); q.innerHTML = '';
            db.transaction("queue").objectStore("queue").getAll().onsuccess = e => {
                e.target.result.reverse().forEach(i => {
                    let card = document.createElement('div'); card.className = 'job-card';
                    let thumb = i.isPdf ? '<div style="height:150px; display:flex; align-items:center; justify-content:center; background:#333; color:white; font-size:2rem;">PDF</div>' : `<img src="${i.data}">`;
                    
                    card.innerHTML = `
                        ${thumb}
                        <div class="job-details">
                            <div class="job-inv">${i.inv}</div>
                            <div style="font-size:0.8rem; color:#888;">${i.isPdf?'DOKUMEN PDF':'IMAGE FILE'}</div>
                            <button class="cyber-btn" style="width:100%; margin-top:10px; font-size:0.8rem;" onclick="openPrint(${i.id})">PROSES</button>
                        </div>`;
                    q.appendChild(card);
                });
            };
        }

        // --- 6. PRINT ENGINE (KRES+) ---
        function openPrint(id) {
            db.transaction("queue").objectStore("queue").get(id).onsuccess = e => {
                activeJob = e.target.result;
                document.getElementById('modal-print').style.display = 'flex';
                document.getElementById('p-inv').value = activeJob.inv;
                
                if(activeJob.isPdf) {
                    document.getElementById('p-img').style.display = 'none';
                    document.getElementById('p-pdf-icon').style.display = 'block';
                    document.getElementById('img-dim-box').style.display = 'none';
                } else {
                    document.getElementById('p-img').style.display = 'block';
                    document.getElementById('p-pdf-icon').style.display = 'none';
                    document.getElementById('img-dim-box').style.display = 'flex';
                    document.getElementById('p-img').src = activeJob.data;
                }
                calc();
            };
        }

        function toggleRot() {
            let w = document.getElementById('p-w').value;
            let h = document.getElementById('p-h').value;
            document.getElementById('p-w').value = h;
            document.getElementById('p-h').value = w;
            calc();
        }

        function calc() {
            let s = document.getElementById('p-size').value;
            let pW = s==='a3'?29.7:32, pH = s==='a3'?42:48;
            let target = parseInt(document.getElementById('p-target').value);
            
            if(activeJob.isPdf) {
                document.getElementById('p-res').innerText = `PDF: ${target} LEMBAR`;
            } else {
                let w = parseFloat(document.getElementById('p-w').value);
                let h = parseFloat(document.getElementById('p-h').value);
                let pcs = Math.floor(pW/w) * Math.floor(pH/h);
                document.getElementById('p-res').innerText = `MUAT: ${pcs} PCS/LBR | TOTAL: ${pcs*target} PCS`;
            }
        }

        function doPrint() {
            let s = document.getElementById('p-size').value;
            let pW = s==='a3'?29.7:32, pH = s==='a3'?42:48;
            let target = parseInt(document.getElementById('p-target').value);
            
            // KRES PLUS (+)
            const mk = (t, l) => `<div style="position:absolute; top:${t}; left:${l}; width:0; height:0; z-index:99; overflow:visible;"><div style="position:absolute; top:-2mm; left:-0.1mm; width:0.2mm; height:4mm; background:black;"></div><div style="position:absolute; top:-0.1mm; left:-2mm; width:4mm; height:0.2mm; background:black;"></div></div>`;

            let h = `<style>@page{size:${pW}cm ${pH}cm; margin:0;} body{margin:0; overflow:hidden;} .grid{display:flex; flex-wrap:wrap; width:${pW}cm; align-content:flex-start;} .cell{position:relative; overflow:hidden; margin:0; padding:0; box-sizing:border-box;} .cell img{width:100%; height:100%; object-fit:fill; display:block;}</style>`;

            if(activeJob.isPdf) {
                for(let i=0; i<target; i++) h += `<div style="width:${pW}cm; height:${pH}cm; page-break-after:always;"><iframe src="${activeJob.data}" style="width:100%; height:100%; border:none;"></iframe></div>`;
            } else {
                let w = document.getElementById('p-w').value, h_img = document.getElementById('p-h').value;
                let grid = `<div class="grid">`;
                let pcs = Math.floor(pW/w) * Math.floor(pH/h_img);
                let cell = `<div class="cell" style="width:${w}cm; height:${h_img}cm;"><img src="${activeJob.data}">${mk('0','0')}${mk('0','100%')}${mk('100%','0')}${mk('100%','100%')}</div>`;
                for(let i=0; i<pcs; i++) grid += cell;
                grid += `</div>`;
                for(let i=0; i<target; i++) h += `<div style="page-break-after:always;">${grid}<div style="position:absolute; bottom:10px; right:10px; font-size:10px; font-family:sans-serif;">${activeJob.inv}</div></div>`;
            }

            let f = document.getElementById('p-frame').contentWindow;
            f.document.open(); f.document.write(h); f.document.close();
            setTimeout(() => {
                f.print();
                saveHist(target, "CETAK", document.getElementById('p-inv').value, document.getElementById('p-order').value);
                if(conn && conn.open) conn.send({type:'done', batchId: activeJob.batchId, inv: activeJob.inv});
                document.getElementById('modal-print').style.display='none';
            }, 800);
        }

        // --- UTILS ---
        function saveHist(lbr, action, inv, order) {
            let tx = db.transaction("history", "readwrite");
            tx.objectStore("history").add({
                time: new Date().toLocaleString(),
                role, action, inv: inv||'-',
                mat: action==="CETAK" ? document.getElementById('p-mat').value : "-",
                lbr, order: order||'-'
            });
        }

        function toggleHistory() {
            let m = document.getElementById('modal-hist');
            m.style.display = m.style.display === 'none' ? 'flex' : 'none';
            if(m.style.display === 'flex') {
                db.transaction("history").objectStore("history").getAll().onsuccess = e => {
                    let b = document.getElementById('hist-body'); b.innerHTML = '';
                    e.target.result.reverse().forEach(r => {
                        b.innerHTML += `<tr><td>${r.time}</td><td>${r.inv}</td><td>${r.mat}</td><td>${r.lbr}</td><td>${r.order}</td></tr>`;
                    });
                };
            }
        }

        function clearQueue() { if(confirm("RESET ANTREAN?")) db.transaction("queue","readwrite").objectStore("queue").clear().onsuccess = renderQ; }
        function toBase64(f) { return new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }); }
        function compress(f) { return new Promise(r => { let fr=new FileReader(); fr.onload=e=>{ let i=new Image(); i.onload=()=>{ let c=document.createElement('canvas'); let sc=Math.min(1000/i.width, 1); c.width=i.width*sc; c.height=i.height*sc; c.getContext('2d').drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.8)); }; i.src=e.target.result; }; fr.readAsDataURL(f); }); }
    </script>
</body>
</html>
