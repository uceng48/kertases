<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertases_Data_Sync</title>

    <!-- Library Lokal & CDN -->

   <!-- Library Lokal -->
    <script src="peerjs.min.js"></script>
    <script src="pdf.min.js"></script>
    <script src="jspdf.umd.min.js"></script>
    <script src="jspdf.plugin.autotable.min.js"></script>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@300;400;500;600&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0a0f1d; --panel: rgba(21, 32, 54, 0.9); --border: rgba(255, 255, 255, 0.1);
            --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981; --danger: #f43f5e; --warning: #f59e0b;
            --text: #f8fafc; --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; }
        body, html {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.1) 0%, transparent 40%);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .glass-panel { background: var(--panel); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 20px !important; }
        
        .cyber-input { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); 
            border-radius: 12px !important; color: #fff; padding: 12px 14px; font-size: 0.85rem; width: 100%; 
        }
        .cyber-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

        .btn {
            border-radius: 12px !important; border: none; padding: 10px 18px; cursor: pointer;
            font-weight: 600; font-family: 'Outfit', sans-serif; font-size: 0.8rem;
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--border); }
        .btn-mini { padding: 6px 12px; font-size: 0.7rem; border-radius: 8px !important; }

        /* --- KODE NO 1.CSS (Gaya Tombol Aktif) --- */
        .filter-bar .btn.active {
            background: var(--accent) !important;
            color: white !important;
            border-color: var(--accent) !important;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: var(--bg); }
        .login-box { padding: 50px; text-align: center; max-width: 480px; width: 90%; border-radius: 30px !important; }
        .role-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; }
        .role-card { padding: 25px 10px; border: 1px solid var(--border); border-radius: 20px !important; cursor: pointer; background: rgba(255,255,255,0.02); transition: 0.3s; }
        .role-card:hover { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); transform: translateY(-5px); }

        /* Layout */
        #app-layout { display: none; height: 100vh; flex-direction: row; padding: 15px; gap: 15px; }
        .sidebar { width: 280px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        .main-view { flex: 1; display: grid; grid-template-columns: 1fr 350px; gap: 15px; height: 100%; overflow: hidden; }

        .timeline { display: flex; flex-direction: column; overflow: hidden; }
        .timeline-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-bar { display: flex; gap: 5px; padding: 10px 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.1); overflow-x: auto; }
        .stream-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .batch-bar { display: none; justify-content: space-between; align-items: center; padding: 10px 20px; margin: 15px 15px 0 15px; background: rgba(16, 185, 129, 0.15); border: 1px solid var(--success); border-radius: 16px; gap: 15px; min-height: 50px; }

        /* MSG CARDS (Rounded Style No 3) */
        .msg-card { width: 100%; max-width: 450px; border-radius: 20px !important; border: 1px solid var(--border); background: rgba(255,255,255,0.03); overflow: hidden; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .msg-card.selected { border: 2px solid var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .msg-header { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.75rem; color: var(--text-dim); display: flex; justify-content: space-between; align-items: center; }
        .msg-body { padding: 15px; }
        .msg-card.printed { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .msg-card.in { align-self: flex-start; border-left: 4px solid var(--accent); }
        .msg-card.out { align-self: flex-end; border-right: 4px solid var(--accent); }

        .printed-badge { background: var(--success); color: #000; font-size: 0.6rem; font-weight: 800; padding: 2px 8px; border-radius: 10px; }
        .role-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 6px; background: var(--border); margin-left: 5px; text-transform: uppercase; }

        /* Input Card Edit (Kode No 3) */
        .card-edit-inv { background: transparent; border: none; color: var(--accent); font-weight: 700; font-size: 1.1rem; width: 100%; font-family: 'Outfit'; margin-bottom: 5px; border-bottom: 1px dashed var(--border); }
        .card-edit-cap { background: rgba(0,0,0,0.2); border: 1px solid transparent; color: var(--text-dim); font-size: 0.85rem; width: 100%; padding: 10px; border-radius: 12px !important; resize: none; min-height: 50px; margin-bottom: 10px; }

        .thumb-row-wrap { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 12px !important; margin-top: 8px; }
        .thumb-box { width: 60px; height: 60px; background: #000; border-radius: 10px !important; overflow: hidden; border: 1px solid var(--border); position: relative; flex-shrink: 0; }
        .thumb-box img { width: 100%; height: 100%; object-fit: contain; }
        .pdf-tag { position: absolute; bottom: 2px; right: 2px; background: #f43f5e; color: white; font-size: 8px; padding: 1px 3px; border-radius: 3px; }

        .status-widget { padding: 15px; border-radius: 16px !important; border: 1px solid var(--border); background: rgba(0,0,0,0.3); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; background: #64748b; }
        .online .status-dot { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* Modal Log */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { max-height: 90vh; overflow-y: auto; border-radius: 24px !important; padding: 30px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { padding: 15px; color: var(--accent); border-bottom: 1px solid var(--border); font-size: 0.75rem; }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem; text-align: center; }

        #kts-prompt { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .kts-prompt-box { background:#152036; padding:30px; border-radius:24px !important; border:1px solid #6366f1; width:350px; text-align:center; box-shadow: 0 0 30px rgba(99,102,241,0.2); }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <!-- PROMPT -->
    <div id="kts-prompt">
        <div class="kts-prompt-box">
            <h3 id="p-title" style="margin-top:0; font-family:'Outfit'; color:#6366f1;">Input Required</h3>
            <p id="p-desc" style="font-size:0.8rem; color:#94a3b8; margin-bottom:20px;"></p>
            <input type="text" id="p-val" class="cyber-input" style="text-align:center;">
            <div style="display:flex; gap:10px; margin-top:25px;">
                <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('kts-prompt').style.display='none'">CANCEL</button>
                <button class="btn btn-primary" style="flex:1" onclick="confirmKts()">OK</button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN (Pilihan Cloud/Local Dijaga) -->
    <div id="login-screen">
        <div class="login-box glass-panel">
            <h1 style="font-family: 'Outfit'; font-size: 2.5rem; margin: 0; background: linear-gradient(to right, #6366f1, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">KERTASES PRO</h1>
            <p style="color: var(--text-dim); font-size: 0.85rem; letter-spacing: 3px;">V14.4 ROUNDED UI</p>
            
            <div class="role-grid">
                <div class="role-card" onclick="enterRole('admin')"><i>üï∂Ô∏è</i><span>ADMIN</span></div>
                <div class="role-card" onclick="enterRole('designer')"><i>üé®</i><span>DESIGNER</span></div>
                <div class="role-card" onclick="enterRole('operator')"><i>üñ®Ô∏è</i><span>OPERATOR</span></div>
            </div>

            <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                <button id="btn-cloud" class="btn btn-primary btn-mini" onclick="setMode('cloud')">CLOUD</button>
                <button id="btn-local" class="btn btn-outline btn-mini" onclick="setMode('local')">LOCAL LAN</button>
            </div>
        </div>
    </div>

    <div id="app-layout">
        <!-- SIDEBAR (Log & ID MY TETAP ADA) -->
        <div class="sidebar glass-panel">
            <div style="padding: 20px; text-align: center;">
                <div id="active-role-display" class="btn btn-primary btn-mini" style="border-radius: 20px !important; padding: 5px 20px;">---</div>
                <div id="status-widget" class="status-widget" style="margin-top: 20px; text-align: left;">
                    <div style="font-weight: 700; font-size: 0.8rem; display: flex; align-items: center;">
                        <span class="status-dot"></span> <span id="status-text">OFFLINE</span>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 8px; cursor:pointer;" onclick="changeId()">
                        MY ID: <span id="my-id-display" style="color: var(--accent); font-weight: bold;">...</span>
                    </div>
                </div>
            </div>

            <div style="padding: 0 20px;">
                <label style="font-size: 0.65rem; color: var(--text-dim);">CONNECT PARTNER:</label>
                <input type="text" id="target-id" class="cyber-input" placeholder="ID partner...">
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="connectMulti()">LINK CONNECT</button>
            </div>
            
            <div id="active-conns" style="padding: 10px 20px; flex: 1; overflow-y: auto;"></div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-outline btn-mini" style="width: 100%; margin-bottom: 8px; color:var(--accent); border-color:var(--accent);" onclick="toggleHistory()">PRODUCTION LOG</button>
                <button class="btn btn-success btn-mini" style="width: 100%; margin-bottom: 8px;" onclick="location.reload()">üîÑ REFRESH</button>
                <button class="btn btn-mini btn-outline" style="width: 100%; border:none; color: var(--danger);" onclick="doLogout()">LOGOUT</button>
            </div>
        </div>

        <div class="main-view">
            <div class="timeline glass-panel">
                <div id="batch-bar" class="batch-bar">
                    <span id="batch-count" style="font-size: 0.75rem; font-weight: 700;">0 ITEM DIPILIH</span>
                    <button class="btn btn-success btn-mini" onclick="openBatchPrint()">PROSES BATCH</button>
                </div>
                <div class="timeline-header">
                    <span style="font-weight: 700; font-family: 'Outfit';">TIMELINE FLOW</span>
                    <button class="btn btn-danger btn-mini" onclick="clearTimeline()">CLEAR</button>
                </div>
                
                <!-- --- KODE NO 2.HTML (Filtering Bar anyar) --- -->
                <div class="filter-bar">
                    <button class="btn btn-mini btn-outline active" onclick="setTimelineFilter('all', this)">ALL</button>
                    <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('admin', this)">FROM ADMIN</button>
                    <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('designer', this)">FROM DESIGNER</button>
                    <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('printed', this)">DATA CETAK</button>
                </div>

                <div id="stream-area" class="stream-area"></div>
            </div>

            <div class="control-panel glass-panel" style="padding: 20px; overflow-y: auto;">
                <span style="font-weight: 700; font-family: 'Outfit';">TRANSMIT ASSETS</span>
                <div id="job-list" style="margin-top:15px;"></div>
                <button class="btn btn-outline" style="border-style: dashed; width: 100%; margin-top:10px;" onclick="addNewJob()">+ ADD DATA</button>
                <button id="btn-action-main" class="btn btn-primary" style="width: 100%; margin-top: 15px; height: 50px;" onclick="mainAction()">PROCESS DATA</button>
                <input type="file" id="job-file-in" multiple style="display:none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>

    <!-- MODAL LOG (Dijaga) -->
    <div id="modal-hist" class="modal">
        <div class="modal-box glass-panel" style="width: 90%; max-width: 900px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 style="font-family:'Outfit'; margin:0;">System Log - <span id="hist-role-title">...</span></h2>
                <button class="btn btn-danger btn-mini" onclick="clearAllHistory()">CLEAR LOG</button>
            </div>
            <div style="max-height:400px; overflow-y:auto;">
                <table id="hist-table">
                    <thead><tr><th>WAKTU</th><th>INV</th><th>KET</th><th>PARTNER</th><th>AKSI</th></tr></thead>
                    <tbody id="hist-body"></tbody>
                </table>
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:20px;" onclick="toggleHistory()">CLOSE</button>
        </div>
    </div>

    <!-- MODAL PRINT -->
    <div id="modal-print" class="modal">
        <div class="modal-box glass-panel" style="width: 600px; padding: 30px;">
            <h2 style="font-family:'Outfit'; margin-top:0;">Production Setup</h2>
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div class="glass-panel" style="width:120px; height:120px; background:#000; overflow:hidden;">
                    <img id="p-img" style="width:100%; height:100%; object-fit:contain;">
                </div>
                <div style="flex:1;">
                    <label style="font-size:0.7rem;">INVOICE</label>
                    <input type="text" id="p-inv-edit" class="cyber-input" style="color:var(--warning); font-weight:700;">
                    <label style="font-size:0.7rem; margin-top:10px; display:block;">QTY LEMBAR</label>
                    <input type="number" id="p-pdf-target" value="1" class="cyber-input" style="font-size:1.2rem; text-align:center; color:var(--success);">
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-danger" onclick="closeModal()">BATAL</button>
                <button id="btn-do-print" class="btn btn-primary" onclick="executeFullPrint()">MULAI CETAK</button>
            </div>
        </div>
    </div>

    <iframe id="p-frame" style="display:none;"></iframe>

    <script>
        const ROLES_KEYS = { admin: "calik", designer: "melengkung", operator: "nangtung" };
        let myId = localStorage.getItem('kts_id') || 'KTS-' + Math.floor(Math.random()*9999);
        let role, peer, db, activeConns = [], timelineFilter = 'all', selectedInboxes = [];
        let tempJobs = [], activeJobIdx = null, activeJob = null, currentPromptTask = null;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let req = indexedDB.open("KertasesV14_4_DB", 1);
        req.onupgradeneeded = e => {
            let d = e.target.result;
            d.createObjectStore("stream", { keyPath: "id" });
            d.createObjectStore("history", { keyPath: "id", autoIncrement:true });
        };
        req.onsuccess = e => { db = e.target.result; checkAutoLogin(); };

        function checkAutoLogin() {
            const savedRole = localStorage.getItem('kts_active_role');
            if(savedRole) loadInterface(savedRole);
        }

        function setMode(m) {
            if(m === 'local') {
                openKtsPrompt("Local LAN", "Masukkan IP Server:", "text", (ip) => {
                    localStorage.setItem('kts_mode', 'local');
                    localStorage.setItem('kts_ip', ip);
                    location.reload();
                });
            } else {
                localStorage.setItem('kts_mode', 'cloud');
                location.reload();
            }
        }

        function enterRole(r) {
            openKtsPrompt("Login " + r.toUpperCase(), "Masukkan Kode Akses:", "password", (pass) => {
                if(pass === ROLES_KEYS[r]) {
                    localStorage.setItem('kts_active_role', r);
                    loadInterface(r);
                } else { alert("SALAH KODE!"); }
            });
        }

        function loadInterface(r) {
            role = r;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-layout').style.display = 'flex';
            document.getElementById('active-role-display').innerText = role.toUpperCase();
            document.getElementById('my-id-display').innerText = myId;
            if(role === 'operator') document.getElementById('batch-bar').style.display = 'flex';
            initPeer(); 
            addNewJob(); 
            renderStream();
        }

        function initPeer() {
            const mode = localStorage.getItem('kts_mode') || 'cloud';
            const savedIp = localStorage.getItem('kts_ip') || 'localhost';
            const opts = (mode === 'local') ? { host: savedIp, port: 9000, path: '/kertases-app', secure: false } : { debug: 1 };
            
            peer = new Peer(myId, opts);
            peer.on('open', () => updateStatus('ready'));
            peer.on('connection', c => setupConn(c));
        }

        function updateStatus(s) { 
            const w = document.getElementById('status-widget');
            w.className = 'status-widget ' + (activeConns.length > 0 ? 'online' : s);
            document.getElementById('status-text').innerText = activeConns.length > 0 ? 'CONNECTED' : s.toUpperCase();
        }

        function connectMulti() {
            const tid = document.getElementById('target-id').value.trim();
            if(!tid || tid === myId) return alert("ID Salah!");
            setupConn(peer.connect(tid));
        }

        function setupConn(c) {
            c.on('open', () => {
                if(!activeConns.find(x => x.peer === c.peer)) {
                    activeConns.push(c); updateStatus('online'); updateConnUI();
                }
            });
            c.on('data', d => {
                if(d.type === 'job') handleIncoming(d, c.peer);
                if(d.type === 'status_update') handleStatusUpdate(d);
            });
        }

        function updateConnUI() { 
            document.getElementById('active-conns').innerHTML = activeConns.map(x => `<div class="glass-panel" style="padding:8px; margin-bottom:5px; font-size:0.7rem; border-color:var(--success); border-radius:10px !important;">üü¢ ${x.peer}</div>`).join(''); 
        }

        function handleIncoming(d, from) {
            saveStream({ ...d, direction: 'in', from: from });
            saveHistory({ inv: d.jobs[0].inv, partner: from, type: 'INCOMING' });
            renderStream(); 
            document.getElementById('notif-sound').play().catch(()=>{});
        }

        function handleStatusUpdate(d) {
            let tx = db.transaction("stream", "readwrite");
            tx.objectStore("stream").get(d.msgId).onsuccess = e => {
                let data = e.target.result;
                if(data) { data.status = 'printed'; tx.objectStore("stream").put(data).onsuccess = () => renderStream(); }
            };
        }

        // --- KODE NO 3.JS (FILTER & RENDER UPDATE) ---

        function setTimelineFilter(f, btn) {
            timelineFilter = f;
            const buttons = document.querySelectorAll('.filter-bar .btn');
            buttons.forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderStream();
        }

        function renderStream() {
            const area = document.getElementById('stream-area'); 
            if(!area || !db) return;
            area.innerHTML = '';
            
            db.transaction("stream").objectStore("stream").getAll().onsuccess = e => {
                e.target.result.forEach(msg => {
                    if(msg.hidden) return;
                    if(role === 'admin' && msg.direction === 'in') return;
                    if(role === 'operator' && msg.direction === 'out') return;
                    
                    if(timelineFilter === 'admin' && msg.senderRole !== 'admin') return;
                    if(timelineFilter === 'designer' && msg.senderRole !== 'designer') return;
                    if(timelineFilter === 'printed' && msg.status !== 'printed') return; 

                    const isSelected = selectedInboxes.includes(msg.id);
                    let card = document.createElement('div');
                    card.className = `msg-card ${msg.direction} ${msg.status === 'printed' ? 'printed' : ''} ${isSelected ? 'selected' : ''}`;
                    
                    let printedMark = msg.status === 'printed' ? `<div class="printed-badge">TOS DICETAK</div>` : '';
                    let roleTag = `<span class="role-tag">${msg.senderRole}</span>`;
                    
                    let header = `<div class="msg-header"><span>FROM: ${msg.from || 'ME'} ${roleTag}</span> ${printedMark} <span onclick="hideStream(${msg.id})" style="cursor:pointer; color:var(--danger); font-weight:bold;">√ó</span></div>`;
                    
                    let body = document.createElement('div'); 
                    body.className = 'msg-body';
                    
                    msg.jobs.forEach((job, jIdx) => {
                        let jobWrap = document.createElement('div');
                        jobWrap.innerHTML = `
                            <input type="text" class="card-edit-inv" value="${job.inv||''}" onchange="updateStreamContent(${msg.id}, ${jIdx}, 'inv', this.value)">
                            <textarea class="card-edit-cap" onchange="updateStreamContent(${msg.id}, ${jIdx}, 'cap', this.value)">${job.cap||''}</textarea>
                        `;
                        job.files.forEach((f, fIdx) => {
                            let fWrap = document.createElement('div'); 
                            fWrap.className = 'thumb-row-wrap';
                            fWrap.innerHTML = `
                                <div class="thumb-box"><img src="${f.thumb}">${f.isPdf?'<div class="pdf-tag">PDF</div>':''}</div>
                                <button class="btn btn-mini btn-outline" style="color:var(--success); flex:1;" onclick="downloadAsset('${f.data}', '${job.inv||'file'}_${fIdx}')">üíæ SAVE</button>
                            `;
                            jobWrap.appendChild(fWrap);
                        });
                        body.appendChild(jobWrap);
                    });
                    
                    let footer = document.createElement('div'); 
                    footer.style.cssText = "padding:12px; display:flex; gap:10px; border-top:1px solid var(--border);";
                    
                    if(msg.direction==='in' && role==='operator') {
                        footer.innerHTML = `
                            <button class="btn btn-success btn-mini" style="flex:2;" onclick="openPrintSingle(${msg.id})">CETAK</button>
                            <button class="btn ${isSelected ? 'btn-primary' : 'btn-outline'} btn-mini" 
                                    style="flex:1; ${isSelected ? 'background:var(--accent); border-color:white;' : ''}" 
                                    onclick="toggleSelect(${msg.id})">
                                    ${isSelected ? '‚úÖ TERPILIH' : 'BATCH'}
                            </button>
                        `;
                    }
                    
                    card.innerHTML = header; 
                    card.appendChild(body); 
                    card.appendChild(footer);
                    area.appendChild(card);
                });
                area.scrollTop = area.scrollHeight;
            };
        }

        // --- FUNGSI PENDUKUNG ---

        function updateStreamContent(id, jIdx, key, val) {
            let tx = db.transaction("stream", "readwrite");
            tx.objectStore("stream").get(id).onsuccess = e => {
                let d = e.target.result;
                d.jobs[jIdx][key] = val;
                tx.objectStore("stream").put(d);
            };
        }

        function toggleSelect(id) {
            const idx = selectedInboxes.indexOf(id);
            if(idx > -1) selectedInboxes.splice(idx, 1);
            else selectedInboxes.push(id);
            document.getElementById('batch-count').innerText = `${selectedInboxes.length} ITEM DIPILIH`;
            renderStream();
        }

        function downloadAsset(data, name) {
            const a = document.createElement('a'); a.href = data; a.download = name; a.click();
        }

        function saveStream(o) { db.transaction("stream", "readwrite").objectStore("stream").put({ ...o, id: o.id || Date.now() }); }

        function addNewJob() { tempJobs.push({ files: [], inv: '', cap: '', selected: true }); renderJobs(); }
        function renderJobs() {
            const list = document.getElementById('job-list'); list.innerHTML = '';
            tempJobs.forEach((job, jIdx) => {
                let row = document.createElement('div'); row.className = 'glass-panel';
                row.style.padding = '15px'; row.style.marginBottom = '10px';
                let thumbs = job.files.map(f => `<div class="thumb-box"><img src="${f.thumb}">${f.isPdf?'<div class="pdf-tag">PDF</div>':''}</div>`).join('');
                row.innerHTML = `
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">${thumbs}<div class="thumb-box" style="cursor:pointer; border:1px dashed var(--accent); display:flex; align-items:center; justify-content:center;" onclick="activeJobIdx=${jIdx}; document.getElementById('job-file-in').click()">+</div></div>
                    <input type="text" class="cyber-input" placeholder="INV #" value="${job.inv}" oninput="tempJobs[${jIdx}].inv=this.value" style="margin-top:10px;">
                `;
                list.appendChild(row);
            });
        }

        async function handleFileSelect(input) {
            for(let f of input.files) {
                let isPdf = f.type === 'application/pdf';
                let data = await toBase64(f);
                let thumb = isPdf ? await getPdfPreview(data) : data;
                tempJobs[activeJobIdx].files.push({ data, thumb, isPdf, name: f.name });
            }
            renderJobs();
        }

        function mainAction() {
            if(!activeConns.length) return alert("Partner Offline!");
            let d = { type: 'job', jobs: tempJobs, id: Date.now(), senderRole: role, senderId: myId, status: 'pending' };
            activeConns.forEach(c => c.send(d));
            saveStream({...d, direction: 'out'});
            saveHistory({ inv: tempJobs[0].inv, partner: 'VARIOUS', type: 'OUTGOING' });
            tempJobs = []; addNewJob(); renderJobs(); renderStream();
        }

        function openPrintSingle(id) {
            db.transaction("stream").objectStore("stream").get(id).onsuccess = e => {
                let d = e.target.result;
                activeJob = { files: d.jobs[0].files, internalId: id, senderId: d.senderId, inv: d.jobs[0].inv };
                document.getElementById('p-img').src = activeJob.files[0].thumb;
                document.getElementById('p-inv-edit').value = activeJob.inv;
                document.getElementById('modal-print').style.display = 'flex';
            };
        }

        async function executeFullPrint() {
            let inv = document.getElementById('p-inv-edit').value;
            let target = document.getElementById('p-pdf-target').value;
            let html = `<style>@page { margin:0; } body { margin:0; text-align:center; } img { width:100%; height:auto; }</style>`;
            for(let i=0; i<target; i++) html += `<img src="${activeJob.files[0].data}"><p>${inv}</p><div style="page-break-after:always;"></div>`;
            
            let f = document.getElementById('p-frame');
            f.contentWindow.document.open(); f.contentWindow.document.write(html); f.contentWindow.document.close();
            setTimeout(() => {
                f.contentWindow.print();
                if(activeJob.internalId) {
                    let tx = db.transaction("stream", "readwrite");
                    tx.objectStore("stream").get(activeJob.internalId).onsuccess = e => {
                        let d = e.target.result; d.status = 'printed';
                        tx.objectStore("stream").put(d).onsuccess = () => renderStream();
                    };
                    let conn = activeConns.find(x => x.peer === activeJob.senderId);
                    if(conn) conn.send({ type: 'status_update', msgId: activeJob.internalId });
                }
                saveHistory({ inv, partner: 'LOKAL', type: 'PRODUCTION' });
                closeModal();
            }, 500);
        }

        // --- HISTORY LOG UTILS ---
        function saveHistory(h) { db.transaction("history", "readwrite").objectStore("history").add({ time: new Date().toLocaleString(), ...h }); }
        function toggleHistory() {
            let m = document.getElementById('modal-hist');
            m.style.display = (m.style.display==='flex') ? 'none' : 'flex';
            if(m.style.display==='flex') {
                document.getElementById('hist-role-title').innerText = role.toUpperCase();
                refreshHistBody();
            }
        }
        function refreshHistBody() {
            const b = document.getElementById('hist-body'); b.innerHTML = '';
            db.transaction("history").objectStore("history").getAll().onsuccess = e => {
                e.target.result.reverse().forEach(h => {
                    b.innerHTML += `<tr><td>${h.time}</td><td>${h.inv}</td><td>${h.type}</td><td>${h.partner}</td><td><button class="btn btn-danger btn-mini" onclick="deleteHist(${h.id})">√ó</button></td></tr>`;
                });
            };
        }
        function deleteHist(id) { db.transaction("history", "readwrite").objectStore("history").delete(id).onsuccess = refreshHistBody; }
        function clearAllHistory() { if(confirm("Hapus log?")) { db.transaction("history", "readwrite").objectStore("history").clear().onsuccess = refreshHistBody; } }

        function changeId() { 
            openKtsPrompt("Admin Access", "Kode Reset:", "password", (code) => {
                if(code === "4869") {
                    openKtsPrompt("Ganti ID", "ID Baru:", "text", (nid) => {
                        if(nid) { localStorage.setItem('kts_id', nid); location.reload(); }
                    });
                }
            });
        }

        function toBase64(f) { return new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }); }
        async function getPdfPreview(base64) {
            const pdfData = atob(base64.split(',')[1]);
            const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({scale: 0.5});
            const cvs = document.createElement('canvas'); cvs.height = viewport.height; cvs.width = viewport.width;
            await page.render({canvasContext: cvs.getContext('2d'), viewport: viewport}).promise;
            return cvs.toDataURL();
        }
        function openKtsPrompt(title, desc, type, callback) {
            document.getElementById('p-title').innerText = title;
            document.getElementById('p-desc').innerText = desc;
            const input = document.getElementById('p-val');
            input.type = type; input.value = "";
            document.getElementById('kts-prompt').style.display = 'flex';
            input.focus(); currentPromptTask = callback;
        }
        function confirmKts() {
            const val = document.getElementById('p-val').value;
            if(val && currentPromptTask) currentPromptTask(val);
            document.getElementById('kts-prompt').style.display = 'none';
        }
        function clearTimeline() { if(confirm("Hapus?")) { db.transaction("stream", "readwrite").objectStore("stream").clear().onsuccess = () => renderStream(); } }
        function hideStream(id) {
            db.transaction("stream", "readwrite").objectStore("stream").get(id).onsuccess = e => {
                let d = e.target.result; d.hidden = true;
                db.transaction("stream", "readwrite").objectStore("stream").put(d).onsuccess = () => renderStream();
            };
        }
        function closeModal() { document.getElementById('modal-print').style.display = 'none'; }
        function doLogout() { if(confirm("Logout?")) { localStorage.removeItem('kts_active_role'); location.reload(); } }
    </script>
</body>
</html>
