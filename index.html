<!-- 
  KERTASES PRO V11.4 - ULTIMATE MASTER PDF
  Fitur: Real PDF Preview in Setup, PDF Invoice Label, Operator Local Print,
         Centered Grid, Split History, Anti-Blank PDF Engine.
-->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertases Pro V11.4</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #050505; --bg-panel: #111111; --border: #333;
            --accent: #00f2ff; --accent-glow: rgba(0, 242, 255, 0.3);
            --secondary: #bd00ff; --text-main: #e0e0e0; --text-dim: #666;
            --success: #00ff9d; --danger: #ff0055; --warning: #ffcc00;
        }

        * { box-sizing: border-box; outline: none; }
        body, html {
            margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-deep); color: var(--text-main);
            height: 100vh; overflow: hidden;
            background-image: linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .cyber-input { background: #000; border: 1px solid var(--border); color: var(--accent); padding: 10px; width: 100%; font-family: 'Roboto Mono', monospace; font-size: 0.9rem; }
        textarea.cyber-input { height: 80px; resize: none; }
        .cyber-btn { background: linear-gradient(45deg, var(--bg-panel), #222); border: 1px solid var(--accent); color: var(--accent); padding: 10px 20px; cursor: pointer; font-weight: 700; text-transform: uppercase; transition: 0.3s; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .cyber-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent-glow); }
        .cyber-btn.danger { border-color: var(--danger); color: var(--danger); }
        .cyber-btn.success { border-color: var(--success); color: var(--success); }

        #login-screen { position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
        .role-grid { display: flex; gap: 20px; margin-top: 30px; }
        .role-card { width: 150px; padding: 20px; text-align: center; border: 1px solid var(--border); cursor: pointer; background: rgba(0,0,0,0.5); }
        .role-card:hover { border-color: var(--accent); transform: translateY(-5px); }

        #app-layout { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 280px; background: #080808; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .role-badge { background: var(--accent); color: #000; padding: 8px; font-weight: bold; text-align: center; margin-bottom: 20px; letter-spacing: 2px; }

        .status-widget { border: 1px solid var(--border); padding: 15px; margin-bottom: 20px; border-left: 4px solid var(--danger); }
        .status-widget.online { border-left-color: var(--success); }

        .main-view { flex: 1; display: grid; grid-template-columns: 1fr 340px; overflow: hidden; height: 100%; }
        .timeline { display: flex; flex-direction: column; background: rgba(0,0,0,0.4); border-right: 1px solid var(--border); overflow: hidden; }
        .stream-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 25px; scroll-behavior: smooth; }
        
        .msg-card { width: 100%; max-width: 420px; background: #111; border: 1px solid var(--border); }
        .msg-card.out { align-self: flex-end; border-color: var(--secondary); }
        .msg-card.in { align-self: flex-start; border-color: var(--accent); }
        
        .msg-header { padding: 8px 12px; background: rgba(255,255,255,0.05); font-size: 0.65rem; display: flex; justify-content: space-between; }
        .msg-body { padding: 12px; }
        .msg-img { width: 100%; height: 180px; object-fit: contain; background: #000; border: 1px solid #222; }
        .msg-pdf-placeholder { width: 100%; height: 180px; border: 1px solid var(--danger); background: #222; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-direction: column; gap: 10px; cursor: pointer; text-align: center; }
        .msg-inv { color: var(--accent); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .msg-cap { font-size: 0.85rem; color: #aaa; background: #000; padding: 10px; border: 1px solid #222; cursor: pointer; white-space: pre-wrap; line-height: 1.4; }
        .msg-footer { padding: 10px; display: flex; gap: 10px; border-top: 1px solid #222; }

        .control-panel { padding: 20px; overflow-y: auto; background: #0c0c0c; border-left: 1px solid var(--border); }
        .upload-zone { border: 2px dashed #444; padding: 25px; text-align: center; color: #666; cursor: pointer; margin-bottom: 15px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 550px; background: #111; border: 1px solid var(--accent); padding: 25px; max-height: 95vh; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; color: var(--text-dim); }
        th { border-bottom: 1px solid var(--accent); color: var(--accent); padding: 10px; text-align: left; background: rgba(0,0,0,0.3); }
        td { padding: 10px; border-bottom: 1px solid #222; }

        .hist-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .hist-tab-btn { flex: 1; padding: 8px; background: #222; color: #666; cursor: pointer; border: none; font-weight: bold; font-family: inherit; }
        .hist-tab-btn.active { background: var(--accent); color: #000; }

        .preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
        .preview-item { width: 100%; border: 1px solid #333; height: 80px; background: #000; overflow: hidden; }
        .preview-item img, .preview-item iframe { width: 100%; height: 100%; object-fit: contain; border: none; }

        .back-nav-btn { font-size: 1.5rem; cursor: pointer; color: var(--accent); position: absolute; top: 15px; left: 15px; z-index: 10; background: none; border: none; }
        
        /* SETUP MODAL PREVIEW PDF */
        #p-setup-pdf-preview { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="conn-sound" src="https://assets.mixkit.co/active_storage/sfx/1084/1084-preview.mp3"></audio>

    <div id="login-screen">
        <h1 style="font-size:3rem; color:var(--accent); text-shadow:0 0 20px var(--accent-glow); margin:0;">KERTASES <span style="color:#fff">PRO</span></h1>
        <div style="color:var(--text-dim); letter-spacing:5px; margin-bottom:40px;">V11.4 PRODUCTION MASTER PDF</div>
        <div class="role-grid">
            <div class="role-card" onclick="enterRole('admin')">üï∂Ô∏è<br>ADMIN</div>
            <div class="role-card" onclick="enterRole('designer')">üé®<br>DESIGNER</div>
            <div class="role-card" onclick="enterRole('operator')">üñ®Ô∏è<br>OPERATOR</div>
        </div>
        <div style="margin-top:30px; display:flex; gap:10px;">
            <button id="btn-cloud" class="cyber-btn" onclick="setMode('cloud')">CLOUD</button>
            <button id="btn-local" class="cyber-btn" onclick="setMode('local')" style="border-color:var(--text-dim); color:var(--text-dim);">LAN</button>
        </div>
        <input type="text" id="server-ip" class="cyber-input" placeholder="IP Server Lokal" style="display:none; width:220px; margin-top:15px; text-align:center;">
    </div>

    <div id="app-layout">
        <div class="sidebar">
            <button class="back-nav-btn" onclick="location.reload()" title="Logout / Kembali">üîô</button>
            <div id="active-role-display" class="role-badge" style="margin-top:40px;">---</div>
            <div id="status-widget" class="status-widget">
                <div id="status-text" style="font-weight:bold;">OFFLINE</div>
                <div style="font-size:0.7rem; color:var(--text-dim); margin-top:10px; cursor:pointer;" onclick="changeId()">YOUR_ID:</div>
                <div id="my-id-display" style="font-family:'Roboto Mono'; color:var(--accent); font-size:0.85rem;">...</div>
            </div>
            <input type="text" id="target-id" class="cyber-input" placeholder="Target ID">
            <button class="cyber-btn" style="width:100%; margin-top:10px;" onclick="connectMulti()">LINK CONNECT</button>
            <div id="active-conns" style="font-size:0.6rem; color:var(--success); margin-top:10px; word-break:break-all;"></div>
            <div style="margin-top:auto;">
                <button class="cyber-btn" style="width:100%; border-color:var(--secondary); color:var(--secondary);" onclick="toggleHistory()">PRODUCTION LOG</button>
            </div>
        </div>

        <div class="main-view">
            <div class="timeline">
                <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:#000;">
                    <span style="font-weight:bold; color:var(--accent);">TIMELINE FLOW</span>
                    <span id="role-hint" style="font-size:0.7rem; color:var(--text-dim);">---</span>
                </div>
                <div id="stream-area" class="stream-area"></div>
            </div>

            <div class="control-panel">
                <div style="color:var(--accent); font-weight:bold; margin-bottom:15px; font-size:0.8rem;">TRANSMIT ASSETS</div>
                <div class="upload-zone" onclick="document.getElementById('file-in').click()">+ SELECT FILES / PDF</div>
                <div id="preview-area" class="preview-grid"></div>
                <input type="text" id="inv-in" class="cyber-input" placeholder="No. Invoice" style="margin-bottom:10px;">
                <textarea id="cap-in" class="cyber-input" placeholder="Catatan"></textarea>
                <div style="margin:15px 0; font-size:0.75rem;"><input type="checkbox" id="hd-mode" checked> HD ASSETS</div>
                <input type="file" id="file-in" multiple style="display:none;" onchange="prepareFiles(this)">
                
                <button id="btn-action-main" class="cyber-btn" style="width:100%;" onclick="mainAction()">SEND DATA</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRINT -->
    <div id="modal-print" class="modal">
        <div class="modal-box">
            <div style="color:var(--accent); font-weight:bold; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">PRODUCTION SETUP</div>
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <div id="p-preview-box" style="width:150px; height:150px; background:#000; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                    <img id="p-img" style="max-width:100%; max-height:100%; object-fit:contain;">
                    <iframe id="p-setup-pdf-preview" style="display:none;"></iframe>
                </div>
                <div style="flex:1;">
                    <label style="font-size:0.7rem;">INV (EDITABLE):</label>
                    <input type="text" id="p-inv" class="cyber-input" style="margin-bottom:10px; color:var(--success);">
                    <label style="font-size:0.7rem;">JENIS BAHAN:</label>
                    <select id="p-mat" class="cyber-input">
                        <option>Chromo</option><option>Vinyl Glossy</option><option>Vinyl Matte</option><option>Transparan</option><option>HVS</option><option>Art Carton</option>
                    </select>
                </div>
            </div>

            <!-- PDF OPTIONS (V11.4 - NOW WITH PREVIEW) -->
            <div id="pdf-custom-options" style="display:none; border:1px solid var(--danger); padding:15px; margin-bottom:20px; background: rgba(255,0,0,0.05);">
                <div style="color:var(--danger); font-weight:bold; font-size:0.75rem; margin-bottom:10px;">SETTING PDF FULL (NO GRID)</div>
                <label style="font-size:0.7rem;">UKURAN KERTAS PDF:</label>
                <select id="p-pdf-paper" class="cyber-input" onchange="togglePdfPaperCustom()" style="margin-bottom:10px;">
                    <option value="32,48">A3+ (32x48 cm)</option>
                    <option value="29.7,42">A3 (29.7x42 cm)</option>
                    <option value="21,29.7">A4 (21x29.7 cm)</option>
                    <option value="custom">-- CUSTOM --</option>
                </select>
                <div id="pdf-custom-paper-box" style="display:none; gap:10px; margin-bottom:10px;">
                    <input type="number" id="p-pdf-pw" value="32" class="cyber-input" placeholder="W (CM)">
                    <input type="number" id="p-pdf-ph" value="48" class="cyber-input" placeholder="H (CM)">
                </div>
                <label style="font-size:0.7rem;">JUMLAH CETAK (LEMBAR):</label>
                <input type="number" id="p-pdf-target" value="1" class="cyber-input" style="font-size:1.5rem; text-align:center; color:var(--success); font-weight:bold; margin-bottom:15px;">
                <div style="display:flex; gap:10px;">
                    <button class="cyber-btn danger" style="flex:1;" onclick="closeModal()">BACK / BATAL</button>
                    <button class="cyber-btn success" style="flex:2;" onclick="doPrintDirect()">CETAK PDF FULL</button>
                </div>
            </div>

            <!-- GRID CONTROLS (JPG/PNG ONLY) -->
            <div id="grid-controls">
                <label style="font-size:0.7rem;">UKURAN KERTAS GRID:</label>
                <select id="p-paper" class="cyber-input" onchange="togglePaperCustom()" style="margin-bottom:15px;">
                    <option value="32,48">A3+ (32x48 cm)</option><option value="29.7,42">A3 (29.7x42 cm)</option><option value="21,29.7">A4 (21x29.7 cm)</option><option value="custom">-- CUSTOM --</option>
                </select>
                <div id="custom-paper-box" style="display:none; gap:10px; margin-bottom:15px;">
                    <input type="number" id="p-paper-w" value="32" class="cyber-input">
                    <input type="number" id="p-paper-h" value="48" class="cyber-input">
                </div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <div style="flex:1;"><label style="font-size:0.7rem;">L (CM):</label><input type="number" id="p-w" value="5" step="0.1" class="cyber-input" oninput="calc()"></div>
                    <div style="flex:1;"><label style="font-size:0.7rem;">T (CM):</label><input type="number" id="p-h" value="5" step="0.1" class="cyber-input" oninput="calc()"></div>
                    <div style="display:flex; align-items:flex-end;"><button class="cyber-btn" onclick="physicalRotate()">üîÑ</button></div>
                </div>
                <label style="font-size:0.7rem;">TARGET LEMBAR:</label>
                <input type="number" id="p-target" value="1" class="cyber-input" style="font-size:1.8rem; text-align:center; color:var(--success); font-weight:bold; margin-bottom:15px;" oninput="calc()">
                <div id="p-res" style="text-align:center; color:var(--success); background:rgba(0,255,157,0.1); padding:12px; border:1px solid var(--success); margin-bottom:20px;">...</div>
                <div style="display:flex; gap:10px;">
                    <button class="cyber-btn danger" style="flex:1;" onclick="closeModal()">BACK / BATAL</button>
                    <button class="cyber-btn success" style="flex:2;" onclick="doPrint()">PROSES GRID</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORY -->
    <div id="modal-hist" class="modal">
        <div class="modal-box" style="width:800px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div style="color:var(--accent); font-weight:bold; font-size:1.2rem;">LOG - <span id="hist-role-title">---</span></div>
                <button class="cyber-btn success" style="padding:5px 15px; font-size:0.7rem;" onclick="exportHistory()">DOWNLOAD CSV</button>
            </div>
            <div id="op-tabs" class="hist-tabs" style="display:none;">
                <div class="hist-tab-btn active" id="tab-recv" onclick="switchHistTab('RECV')">DITERIMA</div>
                <div class="hist-tab-btn" id="tab-prod" onclick="switchHistTab('PROD')">LOG PRODUKSI</div>
            </div>
            <div style="max-height:400px; overflow-y:auto; background:#000; border:1px solid #222;">
                <table><thead><tr><th>WAKTU</th><th>INV</th><th>KET / STATUS</th><th>PARTNER</th></tr></thead><tbody id="hist-body"></tbody></table>
            </div>
            <button class="cyber-btn" style="width:100%; margin-top:20px;" onclick="toggleHistory()">BACK / KEMBALI</button>
        </div>
    </div>

    <iframe id="p-frame" style="display:none;"></iframe>

    <script>
        const ROLES_KEYS = { admin: "calik", designer: "melengkung", operator: "nangtung" };
        let cfg = { mode: 'cloud', host: 'localhost' };
        let myId = localStorage.getItem('kts_id') || 'CYBER-' + Math.floor(Math.random()*9999);
        let role, peer, db, tempFiles = [], activeConns = [], currentTab = 'RECV', activeBlobURL = null;

        let req = indexedDB.open("KertasesV114", 1);
        req.onupgradeneeded = e => {
            let d = e.target.result;
            d.createObjectStore("stream", { keyPath: "id" });
            d.createObjectStore("history", { keyPath: "id", autoIncrement:true });
        };
        req.onsuccess = e => db = e.target.result;

        function setMode(m) {
            cfg.mode = m;
            document.getElementById('btn-cloud').style.borderColor = m==='cloud'?'var(--accent)':'var(--border)';
            document.getElementById('btn-local').style.borderColor = m==='local'?'var(--accent)':'var(--border)';
            document.getElementById('server-ip').style.display = m==='local'?'block':'none';
        }

        function changeId() {
            if(prompt("PASSWORD:") === "4869") {
                let nid = prompt("ID BARU:", myId);
                if(nid) { localStorage.setItem('kts_id', nid); location.reload(); }
            }
        }

        function enterRole(r) {
            if(prompt(`KODE AKSES ${r.toUpperCase()}:`) === ROLES_KEYS[r]) {
                role = r;
                if(cfg.mode === 'local') cfg.host = document.getElementById('server-ip').value || 'localhost';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-layout').style.display = 'flex';
                document.getElementById('active-role-display').innerText = role.toUpperCase();
                document.getElementById('my-id-display').innerText = myId;
                document.getElementById('target-id').value = localStorage.getItem('kts_last_target') || '';
                if(role === 'operator') {
                    document.getElementById('btn-action-main').innerText = "PROSES CETAK";
                    document.getElementById('role-hint').innerText = "Recv Designer | Upload Local -> Print";
                }
                initPeer();
                setTimeout(renderStream, 500);
            } else alert("DENIED");
        }

        function initPeer() {
            peer = (cfg.mode === 'local') ? new Peer(myId, { host: cfg.host, port: 9000, path: '/kertases-app', config: {'iceServers': []} }) : new Peer(myId);
            peer.on('open', () => updateStatus('ready'));
            peer.on('connection', c => setupConn(c));
            peer.on('error', e => { updateStatus('offline'); });
        }

        function connectMulti() {
            let ids = document.getElementById('target-id').value.split(',').map(s => s.trim());
            localStorage.setItem('kts_last_target', ids.join(','));
            ids.forEach(id => { if(id && id !== myId) setupConn(peer.connect(id, { reliable: true })); });
        }

        function setupConn(c) {
            c.on('open', () => {
                if(!activeConns.find(x => x.peer === c.peer)) {
                    activeConns.push(c);
                    document.getElementById('conn-sound').play();
                    updateStatus('online'); updateConnUI();
                }
            });
            c.on('data', d => {
                document.getElementById('notif-sound').play().catch(()=>{});
                if(d.type === 'job') handleIncoming(d, c.peer);
                if(d.type === 'done') alert(`DONE: ${d.inv} dicetak!`);
            });
            c.on('close', () => {
                activeConns = activeConns.filter(x => x.peer !== c.peer);
                updateConnUI();
                if(activeConns.length === 0) updateStatus('ready');
            });
        }

        function updateConnUI() { document.getElementById('active-conns').innerText = "LINKED: " + activeConns.map(x => x.peer).join(', '); }

        function updateStatus(s) {
            const txt = document.getElementById('status-text');
            const widget = document.getElementById('status-widget');
            widget.className = 'status-widget ' + (activeConns.length > 0 ? 'online' : s);
            txt.innerText = activeConns.length > 0 ? `CONNECTED (${activeConns.length})` : s.toUpperCase();
            txt.style.color = activeConns.length > 0 ? "var(--success)" : "var(--danger)";
        }

        function b64ToBlob(b64, type) {
            const byteCharacters = atob(b64.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
            return new Blob([new Uint8Array(byteNumbers)], {type: type});
        }

        async function prepareFiles(input) {
            tempFiles = [];
            const grid = document.getElementById('preview-area'); grid.innerHTML = '';
            for(let f of input.files) {
                let isPdf = f.type === 'application/pdf';
                let data = await toBase64(f);
                tempFiles.push({ data, isPdf, name: f.name });
                let item = document.createElement('div');
                item.className = 'preview-item';
                if(isPdf) item.innerHTML = `<div style="height:100%; display:flex; align-items:center; justify-content:center; background:#400; color:white; font-size:0.6rem; font-weight:bold;">PDF READY</div>`;
                else item.innerHTML = `<img src="${data}">`;
                grid.appendChild(item);
            }
        }

        function mainAction() {
            if(role === 'operator') {
                if(tempFiles.length === 0) return alert("PILIH FILE!");
                activeJob = { files: tempFiles, inv: document.getElementById('inv-in').value };
                openPrintLogic(activeJob);
            } else {
                sendDataStrict();
            }
        }

        function sendDataStrict() {
            if(activeConns.length === 0) return alert("NO TARGET!");
            let d = { type: 'job', files: tempFiles, inv: document.getElementById('inv-in').value || '', cap: document.getElementById('cap-in').value, id: Date.now(), senderRole: role, senderId: myId };
            activeConns.forEach(c => c.send(d));
            saveHistory({ ...d, typeLabel: role === 'admin' ? 'ADM_SEND' : 'DSN_SEND' });
            saveStream({ ...d, direction: 'out', hidden: false });
            tempFiles = []; document.getElementById('preview-area').innerHTML = '';
            document.getElementById('inv-in').value = ''; document.getElementById('cap-in').value = '';
            renderStream();
        }

        function handleIncoming(d, from) {
            let label = "";
            if(role === 'designer' && d.senderRole === 'admin') label = "DSN_RECV";
            if(role === 'operator' && d.senderRole === 'designer') label = "OP_RECV";
            if(!label) return;
            saveStream({ ...d, direction: 'in', from: from, hidden: false });
            saveHistory({ ...d, fromId: from, typeLabel: label });
            renderStream();
        }

        function saveStream(obj) { db.transaction("stream", "readwrite").objectStore("stream").put(obj); }
        function saveHistory(obj) { db.transaction("history", "readwrite").objectStore("history").add({ time: new Date().toLocaleString(), inv: obj.inv, typeLabel: obj.typeLabel, partner: obj.fromId || obj.senderId || 'LOCAL', cap: obj.cap || '-', role: role }); }

        function renderStream() {
            const area = document.getElementById('stream-area'); area.innerHTML = '';
            db.transaction("stream").objectStore("stream").getAll().onsuccess = e => {
                e.target.result.forEach(i => {
                    if(i.hidden) return;
                    if(role === 'admin' && i.direction === 'in') return;
                    if(role === 'operator' && i.direction === 'out') return;
                    let thumb = i.files[0].isPdf ? `<div class="msg-pdf-placeholder">üìÑ PDF DOKUMEN</div>` : `<img src="${i.files[0].data}" class="msg-img">`;
                    let actionBtn = "";
                    if(i.direction === 'in') {
                        if(role === 'operator') actionBtn = `<button class="cyber-btn success" style="width:100%;" onclick="openPrint('${i.id}')">PROSES DATA</button>`;
                        if(role === 'designer') actionBtn = `<button class="cyber-btn" style="width:100%;border-color:var(--secondary);color:var(--secondary);" onclick="downloadFiles('${i.id}')">SAVE ASSET</button>`;
                    }
                    let card = document.createElement('div');
                    card.className = `msg-card ${i.direction}`;
                    card.innerHTML = `<div class="msg-header"><span>${i.direction === 'in' ? 'FROM: '+i.from : 'OUTBOX'}</span><span onclick="hideStream('${i.id}')" style="color:var(--danger); cursor:pointer;">[ HAPUS ]</span></div><div class="msg-body">${thumb}<div class="msg-inv">${i.inv || '(No Invoice)'}</div><div class="msg-cap" onclick="copyTxt(this.innerText)">${i.cap || '---'}</div></div><div class="msg-footer">${actionBtn}</div>`;
                    area.appendChild(card);
                });
                area.scrollTop = area.scrollHeight;
            };
        }

        function hideStream(id) { db.transaction("stream", "readwrite").objectStore("stream").get(parseInt(id) || id).onsuccess = e => { let d = e.target.result; d.hidden=true; db.transaction("stream","readwrite").objectStore("stream").put(d); renderStream(); }; }
        function openPrint(id) { db.transaction("stream").objectStore("stream").get(parseInt(id) || id).onsuccess = e => { openPrintLogic(e.target.result); }; }

        // --- THE LOGIC FOR PDF PREVIEW IN SETUP MODAL ---
        function openPrintLogic(job) {
            activeJob = job;
            document.getElementById('modal-print').style.display = 'flex';
            document.getElementById('p-inv').value = ""; 

            if(activeBlobURL) URL.revokeObjectURL(activeBlobURL);

            if(activeJob.files[0].isPdf) {
                // PDF MODE
                const blob = b64ToBlob(activeJob.files[0].data, 'application/pdf');
                activeBlobURL = URL.createObjectURL(blob);
                
                document.getElementById('p-img').style.display = 'none';
                document.getElementById('p-setup-pdf-preview').style.display = 'block';
                document.getElementById('p-setup-pdf-preview').src = activeBlobURL;
                document.getElementById('pdf-custom-options').style.display = 'block';
                document.getElementById('grid-controls').style.display = 'none';
            } else {
                // IMAGE MODE
                document.getElementById('p-img').src = activeJob.files[0].data;
                document.getElementById('p-img').style.display = 'block';
                document.getElementById('p-setup-pdf-preview').style.display = 'none';
                document.getElementById('pdf-custom-options').style.display = 'none';
                document.getElementById('grid-controls').style.display = 'block';
            }
            calc();
        }

        function closeModal() {
            document.getElementById('modal-print').style.display = 'none';
            if(activeBlobURL) {
                URL.revokeObjectURL(activeBlobURL);
                activeBlobURL = null;
            }
        }

        async function physicalRotate() {
            if(!activeJob || activeJob.files[0].isPdf) return;
            let img = new Image(); img.src = activeJob.files[0].data; await img.decode();
            let canvas = document.createElement('canvas'); canvas.width = img.height; canvas.height = img.width;
            let ctx = canvas.getContext('2d'); ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(90 * Math.PI / 180);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            activeJob.files[0].data = canvas.toDataURL('image/png');
            document.getElementById('p-img').src = activeJob.files[0].data;
            let wI = document.getElementById('p-w'), hI = document.getElementById('p-h');
            let oldW = wI.value; wI.value = hI.value; hI.value = oldW;
            calc();
        }

        function togglePdfPaperCustom() { document.getElementById('pdf-custom-paper-box').style.display = document.getElementById('p-pdf-paper').value==='custom'?'flex':'none'; }
        function togglePaperCustom() { document.getElementById('custom-paper-box').style.display = document.getElementById('p-paper').value==='custom'?'flex':'none'; calc(); }

        function calc() {
            let pw = document.getElementById('p-paper').value === 'custom' ? parseFloat(document.getElementById('p-paper-w').value) : parseFloat(document.getElementById('p-paper').value.split(',')[0]);
            let ph = document.getElementById('p-paper').value === 'custom' ? parseFloat(document.getElementById('p-paper-h').value) : parseFloat(document.getElementById('p-paper').value.split(',')[1]);
            let w = parseFloat(document.getElementById('p-w').value) || 1, h = parseFloat(document.getElementById('p-h').value) || 1;
            let t = parseInt(document.getElementById('p-target').value) || 1;
            let nx = Math.floor(pw/w), ny = Math.floor(ph/h);
            document.getElementById('p-res').innerText = `TOTAL: ${nx * ny * t} PCS (${nx * ny} pcs/lbr)`;
        }

        function doPrintDirect() {
            const invLabel = document.getElementById('p-inv').value;
            const mat = document.getElementById('p-mat').value;
            const target = document.getElementById('p-pdf-target').value;
            let pw = document.getElementById('p-pdf-paper').value === 'custom' ? document.getElementById('p-pdf-pw').value : document.getElementById('p-pdf-paper').value.split(',')[0];
            let ph = document.getElementById('p-pdf-paper').value === 'custom' ? document.getElementById('p-pdf-ph').value : document.getElementById('p-pdf-paper').value.split(',')[1];
            
            let f = document.getElementById('p-frame');
            let fWin = f.contentWindow;
            fWin.document.open();
            let styles = `<style>@page{size:${pw}cm ${ph}cm; margin:0;} body{margin:0; padding:0;} .wrap{width:${pw}cm; height:${ph}cm; position:relative; overflow:hidden; page-break-after:always;} iframe{width:100%; height:100%; border:none;} .label{position:absolute; bottom:1cm; left:50%; transform:translateX(-50%); font-family:sans-serif; font-size:10pt; font-weight:bold; background:white; border:1px solid #000; padding:3px 15px; z-index:999;}</style>`;
            let content = "";
            for(let i=0; i<target; i++) {
                content += `<div class="wrap"><iframe src="${activeBlobURL}"></iframe>${invLabel ? `<div class="label">${invLabel} - ${mat}</div>` : ''}</div>`;
            }
            fWin.document.write(styles + content);
            fWin.document.close();

            setTimeout(() => { 
                fWin.print(); 
                saveHistory({ inv: invLabel || 'PDF', cap: `PDF PRINT ${target} LBR`, typeLabel: 'OP_PROD' });
                closeModal();
            }, 2000);
        }

        function doPrint() {
            let pw = document.getElementById('p-paper').value === 'custom' ? document.getElementById('p-paper-w').value : document.getElementById('p-paper').value.split(',')[0];
            let ph = document.getElementById('p-paper').value === 'custom' ? document.getElementById('p-paper-h').value : document.getElementById('p-paper').value.split(',')[1];
            let w = document.getElementById('p-w').value, h = document.getElementById('p-h').value, target = document.getElementById('p-target').value;
            let invLabel = document.getElementById('p-inv').value, material = document.getElementById('p-mat').value;
            const mk = (t, l) => `<div style="position:absolute; top:${t}; left:${l}; width:0; height:0;"><div style="position:absolute; top:-2mm; left:-0.05mm; width:0.1mm; height:4mm; background:#000;"></div><div style="position:absolute; top:-0.05mm; left:-2mm; width:4mm; height:0.1mm; background:#000;"></div></div>`;
            let nx = Math.floor(pw/w), ny = Math.floor(ph/h);
            let html = `<style>@page{size:${pw}cm ${ph}cm; margin:0;} body{margin:0; padding:0; height:${ph}cm; width:${pw}cm; display:flex; align-items:center; justify-content:center; position:relative;} .grid{display:grid; grid-template-columns:repeat(${nx}, ${w}cm); gap:0; margin:0;} .cell{position:relative; width:${w}cm; height:${h}cm; overflow:hidden;} .cell img{width:100%; height:100%; object-fit:fill; display:block;} .inv-text{position:absolute; bottom:1cm; left:50%; transform:translateX(-50%); font-family:sans-serif; font-size:10pt; color:#000; z-index:99; font-weight:bold; background:white; padding:2px 10px; border:1px solid #000;}</style>`;
            let gridHtml = `<div class="grid">`;
            for(let i=0; i<(nx*ny); i++) gridHtml += `<div class="cell"><img src="${activeJob.files[0].data}">${mk(0,0)}${mk(0,'100%')}${mk('100%',0)}${mk('100%','100%')}</div>`;
            gridHtml += `</div>`;
            if(invLabel) gridHtml += `<div class="inv-text">${invLabel} - ${material}</div>`;
            let finalOutput = "";
            for(let i=0; i<target; i++) finalOutput += `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; page-break-after:always; position:relative;">${gridHtml}</div>`;
            let f = document.getElementById('p-frame').contentWindow;
            f.document.open(); f.document.write(html + finalOutput); f.document.close();
            setTimeout(() => { f.print(); saveHistory({ inv: invLabel || 'GRID', cap: `PROD ${nx*ny*target} PCS`, typeLabel: 'OP_PROD' }); closeModal(); }, 1000);
        }

        function switchHistTab(tab) { currentTab = tab; document.querySelectorAll('.hist-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tab === 'RECV' ? 'tab-recv' : 'tab-prod').classList.add('active'); refreshHistBody(); }
        function toggleHistory() { let m = document.getElementById('modal-hist'); m.style.display = m.style.display==='flex'?'none':'flex'; if(m.style.display==='flex') { document.getElementById('hist-role-title').innerText = role.toUpperCase(); document.getElementById('op-tabs').style.display = role === 'operator' ? 'flex' : 'none'; refreshHistBody(); } }
        function refreshHistBody() { const b = document.getElementById('hist-body'); b.innerHTML = ''; db.transaction("history").objectStore("history").getAll().onsuccess = e => { e.target.result.reverse().forEach(h => { let show = false; if(role==='admin' && h.typeLabel==='ADM_SEND') show = true; if(role==='designer' && (h.typeLabel==='DSN_RECV' || h.typeLabel==='DSN_SEND')) show = true; if(role==='operator') { if(currentTab === 'RECV' && h.typeLabel==='OP_RECV') show = true; if(currentTab === 'PROD' && h.typeLabel==='OP_PROD') show = true; } if(show) b.innerHTML += `<tr><td>${h.time}</td><td>${h.inv}</td><td>${h.cap}</td><td>${h.partner}</td></tr>`; }); }; }
        function exportHistory() { let csv = "WAKTU,INV,KET,PARTNER\n"; db.transaction("history").objectStore("history").getAll().onsuccess = e => { e.target.result.forEach(h => { csv += `"${h.time}","${h.inv}","${h.cap.replace(/\n/g, ' ')}","${h.partner}"\n`; }); const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Log_${role}.csv`; a.click(); }; }
        function downloadFiles(id) { db.transaction("stream").objectStore("stream").get(parseInt(id) || id).onsuccess = e => { e.target.result.files.forEach(f => { const l = document.createElement('a'); l.href = f.data; l.download = "KTS_"+f.name; l.click(); }); }; }
        function copyTxt(t) { navigator.clipboard.writeText(t); alert("Copy Sukses!"); }
        function toBase64(f) { return new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }); }
    </script>
</body>
</html>
