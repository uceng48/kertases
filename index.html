<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertases Flow ¬∑ Web Edition</title>

    <!-- Library CDN -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@300;400;500;600&family=Roboto+Mono&display=swap" rel="stylesheet">

    <style>
        /* ========== GLOBAL STYLE (SAMA SEPERTI SEBELUMNYA, DIOPTIMASI) ========== */
        :root {
            --bg: #0a0f1d;
            --panel: rgba(21, 32, 54, 0.9);
            --border: rgba(255,255,255,0.1);
            --accent: #6366f1;
            --accent-glow: rgba(99,102,241,0.3);
            --success: #10b981;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --text: #f8fafc;
            --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; }
        body, html {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(circle at 10% 10%, rgba(99,102,241,0.1) 0%, transparent 40%);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .glass-panel {
            background: var(--panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px !important;
        }

        .cyber-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 12px !important;
            color: #fff;
            padding: 12px 14px;
            font-size: 0.85rem;
            width: 100%;
            transition: 0.2s;
        }
        .cyber-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .btn {
            border-radius: 12px !important;
            border: none;
            padding: 10px 18px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--border); }
        .btn-mini { padding: 6px 12px; font-size: 0.7rem; border-radius: 8px !important; }

        .filter-bar .btn.active {
            background: var(--accent) !important;
            color: white !important;
            border-color: var(--accent) !important;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* Login */
        #login-screen {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg);
        }
        .login-box {
            padding: 50px; text-align: center; max-width: 480px; width: 90%;
            border-radius: 30px !important; animation: fadeIn 0.5s;
        }
        .role-grid {
            display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin-top: 30px;
        }
        .role-card {
            padding: 25px 10px; border: 1px solid var(--border); border-radius: 20px;
            cursor: pointer; background: rgba(255,255,255,0.02); transition: 0.3s;
        }
        .role-card:hover {
            border-color: var(--accent); background: rgba(99,102,241,0.1);
            transform: translateY(-5px);
        }

        /* Layout */
        #app-layout {
            display: none; height: 100vh; flex-direction: row; padding: 15px; gap: 15px;
        }
        .sidebar {
            width: 280px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0;
        }
        .main-view {
            flex: 1; display: grid; grid-template-columns: 1fr 350px; gap: 15px;
            height: 100%; overflow: hidden;
        }

        /* Timeline */
        .timeline {
            display: flex; flex-direction: column; overflow: hidden;
        }
        .timeline-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .filter-bar {
            display: flex; gap: 5px; padding: 10px 20px;
            border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .stream-area {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .batch-bar {
            display: none; justify-content: space-between; align-items: center;
            padding: 10px 20px; margin: 15px 15px 0;
            background: rgba(16,185,129,0.15); border: 1px solid var(--success);
            border-radius: 16px; gap: 15px; min-height: 50px;
        }

        /* Message Card */
        .msg-card {
            width: 100%; max-width: 450px; border-radius: 20px !important;
            border: 1px solid var(--border); background: rgba(255,255,255,0.03);
            position: relative; padding: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .msg-card.selected { border: 2px solid var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .msg-header {
            padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.75rem; color: var(--text-dim);
            display: flex; justify-content: space-between; align-items: center;
        }
        .msg-body { padding: 15px; }
        .msg-card.printed { border-color: var(--success); background: rgba(16,185,129,0.05); }
        .msg-card.in { align-self: flex-start; border-left: 4px solid var(--accent); }
        .msg-card.out { align-self: flex-end; border-right: 4px solid var(--accent); }

        .printed-badge {
            background: var(--success); color: #000; font-size: 0.6rem;
            font-weight: 800; padding: 2px 8px; border-radius: 10px;
        }
        .role-tag {
            font-size: 0.6rem; padding: 2px 6px; border-radius: 6px;
            background: var(--border); margin-left: 5px; text-transform: uppercase;
        }

        .card-edit-inv {
            background: transparent; border: none; border-bottom: 1px dashed var(--border);
            color: var(--accent); font-weight: 700; font-size: 1.1rem;
            width: 100%; margin-bottom: 5px;
        }
        .card-edit-cap {
            background: rgba(0,0,0,0.2); border: 1px solid transparent;
            color: var(--text-dim); font-size: 0.85rem; width: 100%;
            padding: 10px; border-radius: 12px !important; resize: none; min-height: 50px;
        }

        .thumb-row-wrap {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: rgba(255,255,255,0.03); border-radius: 12px !important; margin-top: 8px;
        }
        .thumb-box {
            width: 60px; height: 60px; background: #000; border-radius: 10px !important;
            overflow: hidden; border: 1px solid var(--border); position: relative; flex-shrink: 0;
        }
        .thumb-box img { width: 100%; height: 100%; object-fit: contain; }
        .pdf-tag {
            position: absolute; bottom: 2px; right: 2px;
            background: #f43f5e; color: white; font-size: 8px; padding: 1px 3px; border-radius: 3px;
        }

        /* Control Panel */
        .control-panel { overflow-y: auto; padding: 20px; }
        .job-row {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 16px !important; padding: 15px; position: relative; margin-bottom: 10px;
        }
        .job-row.checked { border-color: var(--success); background: rgba(16,185,129,0.05); }

        /* Modals */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.9); z-index: 2000;
            align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-box { max-height: 90vh; overflow-y: auto; border-radius: 24px !important; }

        /* History Table */
        #hist-table-real {
            font-size: 0.75rem; border-collapse: collapse; width: 100%;
        }
        #hist-table-real th {
            background: rgba(0,0,0,0.3); color: var(--accent);
            font-weight: 600; padding: 12px 8px; border-bottom: 2px solid var(--border);
        }
        #hist-table-real td {
            padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: middle;
        }

        /* Status Widget */
        .status-widget {
            padding: 15px; border-radius: 16px !important;
            border: 1px solid var(--border); background: rgba(0,0,0,0.3);
        }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; display: inline-block;
            margin-right: 8px; background: #64748b;
        }
        .online .status-dot { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* KTS Prompt */
        #kts-prompt {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 99999; align-items: center; justify-content: center; backdrop-filter: blur(10px);
            opacity: 0; transition: opacity 0.2s;
        }
        #kts-prompt[style*="flex"] { opacity: 1; }
        .kts-prompt-box {
            background: #152036; padding: 30px; border-radius: 24px !important;
            border: 1px solid #6366f1; width: 350px; text-align: center;
            box-shadow: 0 0 30px rgba(99,102,241,0.2); animation: glow-pulse 2s infinite;
        }
        #kts-prompt input {
            font-size: 1.2rem !important; padding: 15px 20px !important; text-align: center;
            letter-spacing: 3px; font-weight: bold; background: rgba(0,0,0,0.5) !important;
            border: 2px solid var(--accent) !important; border-radius: 12px !important; color: white !important;
        }
        #kts-prompt input:focus {
            border-color: var(--success) !important;
            box-shadow: 0 0 20px rgba(16,185,129,0.5) !important;
            transform: scale(1.02);
        }
        #kts-prompt.post-logout .kts-prompt-box { border: 2px solid var(--success); animation: pulse-success 1.5s infinite; }
        #kts-prompt.post-logout input { background: rgba(16,185,129,0.15) !important; border: 2px solid var(--success) !important; }

        @keyframes glow-pulse {
            0% { box-shadow: 0 0 20px rgba(99,102,241,0.3); }
            50% { box-shadow: 0 0 40px rgba(99,102,241,0.6); }
            100% { box-shadow: 0 0 20px rgba(99,102,241,0.3); }
        }
        @keyframes pulse-success {
            0% { box-shadow: 0 0 10px rgba(16,185,129,0.5); }
            50% { box-shadow: 0 0 30px rgba(16,185,129,0.8); }
            100% { box-shadow: 0 0 10px rgba(16,185,129,0.5); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hist-tab-btn {
            flex:1; border:none; padding:10px; border-radius:10px; cursor:pointer;
            color: white; background: transparent; transition: 0.3s;
        }
        .hist-tab-btn.active { background: var(--accent); box-shadow: 0 4px 10px var(--accent-glow); }

        /* Manual Layouter */
        #modal-manual-layout {
            display: none; position: fixed; inset: 0; background: var(--bg); z-index: 5000;
            grid-template-columns: 350px 1fr;
        }
        .layout-sidebar label {
            font-size: 0.55rem !important; color: var(--text-dim);
            font-weight: 600; display: block; text-transform: uppercase;
        }
        .layout-sidebar input, .layout-sidebar select {
            font-size: 0.7rem !important; height: 28px !important;
            padding: 0 8px !important; border-radius: 6px !important;
        }
        .layout-main {
            background: #000; display: flex; flex-direction: column;
            align-items: center; padding: 40px; overflow-y: auto;
        }
        .paper-canvas {
            background: white; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .canvas-item { position: absolute; border: 1px solid transparent; }
        .canvas-item:hover { border: 1px solid var(--accent); }
        .canvas-item .item-del {
            position: absolute; top: -10px; right: -10px;
            background: var(--danger); color: white; width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer;
        }
        .upload-zone {
            border: 2px dashed var(--border); border-radius: 12px; padding: 15px;
            text-align: center; cursor: pointer; background: rgba(255,255,255,0.02);
            margin-bottom: 15px;
        }
        .upload-zone:hover { border-color: var(--accent); background: rgba(99,102,241,0.1); }
        #manual-source-list {
            display: grid !important; grid-template-columns: 1fr 1fr !important;
            gap: 10px !important; align-content: start; padding-bottom: 20px;
        }
        .asset-card {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: 8px; height: 120px; display: flex; flex-direction: column;
            overflow: hidden; position: relative; cursor: pointer;
        }
        .asset-card:hover { border-color: var(--accent); transform: scale(1.02); }
        .asset-thumb {
            flex:1; display: flex; align-items: center; justify-content: center;
            background-color: #0b0b0b;
        }
        .asset-thumb img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .asset-info {
            height: 24px; background: #080c16; display: flex;
            align-items: center; justify-content: space-between; padding: 0 8px;
        }
        .asset-name {
            font-size: 0.6rem; color: #94a3b8;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px;
        }
        .asset-del {
            font-size: 0.7rem; cursor: pointer; color: var(--danger); opacity: 0.7;
        }
        .asset-del:hover { opacity: 1; }

        /* Logout Confirm */
        #logout-confirm {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.8); z-index: 99999;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        #logout-confirm > div {
            background: #152036; padding: 25px; border-radius: 16px;
            text-align: center; width: 300px; border: 1px solid #6366f1;
            animation: fadeIn 0.3s;
        }
        #logout-confirm .btn-danger { background: var(--danger); color: white; border: none; }

        /* Toast Notification */
        .toast {
            position: fixed; bottom: 30px; right: 30px; padding: 12px 24px;
            background: var(--success); color: #000; font-weight: bold;
            border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 20000; font-size: 0.9rem; animation: fadeIn 0.3s ease;
        }
        .toast.error { background: var(--danger); color: white; }
        .toast.info { background: var(--accent); color: white; }
    </style>
</head>
<body>
    <!-- AUDIO FILES (dari GitHub / lokal) -->
    <audio id="notif-sound" src="notif.mp3" preload="auto"></audio>
    <audio id="conn-sound" src="conn.mp3" preload="auto"></audio>
    <audio id="done-sound" src="done.mp3" preload="auto"></audio>

    <!-- LOGOUT CONFIRM MODAL -->
    <div id="logout-confirm">
        <div>
            <p>Logout dari system?</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" style="flex:1" onclick="closeLogoutConfirm()">BATAL</button>
                <button class="btn btn-danger" style="flex:1" onclick="confirmLogout()">LOGOUT</button>
            </div>
        </div>
    </div>

    <!-- PROMPT CUSTOM -->
    <div id="kts-prompt">
        <div class="kts-prompt-box">
            <h3 id="p-title" style="margin-top:0; font-family:'Outfit'; color:#6366f1;">Input Required</h3>
            <p id="p-desc" style="font-size:0.8rem; color:#94a3b8; margin-bottom:20px;"></p>
            <input type="text" id="p-val" class="cyber-input" autocomplete="off">
            <div style="display:flex; gap:10px; margin-top:25px;">
                <button class="btn btn-outline" style="flex:1" onclick="closeKtsPrompt()">CANCEL</button>
                <button class="btn btn-primary" style="flex:1" onclick="confirmKts()">OK</button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box glass-panel">
            <h1 style="font-family:'Outfit'; font-size:2.5rem; margin:0; background:linear-gradient(to right,#6366f1,#10b981); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">KERTASES FLOW</h1>
            <p style="color:var(--text-dim); letter-spacing:3px;">WEB EDITION</p>
            <div class="role-grid">
                <div class="role-card" data-role="admin"><i>üï∂Ô∏è</i><span>ADMIN</span></div>
                <div class="role-card" data-role="designer"><i>üé®</i><span>DESIGNER</span></div>
                <div class="role-card" data-role="operator"><i>üñ®Ô∏è</i><span>OPERATOR</span></div>
            </div>
            <div style="margin-top:30px; display:flex; gap:10px; justify-content:center;">
                <button id="btn-cloud" class="btn btn-primary">CLOUD</button>
                <button id="btn-local" class="btn btn-outline">LOCAL LAN</button>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-layout">
        <!-- SIDEBAR -->
        <div class="sidebar glass-panel">
            <div style="padding:20px; text-align:center;">
                <div id="active-role-display" class="btn btn-primary btn-mini" style="border-radius:20px; padding:5px 20px;">---</div>
                <div id="status-widget" class="status-widget" style="margin-top:20px; text-align:left;">
                    <div style="font-weight:700; font-size:0.8rem; display:flex; align-items:center;">
                        <span class="status-dot"></span> <span id="status-text">OFFLINE</span>
                    </div>
                    <div id="my-id-container" style="font-size:0.7rem; color:var(--text-dim); margin-top:8px; padding:8px; background:rgba(0,0,0,0.2); border-radius:10px;">
                        MY ID: 
                        <span id="my-id-display" style="color:var(--accent); font-weight:bold; cursor:pointer;">...</span>
                        <input type="text" id="my-id-editor" value="" style="display:none; background:rgba(0,0,0,0.5); color:var(--accent); font-weight:bold; border:1px solid var(--accent); border-radius:6px; padding:4px 8px; width:120px; font-size:0.7rem;">
                    </div>
                </div>
            </div>
            <div style="padding:0 20px;">
                <label style="font-size:0.65rem; color:var(--text-dim); display:block; margin-bottom:5px;">CONNECT PARTNER:</label>
                <input type="text" id="target-id" class="cyber-input" placeholder="ID partner...">
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="connectMulti()">LINK CONNECT</button>
            </div>
            <div id="active-conns" style="padding:10px 20px; flex:1; overflow-y:auto;"></div>
            <div style="padding:20px; border-top:1px solid var(--border);">
                <button class="btn btn-success btn-mini" style="width:100%; margin-bottom:8px;" onclick="location.reload()">üîÑ REFRESH SYSTEM</button>
                <button class="btn btn-outline" style="width:100%; color:var(--accent); border-color:var(--accent);" onclick="toggleHistory()">üìã PRODUCTION LOG</button>
                <button class="btn btn-mini btn-outline" style="width:100%; margin-top:10px; border:none; color:var(--danger);" onclick="doLogout()">üö™ LOGOUT</button>
            </div>
        </div>

        <!-- MAIN VIEW -->
        <div class="main-view">
            <!-- TIMELINE -->
            <div class="timeline glass-panel">
                <div id="batch-bar" class="batch-bar">
                    <span id="batch-count" style="font-size:0.75rem; font-weight:700;">0 ITEM DIPILIH</span>
                    <button class="btn btn-success btn-mini" onclick="openBatchPrint()">üìÑ BATCH PDF</button>
                </div>
                <div class="timeline-header">
                    <span style="font-weight:700; font-family:'Outfit';">üìã TIMELINE FLOW</span>
                    <button class="btn btn-danger btn-mini" onclick="clearTimeline()">üóëÔ∏è CLEAR</button>
                </div>
                <!-- FILTER BAR (DIISI VIA JS) -->
                <div id="filter-bar" class="filter-bar"></div>
                <!-- STREAM AREA -->
                <div id="stream-area" class="stream-area"></div>
            </div>
            <!-- CONTROL PANEL -->
            <div class="control-panel glass-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-weight:700; font-family:'Outfit';">üì¶ ASSETS</span>
                        <button id="btn-open-layouter" class="btn btn-mini btn-outline" style="display:none;" onclick="openManualLayouter()">üß© LAYOUT</button>
                    </div>
                    <button class="btn btn-mini btn-outline" onclick="toggleSelectAllRows()">‚úÖ ALL</button>
                </div>
                <div id="job-list"></div>
                <button class="btn btn-outline" style="border-style:dashed; width:100%; border-radius:12px;" onclick="addNewJob()">‚ûï ADD DATA ROW</button>
                <button id="btn-action-main" class="btn btn-primary" style="width:100%; margin-top:15px; height:50px;" onclick="mainAction()">‚ö° PROCESS DATA</button>
                <input type="file" id="job-file-in" multiple style="display:none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>

    <!-- MODAL: MANUAL LAYOUTER (OPERATOR) -->
    <div id="modal-manual-layout">
        <div class="layout-sidebar glass-panel" style="padding:15px; width:300px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px;">
                <button class="btn btn-mini btn-outline" style="padding:4px 8px;" onclick="closeManualLayouter()">‚¨ÖÔ∏è BACK</button>
                <span style="font-family:'Outfit'; color:var(--accent); font-weight:bold;">üß© LAYOUTER</span>
            </div>
            <div class="upload-zone" onclick="document.getElementById('manual-upload-in').click()">
                <span class="upload-icon">üìÇ</span><span class="upload-text">IMPORT IMAGES</span>
                <input type="file" id="manual-upload-in" hidden multiple accept="image/*" onchange="handleManualUpload(this)">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr 0.8fr; gap:5px; margin-bottom:8px;">
                <div><label>W (cm)</label><input type="number" id="m-w" value="5" step="0.1" class="cyber-input"></div>
                <div><label>H (cm)</label><input type="number" id="m-h" value="5" step="0.1" class="cyber-input"></div>
                <div><label>ROT</label><select id="m-rot" class="cyber-input"><option value="0">0¬∞</option><option value="90">90¬∞</option><option value="180">180¬∞</option><option value="270">270¬∞</option></select></div>
            </div>
            <div style="background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px;">
                <div style="display:flex; align-items:flex-end; gap:5px; margin-bottom:8px;">
                    <div style="flex:1;"><label>GAP (cm)</label><input type="number" id="m-gap" value="0.5" step="0.1" class="cyber-input"></div>
                    <button class="btn btn-outline" style="height:28px; width:28px; padding:0;" onclick="document.getElementById('m-gap').value=0">0</button>
                </div>
                <div style="border-top:1px dashed var(--border); padding-top:6px;">
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:5px;">
                        <input type="checkbox" id="m-use-kres"><label for="m-use-kres" style="cursor:pointer;">CROP MARKS</label>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                        <div><label>TEBAL (mm)</label><input type="number" id="m-kres-tebal" value="0.3" step="0.1" class="cyber-input"></div>
                        <div><label>PANJANG (mm)</label><input type="number" id="m-kres-panjang" value="5" step="1" class="cyber-input"></div>
                    </div>
                </div>
            </div>
            <div style="flex:1; overflow-y:auto; border-top:1px solid var(--border); padding-top:10px;">
                <label style="color:var(--accent); font-weight:bold;">üìÅ ASSETS GALLERY:</label>
                <div id="manual-source-list"></div>
            </div>
            <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="printManualCanvas()">üñ®Ô∏è PRINT LAYOUT</button>
        </div>
        <div class="layout-main">
            <div style="margin-bottom:20px; display:flex; gap:15px; align-items:center; background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:50px;">
                <select id="m-paper" class="cyber-input" style="width:150px;" onchange="updatePaperCanvas()">
                    <option value="32,48">A3+ (32x48)</option>
                    <option value="21,29.7">A4 (21x29.7)</option>
                </select>
                <button class="btn btn-mini btn-danger" onclick="clearManualCanvas()">üóëÔ∏è CLEAR</button>
                <span style="font-size:0.7rem; color:var(--text-dim);">‚ö° KLIK GAMBAR UNTUK SUSUN</span>
            </div>
            <div id="paper-canvas" class="paper-canvas"></div>
        </div>
    </div>

    <!-- MODAL: PRINT -->
    <div id="modal-print" class="modal">
        <div class="modal-box glass-panel" style="width:700px; padding:30px;">
            <h2 style="font-family:'Outfit'; margin-top:0;">üñ®Ô∏è PRODUCTION SETUP</h2>
            <div style="display:flex; gap:20px; margin-bottom:25px;">
                <div class="glass-panel" style="width:120px; height:120px; display:flex; align-items:center; justify-content:center; background:#000; overflow:hidden; position:relative;">
                    <img id="p-img" style="max-width:100%; max-height:100%; object-fit:contain;">
                    <div id="p-pdf-badge" class="pdf-tag" style="display:none;">PDF</div>
                </div>
                <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                    <div><label style="font-size:0.7rem;">INVOICE</label><input type="text" id="p-inv-edit" class="cyber-input" style="color:var(--warning); font-weight:700;"></div>
                    <div><label style="font-size:0.7rem;">MATERIAL</label>
                        <select id="p-mat" class="cyber-input">
                            <option>Chromo</option><option>Vinyl Glossy</option><option>Vinyl Matte</option>
                            <option>Transparan</option><option>Art Carton</option><option>HVS</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="print-mode-tabs" style="display:flex; gap:10px; margin-bottom:20px;">
                <button id="mode-full-btn" class="btn btn-outline active" onclick="switchPrintMode('full')" style="flex:1;">üìÑ FULL PAGE</button>
                <button id="mode-grid-btn" class="btn btn-outline" onclick="switchPrintMode('grid')" style="flex:1;">üî≤ GRID TILE</button>
            </div>
            <div class="glass-panel" style="padding:20px; background:rgba(0,0,0,0.2);">
                <label style="font-size:0.7rem;">üìê UKURAN KERTAS</label>
                <select id="p-pdf-paper" class="cyber-input" onchange="toggleCustomPaper(this.value)">
                    <option value="32,48">A3+ (32x48 cm)</option><option value="29.7,42">A3</option>
                    <option value="21,29.7">A4</option><option value="custom">‚öôÔ∏è CUSTOM</option>
                </select>
                <div id="custom-paper-box" style="display:none; gap:10px; margin-top:10px;">
                    <input type="number" id="p-custom-w" class="cyber-input" placeholder="W (cm)" oninput="calcGrid()">
                    <input type="number" id="p-custom-h" class="cyber-input" placeholder="H (cm)" oninput="calcGrid()">
                </div>
                <div id="grid-controls" style="display:none; border-top:1px solid var(--border); padding-top:15px; margin-top:15px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; align-items:flex-end;">
                        <div><label style="font-size:0.6rem;">L (cm)</label><input type="number" id="p-grid-w" value="5" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
                        <div><label style="font-size:0.6rem;">T (cm)</label><input type="number" id="p-grid-h" value="5" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
                        <div><label style="font-size:0.6rem;">GAP</label><input type="number" id="p-grid-gap" value="0" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
                        <button class="btn btn-outline" onclick="physicalRotate()">üîÑ</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; padding-top:10px; border-top:1px dashed var(--border);">
                        <div><label style="font-size:0.6rem;">KRES TEBAL (mm)</label><input type="number" id="p-grid-kres-thick" value="0.2" step="0.1" class="cyber-input"></div>
                        <div><label style="font-size:0.6rem;">KRES PANJANG (mm)</label><input type="number" id="p-grid-kres-len" value="5" step="1" class="cyber-input"></div>
                    </div>
                    <div id="grid-res-box" style="text-align:center; color:var(--success); font-size:0.8rem; margin-top:10px; font-weight:700;">HASIL: -</div>
                </div>
                <div style="margin-top:20px; display:flex; gap:20px; align-items:center;">
                    <label style="font-size:0.7rem;">üì¶ QTY LEMBAR</label>
                    <input type="number" id="p-pdf-target" value="1" min="1" class="cyber-input" style="width:100px; text-align:center; font-size:1.2rem; color:var(--success); font-weight:800;" oninput="calcGrid()">
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 2fr; gap:15px; margin-top:25px;">
                <button class="btn btn-danger" onclick="closeModal()">‚ùå BATAL</button>
                <button id="btn-do-print" class="btn btn-primary" onclick="executePrint()">üñ®Ô∏è MULAI CETAK</button>
            </div>
        </div>
    </div>

    <!-- MODAL: HISTORY -->
    <div id="modal-hist" class="modal">
        <div class="modal-box glass-panel" style="width:90%; max-width:1200px; padding:30px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2 style="font-family:'Outfit'; margin:0;">üìÅ PRODUCTION LOG - <span id="hist-role-title" style="color:var(--accent);"></span></h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-mini btn-success" onclick="exportLogToPDF()">üìÑ EXPORT PDF</button>
                    <button class="btn btn-mini btn-danger" onclick="clearAllHistory()">üóëÔ∏è CLEAR LOG</button>
                </div>
            </div>
            <div class="hist-tabs" style="display:flex; background:rgba(0,0,0,0.2); padding:5px; border-radius:12px; margin-bottom:15px;">
                <button class="hist-tab-btn active" id="tab-1" onclick="switchHistTab(1)">üì• INBOX / DATA MASUK</button>
                <button class="hist-tab-btn" id="tab-2" onclick="switchHistTab(2)">üì§ OUTBOX / RIWAYAT</button>
            </div>
            <div style="max-height:450px; overflow-y:auto;" class="glass-panel">
                <table id="hist-table-real" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="width:12%;">WAKTU</th>
                            <th style="width:10%;">STATUS</th>
                            <th style="width:12%;">PARTNER</th>
                            <th style="width:12%;">INVOICE</th>
                            <th style="width:30%;">KETERANGAN</th>
                            <th style="width:8%;">QTY</th>
                            <th style="width:8%;">AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="hist-body"></tbody>
                </table>
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:25px;" onclick="toggleHistory()">üîí CLOSE</button>
        </div>
    </div>

    <!-- TEMPLATE MESSAGE CARD -->
    <template id="msg-card-template">
        <div class="msg-card">
            <div class="msg-header">
                <div style="display:flex; align-items:center;"></div>
                <span style="cursor:pointer; color:var(--danger); font-weight:bold; padding:0 5px;">‚úï</span>
            </div>
            <div class="msg-body"></div>
            <div class="msg-footer" style="padding:12px; display:flex; gap:10px; border-top:1px solid rgba(255,255,255,0.05);"></div>
        </div>
    </template>

    <iframe id="p-frame" style="display:none;"></iframe>

    <script>
        // ============================================
        // KERTASES FLOW - WEB EDITION (FULLY FUNCTIONAL)
        // ============================================

        // ---------- GLOBAL VARIABLES ----------
        const ROLES_KEYS = { admin: "calik", designer: "melengkung", operator: "nangtung" };

        // ID MANAGEMENT (PERSISTEN)
        let myId = localStorage.getItem('kts_id');
        if (!myId) {
            myId = 'KTS-' + Math.floor(Math.random() * 9000 + 1000);
            localStorage.setItem('kts_id', myId);
        }

        let role = null;
        let peer = null;
        let db = null;
        let activeConns = [];
        let currentTab = 1;
        let timelineFilter = 'outbox'; // default sementara, akan disesuaikan per role
        let tempJobs = [];
        let activeJobIdx = null;
        let selectedInboxes = [];
        let currentPrintMode = 'full';
        let activeJob = null;
        let currentPromptTask = null;
        let postLogoutMode = false;

        // ---------- MANUAL LAYOUT ----------
        let manualSources = [];
        let canvasItems = [];
        let currentX = 0, currentY = 0, maxRowH = 0;

        // ---------- STREAM CACHE & PAGINATION ----------
        let streamCache = [];
        let timelinePage = 0;
        const TIMELINE_PAGE_SIZE = 18;
        let timelineFilteredData = [];
        let isLoadingMore = false;

        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ---------- INDEXED DB ----------
        const DB_NAME = 'KertasesFlowWebDB';
        const DB_VERSION = 1;
        let openRequest = indexedDB.open(DB_NAME, DB_VERSION);
        openRequest.onupgradeneeded = e => {
            let db = e.target.result;
            if (!db.objectStoreNames.contains('stream')) {
                db.createObjectStore('stream', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('history')) {
                db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
            }
        };
        openRequest.onsuccess = e => {
            db = e.target.result;
            loadStreamCache();
            checkAutoLogin();
        };
        openRequest.onerror = e => console.error('IndexedDB error:', e);

        // ---------- TOAST ----------
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast ' + (type === 'error' ? 'error' : (type === 'info' ? 'info' : ''));
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ---------- AUDIO ----------
        function playSound(id) {
            let audio = document.getElementById(id);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }

        // ---------- PROMPT ----------
        function openKtsPrompt(title, desc, type, callback) {
            document.getElementById('p-title').innerText = title;
            document.getElementById('p-desc').innerText = desc;
            let inp = document.getElementById('p-val');
            inp.type = type; inp.value = '';
            document.getElementById('kts-prompt').style.display = 'flex';
            currentPromptTask = callback;
            setTimeout(() => { inp.focus(); inp.select(); }, 200);
        }
        function closeKtsPrompt() {
            document.getElementById('kts-prompt').style.display = 'none';
            currentPromptTask = null;
        }
        function confirmKts() {
            let v = document.getElementById('p-val').value.trim();
            if (v && currentPromptTask) currentPromptTask(v);
            closeKtsPrompt();
        }

        // ---------- LOGOUT ----------
        function doLogout() { document.getElementById('logout-confirm').style.display = 'flex'; }
        function closeLogoutConfirm() { document.getElementById('logout-confirm').style.display = 'none'; }
        function confirmLogout() {
            closeLogoutConfirm();
            if (peer) peer.destroy();
            localStorage.removeItem('kts_active_role');
            role = null;
            tempJobs = [];
            activeConns = [];
            selectedInboxes = [];
            manualSources = [];
            canvasItems = [];
            streamCache = [];
            timelineFilteredData = [];
            document.getElementById('app-layout').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            postLogoutMode = true;
            reinitializeLoginListeners();
        }

        // ---------- LOGIN ----------
        function reinitializeLoginListeners() {
            let grid = document.querySelector('.role-grid');
            let newGrid = grid.cloneNode(false);
            let roles = ['ADMIN','DESIGNER','OPERATOR'], icons = ['üï∂Ô∏è','üé®','üñ®Ô∏è'];
            roles.forEach((r,i)=>{
                let card = document.createElement('div');
                card.className = 'role-card';
                card.tabIndex = 0;
                card.innerHTML = `<i>${icons[i]}</i><span>${r}</span>`;
                card.onclick = function(e) {
                    e.preventDefault();
                    enterRole(this.querySelector('span').textContent.toLowerCase());
                };
                card.onkeypress = function(e) {
                    if (e.key==='Enter'||e.key===' ') { e.preventDefault(); this.click(); }
                };
                newGrid.appendChild(card);
            });
            grid.parentNode.replaceChild(newGrid, grid);
            document.getElementById('btn-cloud').onclick = ()=> setMode('cloud');
            document.getElementById('btn-local').onclick = ()=> setMode('local');
        }

        function enterRole(r) {
            if (postLogoutMode || !localStorage.getItem('kts_active_role')) {
                openKtsPrompt("Login " + r.toUpperCase(), "Masukkan Kode Akses:", "password", pass => {
                    if (pass === ROLES_KEYS[r]) {
                        localStorage.setItem('kts_active_role', r);
                        loadInterface(r);
                    } else {
                        alert("‚ùå KODE SALAH!");
                        setTimeout(()=>enterRole(r),300);
                    }
                });
            } else {
                openKtsPrompt("Login " + r.toUpperCase(), "Masukkan Kode Akses:", "password", pass => {
                    if (pass === ROLES_KEYS[r]) {
                        localStorage.setItem('kts_active_role', r);
                        loadInterface(r);
                    } else alert("‚ùå KODE SALAH!");
                });
            }
        }

        function checkAutoLogin() {
            let saved = localStorage.getItem('kts_active_role');
            if (saved) loadInterface(saved);
        }

        function loadInterface(r) {
            role = r;
            postLogoutMode = false;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-layout').style.display = 'flex';
            document.getElementById('active-role-display').innerText = role.toUpperCase();
            document.getElementById('my-id-display').innerText = myId;

            // Aktifkan komponen khusus operator
            if (role === 'operator') {
                document.getElementById('batch-bar').style.display = 'flex';
                document.getElementById('btn-open-layouter').style.display = 'inline-flex';
                // Ubah judul tab history
                document.getElementById('tab-2').innerText = 'üìä DATA HASIL PENCETAKAN';
            } else {
                document.getElementById('tab-2').innerText = 'üì§ OUTBOX / RIWAYAT';
            }

            // Inisialisasi filter bar
            initFilterBar();

            // Set default timeline filter sesuai role
            if (role === 'admin') timelineFilter = 'outbox';
            else if (role === 'designer') timelineFilter = 'inbox_admin';
            else if (role === 'operator') timelineFilter = 'inbox_designer';

            // Aktifkan tombol filter yang sesuai
            activateFilterButton();

            initPeer();
            addNewJob();
            makeMyIdEditable(); // enable inline edit MY ID
            setTimeout(() => renderStream(true), 500);
        }

        // ---------- MY-ID EDITABLE (INLINE) ----------
        function makeMyIdEditable() {
            const displaySpan = document.getElementById('my-id-display');
            const editorInput = document.getElementById('my-id-editor');
            const container = document.getElementById('my-id-container');

            displaySpan.onclick = function(e) {
                e.stopPropagation();
                displaySpan.style.display = 'none';
                editorInput.value = myId;
                editorInput.style.display = 'inline-block';
                editorInput.focus();
                editorInput.select();
            };

            function processIdChange() {
                const newId = editorInput.value.trim();
                if (newId === '' || newId === myId) {
                    editorInput.style.display = 'none';
                    displaySpan.style.display = 'inline';
                    return;
                }
                openKtsPrompt("üîê Admin Access", "Masukkan kode reset (4869):", "password", (code) => {
                    if (code === "4869") {
                        localStorage.setItem('kts_id', newId);
                        showToast(`‚úÖ ID diubah menjadi: ${newId}`, 'success');
                        location.reload();
                    } else {
                        alert("‚ùå Kode akses salah! Perubahan dibatalkan.");
                        editorInput.style.display = 'none';
                        displaySpan.style.display = 'inline';
                    }
                });
            }

            editorInput.addEventListener('blur', processIdChange);
            editorInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processIdChange();
                }
            });
        }

        // ---------- FILTER BAR (ROLE BASED) ----------
        function initFilterBar() {
            let bar = document.getElementById('filter-bar');
            bar.innerHTML = '';
            if (role === 'admin') {
                bar.innerHTML = `<button class="btn btn-mini btn-outline" onclick="setTimelineFilter('outbox', this)">üì§ OUTBOX</button>
                                 <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('printed', this)">üñ®Ô∏è DATA CETAK</button>`;
            } else if (role === 'designer') {
                bar.innerHTML = `<button class="btn btn-mini btn-outline" onclick="setTimelineFilter('inbox_admin', this)">üì• INBOX (ADMIN)</button>
                                 <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('outbox', this)">üì§ OUTBOX (OPERATOR)</button>
                                 <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('printed', this)">üñ®Ô∏è DATA CETAK</button>`;
            } else if (role === 'operator') {
                bar.innerHTML = `<button class="btn btn-mini btn-outline" onclick="setTimelineFilter('inbox_designer', this)">üì• INBOX (DESIGNER)</button>
                                 <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('printed', this)">üñ®Ô∏è DATA CETAK</button>`;
            }
            // Aktifkan tombol sesuai timelineFilter saat ini
            activateFilterButton();
        }

        function activateFilterButton() {
            let btns = document.querySelectorAll('#filter-bar .btn');
            btns.forEach(btn => btn.classList.remove('active'));
            let targetText = '';
            if (timelineFilter === 'outbox') targetText = 'OUTBOX';
            else if (timelineFilter === 'printed') targetText = 'DATA CETAK';
            else if (timelineFilter === 'inbox_admin') targetText = 'INBOX (ADMIN)';
            else if (timelineFilter === 'inbox_designer') targetText = 'INBOX (DESIGNER)';
            btns.forEach(btn => {
                if (btn.innerText.includes(targetText)) btn.classList.add('active');
            });
        }

        // ---------- MODE (CLOUD / LOCAL) ----------
        function setMode(m) {
            if (m === 'local') {
                openKtsPrompt("üåê Local LAN Setup", "Masukkan IP Server Lokal (contoh: 192.168.1.10):", "text", ip => {
                    localStorage.setItem('kts_mode','local');
                    localStorage.setItem('kts_ip', ip);
                    location.reload();
                });
            } else {
                localStorage.setItem('kts_mode','cloud');
                location.reload();
            }
        }

        // ---------- PEER CONNECTION ----------
        function initPeer() {
            let mode = localStorage.getItem('kts_mode') || 'cloud';
            let ip = localStorage.getItem('kts_ip') || 'localhost';
            let opts = mode === 'local' ? { host: ip, port: 9000, path: '/kertases', secure: false } : { debug: 1 };
            peer = new Peer(myId, opts);
            peer.on('open', () => updatePeerStatus('ready'));
            peer.on('connection', conn => setupConn(conn));
            peer.on('error', err => {
                if (err.type === 'peer-unavailable') alert("‚ùå Partner tidak ditemukan!");
                updatePeerStatus('offline');
            });
        }

        function connectMulti() {
            let tid = document.getElementById('target-id').value.trim();
            if (!tid || tid === myId) return alert("‚ö†Ô∏è ID tidak valid!");
            updatePeerStatus('connecting...');
            let conn = peer.connect(tid, { reliable: true });
            setupConn(conn);
        }

        function setupConn(conn) {
            conn.on('open', () => {
                if (!activeConns.find(c => c.peer === conn.peer)) {
                    activeConns.push(conn);
                    updatePeerUI();
                    playSound('conn-sound');
                }
            });
            conn.on('data', data => {
                if (data.type === 'job') handleIncoming(data, conn.peer);
                if (data.type === 'status_update') handleStatusUpdate(data);
            });
            conn.on('close', () => {
                activeConns = activeConns.filter(c => c.peer !== conn.peer);
                updatePeerUI();
            });
        }

        function updatePeerUI() {
            let html = activeConns.map(c => `<div class="glass-panel" style="padding:8px; margin-bottom:5px; font-size:0.7rem; border-color:var(--success);">üü¢ ${c.peer}</div>`).join('');
            document.getElementById('active-conns').innerHTML = html || '<div style="color:var(--text-dim);">‚Äî no peers ‚Äî</div>';
            updatePeerStatus(activeConns.length ? 'connected' : 'ready');
        }

        function updatePeerStatus(s) {
            let w = document.getElementById('status-widget');
            w.className = 'status-widget ' + (activeConns.length ? 'online' : '');
            document.getElementById('status-text').innerText = activeConns.length ? 'CONNECTED' : s.toUpperCase();
        }

        // ---------- CONTROL PANEL ----------
        function addNewJob() {
            tempJobs.push({ files: [], inv: '', cap: '', selected: true });
            renderJobs();
        }

        function renderJobs() {
            let list = document.getElementById('job-list');
            list.innerHTML = '';
            tempJobs.forEach((job, jIdx) => {
                let row = document.createElement('div');
                row.className = `job-row ${job.selected ? 'checked' : ''}`;
                let thumbs = job.files.map((f, fIdx) => `<div class="thumb-box" style="position:relative;">
                    <img src="${f.thumb}">${f.isPdf ? '<span class="pdf-tag">PDF</span>' : ''}
                    <div onclick="removeFile(${jIdx},${fIdx})" style="position:absolute; top:-4px; left:-4px; background:var(--danger); color:white; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer;">√ó</div>
                </div>`).join('');
                row.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span onclick="removeJobRow(${jIdx})" style="background:var(--danger); padding:2px 10px; border-radius:20px; font-size:0.65rem; cursor:pointer;">üóëÔ∏è HAPUS</span>
                        <input type="checkbox" ${job.selected ? 'checked' : ''} onchange="tempJobs[${jIdx}].selected = this.checked; renderJobs();">
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
                        ${thumbs}
                        <div class="thumb-box" style="border:1px dashed var(--accent); display:flex; align-items:center; justify-content:center; font-size:1.5rem; cursor:pointer;" onclick="triggerFileSelect(${jIdx})">+</div>
                    </div>
                    <input type="text" class="cyber-input" placeholder="INV" value="${job.inv}" oninput="tempJobs[${jIdx}].inv = this.value" style="margin-bottom:6px;">
                    <textarea class="cyber-input" placeholder="Keterangan" rows="2" oninput="tempJobs[${jIdx}].cap = this.value">${job.cap}</textarea>
                `;
                list.appendChild(row);
            });
        }

        function removeFile(jIdx, fIdx) {
            tempJobs[jIdx].files.splice(fIdx, 1);
            renderJobs();
        }
        function removeJobRow(idx) {
            if (tempJobs.length > 1) {
                tempJobs.splice(idx, 1);
                renderJobs();
            } else alert("‚ö†Ô∏è Minimal satu baris!");
        }
        function triggerFileSelect(idx) {
            activeJobIdx = idx;
            document.getElementById('job-file-in').click();
        }
        async function handleFileSelect(input) {
            if (!input.files.length || activeJobIdx === null) return;
            for (let f of input.files) {
                let isPdf = f.type === 'application/pdf';
                let data = await toBase64(f);
                let thumb = isPdf ? await getPdfPreview(data) : data;
                tempJobs[activeJobIdx].files.push({ data, thumb, isPdf, name: f.name });
            }
            renderJobs();
            input.value = '';
        }
        function toggleSelectAllRows() {
            let all = tempJobs.every(j => j.selected);
            tempJobs.forEach(j => j.selected = !all);
            renderJobs();
        }

        // ---------- MAIN ACTION ----------
        function mainAction() {
            let sel = tempJobs.filter(j => j.selected);
            if (!sel.length) return alert("‚ö†Ô∏è Pilih data!");
            if (role === 'operator') {
                let files = [];
                sel.forEach(j => j.files.forEach(f => files.push({ ...f, inv: j.inv })));
                if (!files.length) return alert("‚ö†Ô∏è Tidak ada file!");
                openPrintLogic({ files, internalId: null });
            } else {
                if (!activeConns.length) return alert("‚ö†Ô∏è Koneksikan Partner!");
                let d = {
                    type: 'job',
                    jobs: sel,
                    id: Date.now(),
                    senderRole: role,
                    senderId: myId,
                    status: 'pending'
                };
                activeConns.forEach(c => { if (c.open) c.send(d); });
                let outData = { ...d, direction: 'out', to: activeConns.map(c => c.peer).join(', '), hidden: false };
                saveStream(outData);
                sel.forEach(job => saveHistory({
                    inv: job.inv,
                    cap: job.cap,
                    typeLabel: role === 'admin' ? 'ADM_SEND' : 'DSN_SEND',
                    partner: activeConns.map(c => c.peer).join(', ')
                }));
                showToast(`üì§ Data terkirim ke ${role === 'admin' ? 'Designer' : 'Operator'}`, 'success');
                tempJobs = tempJobs.filter(j => !j.selected);
                if (!tempJobs.length) addNewJob();
                renderJobs();
                // Insert card outbox langsung
                let newCard = createMessageCard(outData);
                let area = document.getElementById('stream-area');
                let lm = area.querySelector('.load-more-container');
                if (lm) lm.remove();
                area.insertBefore(newCard, area.firstChild);
            }
        }

        // ---------- INCOMING JOB ----------
        function handleIncoming(data, from) {
            let label = (role === 'designer') ? 'DSN_RECV' : 'OP_RECV';
            let streamData = {
                ...data,
                direction: 'in',
                from: from,
                hidden: false,
                reprintCount: 0,
                status: 'pending'
            };
            saveStream(streamData);
            if (data.jobs) {
                data.jobs.forEach(job => saveHistory({
                    inv: job.inv || '-',
                    cap: job.cap || '-',
                    typeLabel: label,
                    partner: from
                }));
            }
            // Insert card langsung
            let newCard = createMessageCard(streamData);
            let area = document.getElementById('stream-area');
            let lm = area.querySelector('.load-more-container');
            if (lm) lm.remove();
            area.insertBefore(newCard, area.firstChild);
            playSound('notif-sound');
        }

        // ---------- STATUS UPDATE ----------
        function handleStatusUpdate(d) {
            db.transaction('stream', 'readwrite').objectStore('stream').get(d.msgId).onsuccess = e => {
                let data = e.target.result;
                if (data) {
                    data.status = 'printed';
                    db.transaction('stream', 'readwrite').objectStore('stream').put(data);
                    let idx = streamCache.findIndex(m => m.id === d.msgId);
                    if (idx !== -1) streamCache[idx] = data;
                    updateMessageCardStatus(d.msgId, 'printed', data.reprintCount);
                }
            };
        }

        // ---------- STREAM CACHE (CURSOR, LIMIT 200) ----------
        function loadStreamCache() {
            if (!db) return;
            streamCache = [];
            let tx = db.transaction('stream');
            let store = tx.objectStore('stream');
            let req = store.openCursor(null, 'prev');
            let count = 0;
            req.onsuccess = e => {
                let cur = e.target.result;
                if (cur && count < 200) {
                    if (!cur.value.hidden) { streamCache.push(cur.value); count++; }
                    cur.continue();
                } else {
                    renderStream(true);
                }
            };
        }

        function saveStream(o) {
            db.transaction('stream', 'readwrite').objectStore('stream').put(o);
            let idx = streamCache.findIndex(m => m.id === o.id);
            if (idx !== -1) streamCache[idx] = o;
            else {
                streamCache.unshift(o);
                if (streamCache.length > 200) streamCache.pop();
            }
        }

        // ---------- RENDER STREAM (PAGINATION) ----------
        function renderStream(resetPage = true) {
            let area = document.getElementById('stream-area');
            if (!area) return;
            if (resetPage) {
                timelinePage = 0;
                timelineFilteredData = streamCache.filter(msg => {
                    if (timelineFilter === 'printed') return msg.status === 'printed';
                    if (timelineFilter === 'outbox') return msg.senderRole === role && msg.direction === 'out' && msg.status !== 'printed';
                    if (timelineFilter === 'inbox_admin') return msg.senderRole === 'admin' && msg.direction === 'in' && msg.status !== 'printed';
                    if (timelineFilter === 'inbox_designer') return msg.senderRole === 'designer' && msg.direction === 'in' && msg.status !== 'printed';
                    return false;
                });
                area.innerHTML = '';
            }
            let start = timelinePage * TIMELINE_PAGE_SIZE;
            let end = start + TIMELINE_PAGE_SIZE;
            let pageData = timelineFilteredData.slice(start, end);
            if (!pageData.length) {
                if (timelinePage === 0) area.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-dim);">üì≠ Tidak ada data</div>';
                return;
            }
            let frag = document.createDocumentFragment();
            pageData.forEach(m => frag.appendChild(createMessageCard(m)));
            if (resetPage) {
                area.innerHTML = '';
                area.appendChild(frag);
            } else {
                let old = area.querySelector('.load-more-container');
                if (old) old.remove();
                area.appendChild(frag);
            }
            if (end < timelineFilteredData.length) {
                let ld = document.createElement('div');
                ld.className = 'load-more-container';
                ld.style.cssText = 'text-align:center; padding:15px;';
                ld.innerHTML = `<button class="btn btn-outline btn-mini" onclick="loadMoreTimeline()">‚ö° MUAT ${TIMELINE_PAGE_SIZE} LAGI</button>`;
                area.appendChild(ld);
            }
            if (resetPage) area.scrollTop = 0;
        }

        function loadMoreTimeline() {
            if (isLoadingMore) return;
            isLoadingMore = true;
            timelinePage++;
            renderStream(false);
            isLoadingMore = false;
        }

        // ---------- CREATE MESSAGE CARD (TEMPLATE CLONE) ----------
        function createMessageCard(msg) {
            let tmpl = document.getElementById('msg-card-template');
            let card = tmpl.content.cloneNode(true).firstElementChild;
            card.id = `msg-${msg.id}`;
            card.className = `msg-card ${msg.direction} ${msg.status === 'printed' ? 'printed' : ''}`;
            if (selectedInboxes.includes(msg.id)) card.classList.add('selected');

            // ----- HEADER -----
            let headerDiv = card.querySelector('.msg-header div');
            let closeBtn = card.querySelector('.msg-header span');
            closeBtn.onclick = () => hideStream(msg.id);

            let printedMark = msg.status === 'printed' ? '<span class="printed-badge">üñ®Ô∏è DICETAK</span>' : '';
            let reprintMark = msg.reprintCount > 0 ? `<span style="background:var(--warning); color:black; padding:2px 8px; border-radius:20px; margin-left:5px; font-size:0.65rem; font-weight:700;">üîÑ REPRINT ${msg.reprintCount}x</span>` : '';
            headerDiv.innerHTML = `
                <span>${msg.direction === 'out' ? 'üì§ TO:' : 'üì• FROM:'} ${msg.direction === 'out' ? (msg.to || '?') : (msg.from || 'ME')} 
                    <span class="role-tag">${msg.senderRole}</span>
                </span> 
                ${printedMark} ${reprintMark}
            `;

            // ----- BODY -----
            let body = card.querySelector('.msg-body');
            body.innerHTML = '';
            if (msg.jobs && msg.jobs.length) {
                msg.jobs.forEach((job, jIdx) => {
                    let jobWrap = document.createElement('div');
                    jobWrap.style.marginBottom = '15px';

                    // INV row
                    let invRow = document.createElement('div');
                    invRow.style.display = 'flex';
                    invRow.style.alignItems = 'center';
                    invRow.style.marginBottom = '5px';
                    let invLabel = document.createElement('span');
                    invLabel.style.fontSize = '0.7rem';
                    invLabel.style.color = 'var(--text-dim)';
                    invLabel.style.marginRight = '8px';
                    invLabel.innerText = 'INV:';
                    invRow.appendChild(invLabel);
                    let invInput = document.createElement('input');
                    invInput.type = 'text';
                    invInput.className = 'card-edit-inv';
                    invInput.value = job.inv || '';
                    invInput.dataset.msgId = msg.id;
                    invInput.dataset.jobIdx = jIdx;
                    invInput.dataset.field = 'inv';
                    invInput.style.flex = '1';
                    invRow.appendChild(invInput);
                    jobWrap.appendChild(invRow);

                    // Keterangan
                    let capText = document.createElement('textarea');
                    capText.className = 'card-edit-cap';
                    capText.value = job.cap || '';
                    capText.dataset.msgId = msg.id;
                    capText.dataset.jobIdx = jIdx;
                    capText.dataset.field = 'cap';
                    jobWrap.appendChild(capText);

                    // Thumbnail + tombol save
                    if (job.files && job.files.length) {
                        job.files.forEach((f, fIdx) => {
                            let wrap = document.createElement('div');
                            wrap.className = 'thumb-row-wrap';
                            let tb = document.createElement('div');
                            tb.className = 'thumb-box';
                            tb.style.position = 'relative';
                            tb.innerHTML = `<img src="${f.thumb}">${f.isPdf ? '<span class="pdf-tag">PDF</span>' : ''}`;
                            wrap.appendChild(tb);
                            let saveBtn = document.createElement('button');
                            saveBtn.className = 'btn btn-mini btn-outline btn-save';
                            saveBtn.style.cssText = 'color:var(--success); border-color:rgba(16,185,129,0.3);';
                            saveBtn.innerText = 'üíæ SAVE';
                            saveBtn.dataset.data = f.data;
                            saveBtn.dataset.name = `${job.inv || 'file'}_${fIdx}`;
                            wrap.appendChild(saveBtn);
                            jobWrap.appendChild(wrap);
                        });
                    }
                    body.appendChild(jobWrap);
                });
            }

            // ----- FOOTER -----
            let footer = card.querySelector('.msg-footer');
            footer.innerHTML = '';

            if (role === 'designer') {
                if (msg.direction === 'in' && msg.senderRole === 'admin' && msg.status !== 'printed') {
                    let btn = document.createElement('button');
                    btn.className = 'btn btn-primary btn-mini btn-forward';
                    btn.innerText = 'üì§ FORWARD KE OPERATOR';
                    btn.dataset.msgId = msg.id;
                    btn.style.flex = '1';
                    footer.appendChild(btn);
                }
            } else if (role === 'operator') {
                if (msg.direction === 'in') {
                    if (msg.status !== 'printed') {
                        let printBtn = document.createElement('button');
                        printBtn.className = 'btn btn-success btn-mini btn-print';
                        printBtn.innerText = 'üñ®Ô∏è CETAK';
                        printBtn.dataset.msgId = msg.id;
                        printBtn.style.flex = '2';
                        footer.appendChild(printBtn);
                        let selectBtn = document.createElement('button');
                        selectBtn.className = `btn ${selectedInboxes.includes(msg.id) ? 'btn-primary' : 'btn-outline'} btn-mini btn-toggle`;
                        selectBtn.innerText = selectedInboxes.includes(msg.id) ? '‚úÖ READY' : '‚ûï BATCH';
                        selectBtn.dataset.msgId = msg.id;
                        selectBtn.style.flex = '1';
                        footer.appendChild(selectBtn);
                    } else {
                        let reprintBtn = document.createElement('button');
                        reprintBtn.className = 'btn btn-outline btn-mini btn-reprint';
                        reprintBtn.innerText = 'üîÑ CETAK ULANG';
                        reprintBtn.dataset.msgId = msg.id;
                        reprintBtn.style.flex = '1';
                        reprintBtn.style.borderColor = 'var(--warning)';
                        reprintBtn.style.color = 'var(--warning)';
                        footer.appendChild(reprintBtn);
                    }
                }
            }
            return card;
        }

        // ---------- EVENT DELEGATION ----------
        document.getElementById('stream-area').addEventListener('change', e => {
            if (e.target.classList.contains('card-edit-inv') || e.target.classList.contains('card-edit-cap')) {
                let msgId = parseInt(e.target.dataset.msgId);
                let jobIdx = parseInt(e.target.dataset.jobIdx);
                let field = e.target.dataset.field;
                let val = e.target.value;
                updateStreamContent(msgId, jobIdx, field, val);
            }
        });
        document.getElementById('stream-area').addEventListener('click', e => {
            if (e.target.classList.contains('btn-save')) {
                downloadAsset(e.target.dataset.data, e.target.dataset.name);
                e.preventDefault();
            }
            if (e.target.classList.contains('btn-print')) {
                openPrintSingle(parseInt(e.target.dataset.msgId));
                e.preventDefault();
            }
            if (e.target.classList.contains('btn-reprint')) {
                openPrintSingle(parseInt(e.target.dataset.msgId));
                e.preventDefault();
            }
            if (e.target.classList.contains('btn-toggle')) {
                toggleSelect(parseInt(e.target.dataset.msgId));
                e.preventDefault();
            }
            if (e.target.classList.contains('btn-forward')) {
                forwardToOperator(parseInt(e.target.dataset.msgId));
                e.preventDefault();
            }
        });

        // ---------- UTILITIES ----------
        function updateStreamContent(id, jIdx, field, val) {
            db.transaction('stream', 'readwrite').objectStore('stream').get(id).onsuccess = e => {
                let d = e.target.result;
                if (d) {
                    d.jobs[jIdx][field] = val;
                    db.transaction('stream', 'readwrite').objectStore('stream').put(d);
                    let idx = streamCache.findIndex(m => m.id === id);
                    if (idx !== -1) streamCache[idx] = d;
                }
            };
        }

        function hideStream(id) {
            db.transaction('stream', 'readwrite').objectStore('stream').get(id).onsuccess = e => {
                let d = e.target.result;
                if (d) {
                    d.hidden = true;
                    db.transaction('stream', 'readwrite').objectStore('stream').put(d);
                    let idx = streamCache.findIndex(m => m.id === id);
                    if (idx !== -1) streamCache.splice(idx, 1);
                    let card = document.getElementById(`msg-${id}`);
                    if (card) card.remove();
                }
            };
        }

        function updateMessageCardStatus(msgId, status, reprint = 0) {
            let card = document.getElementById(`msg-${msgId}`);
            if (!card) return;
            card.classList.remove('printed');
            if (status === 'printed') card.classList.add('printed');
            let header = card.querySelector('.msg-header div:first-child');
            if (header) {
                let old = header.querySelectorAll('.printed-badge, [style*="background:var(--warning)"]');
                old.forEach(el => el.remove());
                if (status === 'printed') {
                    let b = document.createElement('span');
                    b.className = 'printed-badge';
                    b.innerText = 'üñ®Ô∏è DICETAK';
                    header.appendChild(b);
                }
                if (reprint > 0) {
                    let b = document.createElement('span');
                    b.style.background = 'var(--warning)';
                    b.style.color = 'black';
                    b.style.padding = '2px 8px';
                    b.style.borderRadius = '20px';
                    b.style.marginLeft = '5px';
                    b.style.fontSize = '0.65rem';
                    b.style.fontWeight = '700';
                    b.innerText = `üîÑ REPRINT ${reprint}x`;
                    header.appendChild(b);
                }
            }
            let footer = card.querySelector('.msg-footer');
            if (footer && role === 'operator') {
                footer.innerHTML = '';
                if (status === 'printed') {
                    let btn = document.createElement('button');
                    btn.className = 'btn btn-outline btn-mini btn-reprint';
                    btn.innerText = 'üîÑ CETAK ULANG';
                    btn.dataset.msgId = msgId;
                    btn.style.flex = '1';
                    btn.style.borderColor = 'var(--warning)';
                    btn.style.color = 'var(--warning)';
                    footer.appendChild(btn);
                } else {
                    let printBtn = document.createElement('button');
                    printBtn.className = 'btn btn-success btn-mini btn-print';
                    printBtn.innerText = 'üñ®Ô∏è CETAK';
                    printBtn.dataset.msgId = msgId;
                    printBtn.style.flex = '2';
                    footer.appendChild(printBtn);
                    let selectBtn = document.createElement('button');
                    selectBtn.className = `btn ${selectedInboxes.includes(msgId) ? 'btn-primary' : 'btn-outline'} btn-mini btn-toggle`;
                    selectBtn.innerText = selectedInboxes.includes(msgId) ? '‚úÖ READY' : '‚ûï BATCH';
                    selectBtn.dataset.msgId = msgId;
                    selectBtn.style.flex = '1';
                    footer.appendChild(selectBtn);
                }
            }
        }

        function toggleSelect(id) {
            if (selectedInboxes.includes(id)) selectedInboxes = selectedInboxes.filter(x => x !== id);
            else selectedInboxes.push(id);
            document.getElementById('batch-count').innerText = `${selectedInboxes.length} ITEM DIPILIH`;
            let card = document.getElementById(`msg-${id}`);
            if (card) {
                card.classList.toggle('selected', selectedInboxes.includes(id));
                let btn = card.querySelector('.btn-toggle');
                if (btn) {
                    btn.className = `btn ${selectedInboxes.includes(id) ? 'btn-primary' : 'btn-outline'} btn-mini btn-toggle`;
                    btn.innerText = selectedInboxes.includes(id) ? '‚úÖ READY' : '‚ûï BATCH';
                }
            }
        }

        // ---------- FORWARD ----------
        function forwardToOperator(msgId) {
            db.transaction('stream').objectStore('stream').get(msgId).onsuccess = e => {
                let msg = e.target.result;
                if (!msg) return alert('‚ùå Data tidak ditemukan!');
                if (!activeConns.length) return alert('‚ùå Tidak ada koneksi ke Operator!');
                let fwd = {
                    type: 'job',
                    jobs: msg.jobs,
                    id: Date.now(),
                    senderRole: 'designer',
                    senderId: myId,
                    status: 'pending',
                    originalFrom: msg.senderId
                };
                activeConns.forEach(c => { if (c.open) c.send(fwd); });
                let outData = {
                    ...fwd,
                    direction: 'out',
                    to: activeConns.map(c => c.peer).join(', '),
                    hidden: false,
                    reprintCount: 0,
                    status: 'pending'
                };
                saveStream(outData);
                msg.jobs.forEach(job => saveHistory({
                    inv: job.inv,
                    cap: job.cap,
                    typeLabel: 'DSN_SEND',
                    partner: activeConns.map(c => c.peer).join(', ')
                }));
                showToast('üì§ Data diteruskan ke Operator!', 'success');
                let card = createMessageCard(outData);
                let area = document.getElementById('stream-area');
                let lm = area.querySelector('.load-more-container');
                if (lm) lm.remove();
                area.insertBefore(card, area.firstChild);
            };
        }

        // ---------- FILTER ----------
        function setTimelineFilter(f, btn) {
            timelineFilter = f;
            document.querySelectorAll('#filter-bar .btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderStream(true);
        }

        // ---------- PRINT ENGINE ----------
        function openPrintSingle(id) {
            db.transaction('stream').objectStore('stream').get(id).onsuccess = e => {
                let d = e.target.result;
                if (!d) return;
                let files = [];
                d.jobs.forEach(j => j.files.forEach(f => files.push({ ...f, inv: j.inv })));
                openPrintLogic({ files, internalId: id, senderId: d.senderId });
            };
        }

        function openPrintLogic(job) {
            activeJob = job;
            document.getElementById('modal-print').style.display = 'flex';
            document.getElementById('p-img').src = job.files[0].thumb;
            document.getElementById('p-pdf-badge').style.display = job.files[0].isPdf ? 'block' : 'none';
            document.getElementById('p-inv-edit').value = job.files[0].inv;
            switchPrintMode(job.files[0].isPdf ? 'full' : 'grid');
        }

        function switchPrintMode(m) {
            currentPrintMode = m;
            document.getElementById('mode-full-btn').className = `btn btn-outline ${m === 'full' ? 'active' : ''}`;
            document.getElementById('mode-grid-btn').className = `btn btn-outline ${m === 'grid' ? 'active' : ''}`;
            document.getElementById('grid-controls').style.display = m === 'grid' ? 'block' : 'none';
            calcGrid();
        }

        function toggleCustomPaper(v) {
            document.getElementById('custom-paper-box').style.display = v === 'custom' ? 'flex' : 'none';
            calcGrid();
        }

        function calcGrid() {
            if (currentPrintMode !== 'grid') { document.getElementById('grid-res-box').innerText = 'FULL PAGE MODE'; return; }
            let pw, ph, pp = document.getElementById('p-pdf-paper').value;
            if (pp === 'custom') { pw = parseFloat(document.getElementById('p-custom-w').value) || 0; ph = parseFloat(document.getElementById('p-custom-h').value) || 0; }
            else { let p = pp.split(','); pw = parseFloat(p[0]); ph = parseFloat(p[1]); }
            let w = parseFloat(document.getElementById('p-grid-w').value) || 1;
            let h = parseFloat(document.getElementById('p-grid-h').value) || 1;
            let gap = parseFloat(document.getElementById('p-grid-gap').value) || 0;
            let target = parseInt(document.getElementById('p-pdf-target').value) || 1;
            let nx = Math.floor((pw + gap) / (w + gap));
            let ny = Math.floor((ph + gap) / (h + gap));
            document.getElementById('grid-res-box').innerText = `üìê ${nx*ny} pcs/lbr | TOTAL: ${nx*ny*target} pcs`;
        }

        async function physicalRotate() {
            let f = activeJob.files[0];
            if (f.isPdf) return;
            let img = new Image();
            img.src = f.data;
            await img.decode();
            let cvs = document.createElement('canvas');
            cvs.width = img.height;
            cvs.height = img.width;
            let ctx = cvs.getContext('2d');
            ctx.translate(cvs.width / 2, cvs.height / 2);
            ctx.rotate(90 * Math.PI / 180);
            ctx.drawImage(img, -img.width / 2, -img.height / 2);
            f.data = f.thumb = cvs.toDataURL('image/jpeg', 0.9);
            document.getElementById('p-img').src = f.thumb;
            let ow = document.getElementById('p-grid-w').value;
            document.getElementById('p-grid-w').value = document.getElementById('p-grid-h').value;
            document.getElementById('p-grid-h').value = ow;
            calcGrid();
        }

        function executePrint() {
            if (currentPrintMode === 'full') executeFullPrint();
            else executeGridPrint();
        }

        async function executeFullPrint() {
            let btn = document.getElementById('btn-do-print');
            btn.innerText = '‚è≥ RENDERING...';
            btn.disabled = true;
            try {
                let pw, ph, pp = document.getElementById('p-pdf-paper').value;
                if (pp === 'custom') { pw = document.getElementById('p-custom-w').value; ph = document.getElementById('p-custom-h').value; }
                else { let p = pp.split(','); pw = p[0]; ph = p[1]; }
                let target = parseInt(document.getElementById('p-pdf-target').value) || 1;
                let mat = document.getElementById('p-mat').value;
                let inv = document.getElementById('p-inv-edit').value;
                let html = `<style>
                    @page { size: ${pw}cm ${ph}cm; margin:0; }
                    body { margin:0; }
                    .sheet { width: ${pw}cm; height: ${ph}cm; page-break-after:always; display:flex; flex-direction:column; align-items:center; justify-content:center; }
                    .p-img { width:100%; height:calc(100% - 1.2cm); object-fit:contain; }
                    .footer { height:1.2cm; font-size:11pt; font-family:sans-serif; font-weight:bold; display:flex; align-items:center; justify-content:center; border-top:1px solid #eee; }
                </style>`;
                let content = '';
                for (let f of activeJob.files) {
                    let img = f.isPdf ? await getPdfPreview(f.data, true) : f.data;
                    for (let i = 0; i < target; i++) content += `<div class="sheet"><img src="${img}" class="p-img"><div class="footer">${inv} - ${mat}</div></div>`;
                }
                finishPrint(html + content, inv, target, 'FULL PAGE');
            } catch (e) {
                alert('‚ùå Gagal render!');
                btn.innerText = 'üñ®Ô∏è MULAI CETAK';
                btn.disabled = false;
            }
        }

        function executeGridPrint() {
            let btn = document.getElementById('btn-do-print');
            btn.innerText = '‚è≥ PROSES GRID...';
            btn.disabled = true;
            let pw, ph, pp = document.getElementById('p-pdf-paper').value;
            if (pp === 'custom') { pw = parseFloat(document.getElementById('p-custom-w').value); ph = parseFloat(document.getElementById('p-custom-h').value); }
            else { let p = pp.split(','); pw = parseFloat(p[0]); ph = parseFloat(p[1]); }
            let w = parseFloat(document.getElementById('p-grid-w').value);
            let h = parseFloat(document.getElementById('p-grid-h').value);
            let gap = parseFloat(document.getElementById('p-grid-gap').value) || 0;
            let target = parseInt(document.getElementById('p-pdf-target').value) || 1;
            let inv = document.getElementById('p-inv-edit').value;
            let mat = document.getElementById('p-mat').value;
            let kt = parseFloat(document.getElementById('p-grid-kres-thick').value) || 0.2;
            let kl = parseFloat(document.getElementById('p-grid-kres-len').value) || 5;

            let nx = Math.floor((pw + gap) / (w + gap));
            let ny = Math.floor((ph + gap) / (h + gap));
            let halfGap = gap / 2;

            const mk = (t, l, dir) => {
                let hh = kt / 2;
                let hStyle = `position:absolute; top:-${hh}mm; width:${kl}mm; height:${kt}mm; background:#000;`;
                let vStyle = `position:absolute; left:-${hh}mm; width:${kt}mm; height:${kl}mm; background:#000;`;
                let parts = '';
                if (dir.includes('r')) parts += `<div style="${hStyle} left:0;"></div>`;
                if (dir.includes('l')) parts += `<div style="${hStyle} left:-${kl}mm;"></div>`;
                if (dir.includes('d')) parts += `<div style="${vStyle} top:0;"></div>`;
                if (dir.includes('u')) parts += `<div style="${vStyle} top:-${kl}mm;"></div>`;
                return `<div style="position:absolute; top:${t}; left:${l}; width:0; height:0; z-index:100;">${parts}</div>`;
            };

            let html = `<style>
                @page { size: ${pw}cm ${ph}cm; margin:0; }
                body { margin:0; }
                .sheet { width: ${pw}cm; height: ${ph}cm; display:flex; align-items:center; justify-content:center; page-break-after:always; position:relative; }
                .grid-container { display:grid; grid-template-columns:repeat(${nx}, ${w}cm); grid-gap:${gap}cm; position:relative; }
                .cell { position:relative; width:${w}cm; height:${h}cm; }
                .cell img { width:100%; height:100%; object-fit:fill; }
                .footer { position:absolute; bottom:0.3cm; width:100%; text-align:center; font-weight:bold; font-family:sans-serif; font-size:10pt; }
            </style>`;

            let cells = '';
            for (let row = 0; row < ny; row++) {
                for (let col = 0; col < nx; col++) {
                    let offset = halfGap > 0 ? `-${halfGap}cm` : '0';
                    const getType = (r, c) => {
                        if (r === 0 && c === 0) return 'rd';
                        if (r === 0 && c === nx) return 'ld';
                        if (r === ny && c === 0) return 'ru';
                        if (r === ny && c === nx) return 'lu';
                        if (r === 0) return 'lrd';
                        if (r === ny) return 'lru';
                        if (c === 0) return 'rdu';
                        if (c === nx) return 'ldu';
                        return 'lrdu';
                    };
                    let marks = mk(offset, offset, getType(row, col));
                    if (col === nx - 1) marks += mk(offset, `calc(100% + ${halfGap}cm)`, getType(row, col + 1));
                    if (row === ny - 1) {
                        marks += mk(`calc(100% + ${halfGap}cm)`, offset, getType(row + 1, col));
                        if (col === nx - 1) marks += mk(`calc(100% + ${halfGap}cm)`, `calc(100% + ${halfGap}cm)`, getType(row + 1, col + 1));
                    }
                    cells += `<div class="cell"><img src="${activeJob.files[0].data}">${marks}</div>`;
                }
            }
            let content = '';
            for (let i = 0; i < target; i++) content += `<div class="sheet"><div class="grid-container">${cells}</div><div class="footer">${inv} - ${mat}</div></div>`;
            finishPrint(html + content, inv, target, `GRID (${nx*ny}x${target})`);
        }

        function finishPrint(fullHtml, inv, qty, mode) {
            let f = document.getElementById('p-frame');
            f.style.display = 'block';
            f.contentWindow.document.open();
            f.contentWindow.document.write(fullHtml);
            f.contentWindow.document.close();

            setTimeout(() => {
                f.contentWindow.print();
                f.style.display = 'none';
                document.getElementById('btn-do-print').innerText = 'üñ®Ô∏è MULAI CETAK';
                document.getElementById('btn-do-print').disabled = false;

                // Cetak dari pesan (memiliki internalId)
                if (activeJob.internalId) {
                    db.transaction('stream', 'readwrite').objectStore('stream').get(activeJob.internalId).onsuccess = e => {
                        let d = e.target.result;
                        if (!d) return;
                        let previousStatus = d.status;
                        let isLocalJob = (d.from === 'LOKAL (MANUAL)' || d.senderId === myId);
                        if (d.status === 'printed') {
                            d.reprintCount = (d.reprintCount || 0) + 1;
                        } else {
                            d.status = 'printed';
                            d.reprintCount = 0;
                        }
                        db.transaction('stream', 'readwrite').objectStore('stream').put(d).onsuccess = () => {
                            let idx = streamCache.findIndex(m => m.id === activeJob.internalId);
                            if (idx !== -1) {
                                streamCache[idx].status = d.status;
                                streamCache[idx].reprintCount = d.reprintCount;
                            }
                            updateMessageCardStatus(activeJob.internalId, d.status, d.reprintCount);
                            // Hapus card inbox hanya jika job dari peer dan ini cetak pertama
                            if (!isLocalJob && previousStatus !== 'printed') {
                                let card = document.getElementById(`msg-${activeJob.internalId}`);
                                if (card) card.remove();
                            }
                            // Tampilkan di DATA CETAK jika filter 'printed' aktif dan ini cetak pertama
                            if (timelineFilter === 'printed' && previousStatus !== 'printed') {
                                let newCard = createMessageCard(d);
                                let area = document.getElementById('stream-area');
                                area.insertBefore(newCard, area.firstChild);
                            }
                            showToast(`üñ®Ô∏è Cetak berhasil${previousStatus === 'printed' ? ' (Reprint)' : ''}`, 'success');
                        };
                    };
                    // Kirim status update ke pengirim
                    let conn = activeConns.find(x => x.peer === activeJob.senderId);
                    if (conn && activeJob.senderId && activeJob.senderId !== myId) {
                        conn.send({ type: 'status_update', msgId: activeJob.internalId });
                    }
                }
                // Cetak job lokal (manual)
                else if (role === 'operator') {
                    // Cari apakah job dengan file dan invoice yang sama sudah pernah dicetak
                    let existingLocalJob = streamCache.find(msg =>
                        msg.from === 'LOKAL (MANUAL)' &&
                        msg.jobs && msg.jobs[0] &&
                        msg.jobs[0].inv === inv &&
                        msg.jobs[0].files && msg.jobs[0].files[0] &&
                        msg.jobs[0].files[0].data === activeJob.files[0].data
                    );
                    if (existingLocalJob) {
                        // Cetak ulang job lokal
                        existingLocalJob.reprintCount = (existingLocalJob.reprintCount || 0) + 1;
                        existingLocalJob.status = 'printed';
                        db.transaction('stream', 'readwrite').objectStore('stream').put(existingLocalJob);
                        let idx = streamCache.findIndex(m => m.id === existingLocalJob.id);
                        if (idx !== -1) streamCache[idx] = existingLocalJob;
                        updateMessageCardStatus(existingLocalJob.id, 'printed', existingLocalJob.reprintCount);
                        showToast(`üîÑ Cetak ulang (reprint #${existingLocalJob.reprintCount}) untuk invoice ${inv}`, 'success');
                    } else {
                        // Cetak pertama job lokal
                        let localJob = {
                            id: Date.now(),
                            direction: 'in',
                            from: 'LOKAL (MANUAL)',
                            senderRole: 'operator',
                            senderId: myId,
                            status: 'printed',
                            reprintCount: 0,
                            jobs: [{ inv, cap: mode, files: activeJob.files }],
                            hidden: false
                        };
                        saveStream(localJob);
                        showToast('‚úÖ Cetak selesai! Data masuk ke DATA CETAK.', 'success');
                        if (timelineFilter === 'printed') {
                            let newCard = createMessageCard(localJob);
                            let area = document.getElementById('stream-area');
                            area.insertBefore(newCard, area.firstChild);
                        }
                    }
                }

                // Simpan history
                saveHistory({
                    inv,
                    typeLabel: 'PRODUKSI_SELESAI',
                    qty,
                    cap: mode,
                    partner: activeJob.internalId ? activeJob.senderId : 'MANUAL'
                });

                playSound('done-sound');
                closeModal();
            }, 1000);
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        // ---------- BATCH PRINT ----------
        function openBatchPrint() {
            if (!selectedInboxes.length) return alert('‚ö†Ô∏è Pilih item batch!');
            let allFiles = [], count = 0;
            selectedInboxes.forEach(id => {
                db.transaction('stream').objectStore('stream').get(id).onsuccess = e => {
                    e.target.result.jobs.forEach(j => j.files.forEach(f => { if (f.isPdf) allFiles.push({ ...f, inv: j.inv }); }));
                    count++;
                    if (count === selectedInboxes.length) openPrintLogic({ files: allFiles, internalId: null });
                };
            });
        }

        // ---------- HISTORY ----------
        function saveHistory(obj) {
            db.transaction('history', 'readwrite').objectStore('history').add({
                time: new Date().toLocaleString('id-ID'),
                inv: obj.inv || '-',
                cap: obj.cap || '-',
                partner: obj.partner || '?',
                typeLabel: obj.typeLabel,
                role: role,
                qty: obj.qty || 1
            });
            trimHistory();
        }

        function trimHistory() {
            if (!db) return;
            let tx = db.transaction('history', 'readwrite');
            let store = tx.objectStore('history');
            store.count().onsuccess = e => {
                if (e.target.result > 1000) {
                    store.openCursor().onsuccess = ev => {
                        let cur = ev.target.result, del = 0;
                        while (cur && del < 200) {
                            store.delete(cur.primaryKey);
                            cur.continue();
                            del++;
                        }
                    };
                }
            };
        }

        function refreshHistBody() {
            let tbody = document.getElementById('hist-body');
            tbody.innerHTML = '';
            let statusMap = {
                'ADM_SEND': 'Admin ‚Üí Designer',
                'DSN_RECV': 'Admin ‚Üí Designer',
                'DSN_SEND': 'Designer ‚Üí Operator',
                'OP_RECV': 'Designer ‚Üí Operator',
                'PRODUKSI_SELESAI': '',
                'OP_PROD': ''
            };
            db.transaction('history').objectStore('history').getAll().onsuccess = e => {
                let all = e.target.result.reverse();
                let rendered = 0, MAX = 100;
                all.forEach(h => {
                    let show = false;
                    if (role === 'admin' && h.typeLabel === 'ADM_SEND') show = true;
                    else if (role === 'designer') {
                        if (currentTab === 1 && h.typeLabel === 'DSN_RECV') show = true;
                        if (currentTab === 2 && h.typeLabel === 'DSN_SEND') show = true;
                    } else if (role === 'operator') {
                        if (currentTab === 1 && h.typeLabel === 'OP_RECV') show = true;
                        if (currentTab === 2 && (h.typeLabel === 'PRODUKSI_SELESAI' || h.typeLabel === 'OP_PROD')) show = true;
                    }
                    if (!show || rendered >= MAX) return;
                    let row = tbody.insertRow();
                    row.style.fontSize = '0.75rem';
                    row.insertCell().innerHTML = h.time || '';
                    let statusCell = row.insertCell();
                    statusCell.innerHTML = (h.typeLabel === 'PRODUKSI_SELESAI' || h.typeLabel === 'OP_PROD') ? '' : (statusMap[h.typeLabel] || h.typeLabel);
                    let partnerCell = row.insertCell();
                    partnerCell.innerHTML = (h.typeLabel === 'PRODUKSI_SELESAI' || h.typeLabel === 'OP_PROD') ? '' : (h.partner || '?');
                    row.insertCell().innerHTML = `<span style="color:var(--accent); font-weight:700;">${h.inv || '-'}</span>`;
                    row.insertCell().innerHTML = `<div style="color:var(--text-dim);">${h.cap || ''}</div>`;
                    let qtyCell = row.insertCell();
                    qtyCell.innerHTML = (h.typeLabel === 'PRODUKSI_SELESAI' || h.typeLabel === 'OP_PROD') ? `<span style="color:var(--success); font-weight:800;">${h.qty || 1}</span>` : '';
                    let aksiCell = row.insertCell();
                    aksiCell.innerHTML = `<button class="btn btn-mini btn-danger btn-outline" style="border:none;" onclick="deleteHistory(${h.id})">üóëÔ∏è DEL</button>`;
                    rendered++;
                });
                if (rendered === 0) tbody.innerHTML = `<tr><td colspan="7" style="padding:30px; text-align:center; color:var(--text-dim);">üì≠ Belum ada data</td></tr>`;
            };
        }

        function switchHistTab(n) {
            currentTab = n;
            document.querySelectorAll('.hist-tab-btn').forEach((b, i) => b.classList.toggle('active', i === n - 1));
            refreshHistBody();
        }

        function toggleHistory() {
            let m = document.getElementById('modal-hist');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
            if (m.style.display === 'flex') {
                document.getElementById('hist-role-title').innerText = role.toUpperCase();
                switchHistTab(1);
            }
        }

        function deleteHistory(id) {
            db.transaction('history', 'readwrite').objectStore('history').delete(id).onsuccess = () => refreshHistBody();
        }

        function clearAllHistory() {
            if (confirm('üóëÔ∏è Hapus semua log?')) {
                let tx = db.transaction('history', 'readwrite');
                tx.objectStore('history').openCursor().onsuccess = e => {
                    let c = e.target.result;
                    if (c && c.value.role === role) c.delete();
                    c?.continue();
                };
                setTimeout(refreshHistBody, 300);
            }
        }

        async function exportLogToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`KERTASES FLOW - PRODUCTION LOG (${role.toUpperCase()})`, 14, 15);
            const table = document.getElementById('hist-table-real');
            const headers = [];
            const headerCells = table.querySelectorAll('thead tr th');
            for (let i = 0; i < headerCells.length - 1; i++) headers.push(headerCells[i].innerText);
            const rows = [];
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                let rowData = [];
                let cells = row.querySelectorAll('td');
                for (let i = 0; i < cells.length - 1; i++) rowData.push(cells[i].innerText);
                rows.push(rowData);
            });
            doc.autoTable({
                head: [headers],
                body: rows,
                margin: { top: 25 },
                styles: { fontSize: 8 },
                headStyles: { fillColor: [99, 102, 241] }
            });
            doc.save('log_kertases.pdf');
        }

        // ---------- UTILS ----------
        async function getPdfPreview(b64, high = false) {
            try {
                let pdf = await pdfjsLib.getDocument({ data: atob(b64.split(',')[1]) }).promise;
                let page = await pdf.getPage(1);
                let viewport = page.getViewport({ scale: high ? 3.0 : 0.5 });
                let canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                return canvas.toDataURL('image/jpeg', high ? 0.9 : 0.5);
            } catch (e) {
                return null;
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function downloadAsset(data, name) {
            let a = document.createElement('a');
            a.href = data;
            a.download = name;
            a.click();
        }

        function clearTimeline() {
            if (confirm('üóëÔ∏è Hapus semua data timeline?')) {
                db.transaction('stream', 'readwrite').objectStore('stream').clear().onsuccess = () => {
                    streamCache = [];
                    renderStream(true);
                };
            }
        }

        // ---------- MANUAL LAYOUTER ----------
        function openManualLayouter() {
            document.getElementById('modal-manual-layout').style.display = 'grid';
            updatePaperCanvas();
        }
        function closeManualLayouter() { document.getElementById('modal-manual-layout').style.display = 'none'; }

        async function handleManualUpload(input) {
            for (let f of input.files) {
                let d = await toBase64(f);
                manualSources.push({ id: Date.now() + Math.random(), data: d, name: f.name });
            }
            renderManualSourceList();
        }

        function renderManualSourceList() {
            let list = document.getElementById('manual-source-list');
            list.innerHTML = '';
            if (!manualSources.length) {
                list.innerHTML = '<div style="grid-column:1/-1; padding:30px; text-align:center; opacity:0.3;">üñºÔ∏è<br>NO ASSETS</div>';
                return;
            }
            manualSources.forEach((s, idx) => {
                let card = document.createElement('div');
                card.className = 'asset-card';
                card.onclick = () => addToCanvas(s.id);
                card.innerHTML = `<div class="asset-thumb"><img src="${s.data}"></div>
                                 <div class="asset-info"><span class="asset-name">${s.name}</span>
                                 <span class="asset-del" onclick="event.stopPropagation(); manualSources.splice(${idx},1); renderManualSourceList();">üóëÔ∏è</span></div>`;
                list.appendChild(card);
            });
        }

        function updatePaperCanvas() {
            let p = document.getElementById('paper-canvas');
            let dim = document.getElementById('m-paper').value.split(',');
            let scale = 10;
            p.style.width = (dim[0] * scale) + 'px';
            p.style.minHeight = (dim[1] * scale) + 'px';
            p.style.height = 'auto';
            renderCanvasItems();
        }

        function addToCanvas(srcId) {
            let src = manualSources.find(s => s.id === srcId);
            let w = parseFloat(document.getElementById('m-w').value);
            let h = parseFloat(document.getElementById('m-h').value);
            let rot = parseInt(document.getElementById('m-rot').value);
            let gap = parseFloat(document.getElementById('m-gap').value) || 0;
            let paperDim = document.getElementById('m-paper').value.split(',');
            let pW = parseFloat(paperDim[0]);
            let renderW = (rot === 90 || rot === 270) ? h : w;
            let renderH = (rot === 90 || rot === 270) ? w : h;
            if (currentX + renderW > pW) {
                currentX = 0;
                currentY += maxRowH + gap;
                maxRowH = 0;
            }
            canvasItems.push({
                id: Date.now(),
                srcId,
                data: src.data,
                x: currentX,
                y: currentY,
                w, h, rot,
                renderW, renderH
            });
            currentX += renderW + gap;
            if (renderH > maxRowH) maxRowH = renderH;
            renderCanvasItems();
        }

        function renderCanvasItems() {
            let p = document.getElementById('paper-canvas');
            let scale = 10;
            p.innerHTML = '';
            canvasItems.forEach((item, idx) => {
                let d = document.createElement('div');
                d.className = 'canvas-item';
                d.style.left = (item.x * scale) + 'px';
                d.style.top = (item.y * scale) + 'px';
                d.style.width = (item.renderW * scale) + 'px';
                d.style.height = (item.renderH * scale) + 'px';
                d.innerHTML = `<div style="position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; overflow:visible;">
                    <img src="${item.data}" style="width:${item.w * scale}px; height:${item.h * scale}px; transform:rotate(${item.rot}deg); object-fit:fill;">
                    <div class="item-del" onclick="canvasItems.splice(${idx},1); renderCanvasItems();">√ó</div>
                </div>`;
                p.appendChild(d);
            });
        }

        function clearManualCanvas() {
            canvasItems = [];
            currentX = 0; currentY = 0; maxRowH = 0;
            renderCanvasItems();
        }

        function printManualCanvas() {
            if (!canvasItems.length) return alert('‚ö†Ô∏è Canvas kosong!');
            let dim = document.getElementById('m-paper').value.split(',');
            let pw = parseFloat(dim[0]), ph = parseFloat(dim[1]);
            let useKres = document.getElementById('m-use-kres').checked;
            let tebal = parseFloat(document.getElementById('m-kres-tebal').value) || 0.2;
            let panjang = parseFloat(document.getElementById('m-kres-panjang').value) || 5;
            let kThick = tebal + 'mm', kLen = panjang + 'mm', kOff = '2mm';
            let html = `<style>
                @page { size: ${pw}cm ${ph}cm; margin:0; }
                body { margin:0; padding:0; background:white; width:${pw}cm; min-height:${ph}cm; }
                .page-container { position:relative; width:${pw}cm; height:${ph}cm; overflow:hidden; }
                .k-mark { position:absolute; background:#000; }
                .k-v { width:${kThick}; height:${kLen}; }
                .k-h { height:${kThick}; width:${kLen}; }
                .tl-v { bottom:100%; left:0; margin-bottom:${kOff}; }
                .tl-h { right:100%; top:0; margin-right:${kOff}; }
                .tr-v { bottom:100%; right:0; margin-bottom:${kOff}; }
                .tr-h { left:100%; top:0; margin-left:${kOff}; }
                .bl-v { top:100%; left:0; margin-top:${kOff}; }
                .bl-h { right:100%; bottom:0; margin-right:${kOff}; }
                .br-v { top:100%; right:0; margin-top:${kOff}; }
                .br-h { left:100%; bottom:0; margin-left:${kOff}; }
                .img-wrap { position:absolute; display:flex; align-items:center; justify-content:center; }
            </style><div class="page-container">`;
            canvasItems.forEach(item => {
                if (useKres) {
                    html += `<div class="k-mark k-v tl-v"></div><div class="k-mark k-h tl-h"></div>
                             <div class="k-mark k-v tr-v"></div><div class="k-mark k-h tr-h"></div>
                             <div class="k-mark k-v bl-v"></div><div class="k-mark k-h bl-h"></div>
                             <div class="k-mark k-v br-v"></div><div class="k-mark k-h br-h"></div>`;
                }
                html += `<div class="img-wrap" style="left:${item.x}cm; top:${item.y}cm; width:${item.renderW}cm; height:${item.renderH}cm;">
                            <img src="${item.data}" style="width:${item.w}cm; height:${item.h}cm; transform:rotate(${item.rot}deg); object-fit:fill;">
                         </div>`;
            });
            html += '</div>';
            let f = document.getElementById('p-frame');
            f.style.display = 'block';
            f.contentWindow.document.open();
            f.contentWindow.document.write(html);
            f.contentWindow.document.close();
            let btn = document.querySelector('#modal-manual-layout .btn-success');
            let oldText = btn.innerText;
            btn.innerText = '‚è≥ RENDERING...';
            setTimeout(() => {
                f.contentWindow.print();
                f.style.display = 'none';
                btn.innerText = oldText;
            }, 1000);
        }

        // ---------- INITIALIZATION ----------
        reinitializeLoginListeners();
        window.addEventListener('online', () => {
            if (localStorage.getItem('kts_mode') === 'cloud' && peer) peer.reconnect?.();
        });
        window.addEventListener('offline', () => alert('‚ö†Ô∏è Internet putus. Gunakan mode LOCAL LAN.'));
    </script>
</body>
</html>
