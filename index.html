<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertases Pro V15.3 - Professional Production Flow</title>

    <!-- Library Lokal & CDN (Lengkap) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@300;400;500;600&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0a0f1d; --panel: rgba(21, 32, 54, 0.9); --border: rgba(255, 255, 255, 0.1);
            --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981; --danger: #f43f5e; --warning: #f59e0b;
            --text: #f8fafc; --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; }
        body, html {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.1) 0%, transparent 40%);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* UI Elements */
        .glass-panel { background: var(--panel); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 20px !important; }
        
        .cyber-input { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); 
            border-radius: 12px !important; 
            color: #fff; padding: 12px 14px; font-size: 0.85rem; width: 100%; 
        }
        .cyber-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

        .btn {
            border-radius: 12px !important; 
            border: none; padding: 10px 18px; cursor: pointer;
            font-weight: 600; font-family: 'Outfit', sans-serif; font-size: 0.8rem;
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--border); }
        .btn-mini { padding: 6px 12px; font-size: 0.7rem; border-radius: 8px !important; }

        .filter-bar .btn.active {
            background: var(--accent) !important;
            color: white !important;
            border-color: var(--accent) !important;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: var(--bg); }
        .login-box { padding: 50px; text-align: center; max-width: 480px; width: 90%; border-radius: 30px !important; }
        .role-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; }
        .role-card { padding: 25px 10px; border: 1px solid var(--border); border-radius: 20px !important; cursor: pointer; background: rgba(255,255,255,0.02); transition: 0.3s; }
        .role-card:hover { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); transform: translateY(-5px); }

        /* Layout */
        #app-layout { display: none; height: 100vh; flex-direction: row; padding: 15px; gap: 15px; }
        .sidebar { width: 280px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        .main-view { flex: 1; display: grid; grid-template-columns: 1fr 350px; gap: 15px; height: 100%; overflow: hidden; }

        /* Timeline */
        .timeline { display: flex; flex-direction: column; overflow: hidden; }
        .timeline-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-bar { display: flex; gap: 5px; padding: 10px 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.1); overflow-x: auto; }
        .stream-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .batch-bar { 
            display: none; justify-content: space-between; align-items: center; 
            padding: 10px 20px; margin: 15px 15px 0 15px;
            background: rgba(16, 185, 129, 0.15); border: 1px solid var(--success);
            border-radius: 16px; gap: 15px; min-height: 50px;
        }

        /* Message Cards */
        .msg-card { 
            width: 100%; max-width: 450px; border-radius: 20px !important; 
            border: 1px solid var(--border); background: rgba(255,255,255,0.03); 
            position: relative; padding: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .msg-card.selected { border: 2px solid var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .msg-header { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.75rem; color: var(--text-dim); display: flex; justify-content: space-between; align-items: center; }
        .msg-body { padding: 15px; }
        
        .msg-card.printed { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .msg-card.in { align-self: flex-start; border-left: 4px solid var(--accent); }
        .msg-card.out { align-self: flex-end; border-right: 4px solid var(--accent); }

        .printed-badge { background: var(--success); color: #000; font-size: 0.6rem; font-weight: 800; padding: 2px 8px; border-radius: 10px; }
        .role-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 6px; background: var(--border); margin-left: 5px; text-transform: uppercase; }

        .card-edit-inv { background: transparent; border: none; border-bottom: 1px dashed var(--border); color: var(--accent); font-weight: 700; font-size: 1.1rem; width: 100%; margin-bottom: 5px; }
        .card-edit-cap { background: rgba(0,0,0,0.2); border: 1px solid transparent; color: var(--text-dim); font-size: 0.85rem; width: 100%; padding: 10px; border-radius: 12px !important; resize: none; min-height: 50px; }

        .thumb-row-wrap { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 12px !important; margin-top: 8px; }
        .thumb-box { width: 60px; height: 60px; background: #000; border-radius: 10px !important; overflow: hidden; border: 1px solid var(--border); position: relative; flex-shrink: 0; }
        .thumb-box img { width: 100%; height: 100%; object-fit: contain; }
        .pdf-tag { position: absolute; bottom: 2px; right: 2px; background: #f43f5e; color: white; font-size: 8px; padding: 1px 3px; border-radius: 3px; }

        /* Control Panel */
        .control-panel { overflow-y: auto; padding: 20px; }
        .job-row { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px !important; padding: 15px; position: relative; margin-bottom: 10px; }
        .job-row.checked { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { max-height: 90vh; overflow-y: auto; border-radius: 24px !important; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { padding: 15px; text-align: center; color: var(--accent); font-family: 'Outfit'; font-size: 0.75rem; border-bottom: 1px solid var(--border); }
        td { padding: 12px; text-align: center; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }

        .status-widget { padding: 15px; border-radius: 16px !important; border: 1px solid var(--border); background: rgba(0,0,0,0.3); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; background: #64748b; }
        .online .status-dot { background: var(--success); box-shadow: 0 0 10px var(--success); }

        #kts-prompt { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .kts-prompt-box { background:#152036; padding:30px; border-radius:24px !important; border:1px solid #6366f1; width:350px; text-align:center; box-shadow: 0 0 30px rgba(99,102,241,0.2); }

        .hist-tab-btn { flex:1; border:none; padding:10px; border-radius:10px; cursor:pointer; color: white; background: transparent; transition: 0.3s; }
        .hist-tab-btn.active { background: var(--accent); box-shadow: 0 4px 10px var(--accent-glow); }

        /* CSS BARU: MANUAL LAYOUTER */
        #modal-manual-layout { 
            display: none; position: fixed; inset: 0; background: var(--bg); z-index: 5000;
            grid-template-columns: 350px 1fr;
        }
       /* 1. SETTINGAN TEKS & INPUT (JADI LEUTIK & RAPIH) */
     .layout-sidebar label {
        font-size: 0.55rem !important; /* Tulisan Label Leutik Pisan */
        color: var(--text-dim);
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
        display: block;
        text-transform: uppercase;
    }
     .layout-sidebar input, 
    .layout-sidebar select {
        font-size: 0.7rem !important; /* Tulisan Input Sedeng */
        height: 28px !important;       /* Kotak Input Pendek */
        padding: 0 8px !important;
        border-radius: 6px !important;
    }
    
    /* Tombol-tombol di sidebar diperleutik saeutik */
    .layout-sidebar .btn {
        font-size: 0.7rem !important;
        padding: 6px 12px !important;
        height: auto !important;
    }
        .layout-main { 
            background: #000; display: flex; flex-direction: column; align-items: center; 
            padding: 40px; overflow-y: auto; position: relative;
        }
        .paper-canvas { 
            background: white; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transform-origin: top center; transition: 0.3s;
        }
        .canvas-item { position: absolute; border: 1px solid transparent; }
        .canvas-item:hover { border: 1px solid var(--accent); }
        .canvas-item .item-del {
            position: absolute; top: -10px; right: -10px; background: var(--danger);
            color: white; width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
            cursor: pointer; z-index: 10;
        }
        .source-thumb-card {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .source-thumb-card:hover { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); }
        /* --- TAMPILAN GRID MINIMALIS (ANYAR) --- */
    
    /* Wadah Daptar Gambar jadi Grid 3 Kolom */
/* 2. SETTINGAN GAMBAR (JADI 2 KOLOM = GEDE) */
    #manual-source-list {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important; /* Ieu kuncina: 2 Kolom (Kiri-Kanan) */
        gap: 10px !important;  /* Jarak antar gambar */
        align-content: start;
        padding-bottom: 20px;
    }


    /* Kartu Gambar Leutik */
    .source-thumb-card {
        flex-direction: column !important; /* Susunan ka handap */
        padding: 4px !important;
        height: 70px; /* Tinggi kartu dibatesan */
        justify-content: center;
        text-align: center;
        position: relative;
    }

    /* Gambar di jero kartu */
    .source-thumb-card img {
        width: 100% !important; 
        height: 40px !important; /* Ukuran gambar leutik */
        margin-bottom: 2px;
        border: none !important;
        background: transparent !important;
    }

    /* Tombol Hapus (X) di Pojok */
    .mini-del-btn {
        position: absolute;
        top: 2px; 
        right: 2px;
        width: 16px; height: 16px;
        background: var(--danger);
        color: white;
        border-radius: 50%;
        font-size: 10px;
        line-height: 16px;
        text-align: center;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    /* Ngaran File Leutik Pisan */
    .mini-label {
        font-size: 0.55rem; 
        color: var(--text-dim); 
        white-space: nowrap; 
        overflow: hidden; 
        width: 100%;
    }
    /* --- PROFESIONAL LAYOUTER SIDEBAR --- */

* Style Kotak Upload */
.upload-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.02);
    transition: 0.3s;
    margin-bottom: 15px;
}
.upload-zone:hover {
    border-color: var(--accent);
    background: rgba(99, 102, 241, 0.1);
}
.upload-icon { font-size: 1.5rem; margin-bottom: 5px; display: block; }
.upload-text { font-size: 0.7rem; color: var(--text-dim); letter-spacing: 1px; }

/* Grid Container (Gallery) */
#manual-source-list {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* Responsif */
    gap: 10px;
    align-content: start;
    padding-right: 5px;
}

/* Style Kartu Gambar */
 /* 3. TAMPILAN KARTU GAMBAR (ASSET CARD) */
    .asset-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        height: 120px !important; /* Kartu dijieun jangkung */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
    }

.asset-card:hover {
        border-color: var(--accent); /* Warna ungu mun disorot */
        transform: scale(1.02);      /* Ngagedean saeutik */
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

 /* Area Gambar (Dominan) */
    .asset-thumb {
        flex: 1; /* Gambar ngeusian sisa ruang */
        width: 100%;
        /* Motif Checkerboard (Catur) Transparan ala Photoshop */
        background-image: 
            linear-gradient(45deg, #151515 25%, transparent 25%), 
            linear-gradient(-45deg, #151515 25%, transparent 25%), 
            linear-gradient(45deg, transparent 75%, #151515 75%), 
            linear-gradient(-45deg, transparent 75%, #151515 75%);
        background-size: 10px 10px;
        background-color: #0b0b0b;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px; /* Padding supaya gambar teu nempel sisi teuing */
    }

  .asset-thumb img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Gambar pas, teu kapotong */
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); /* Kalangkang gambar */
    }

    /* Info Bar di Bawah (Ngaran & Hapus) */
    .asset-info {
        height: 24px !important;
        background: #080c16;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 8px;
    }
    
    .asset-name { 
        font-size: 0.6rem !important; 
        color: #94a3b8; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
        max-width: 80px;
    }
    
    .asset-del { 
        font-size: 0.7rem !important; 
        cursor: pointer; 
        color: var(--danger);
        opacity: 0.7;
    }
    .asset-del:hover { opacity: 1; transform: scale(1.2); }
    /* ==================================================
       FIX SCROLLING SIDEBAR (TAMBAHKEUN DI HANDAP)
       ================================================== */

    /* 1. SIDEBAR DIKONCI TINGGINA */
    .layout-sidebar {
        display: flex !important;
        flex-direction: column !important; /* Susunan ka handap */
        height: 100vh !important;        /* Tinggi Full Layar */
        max-height: 100vh !important;    /* Ulah leuwih ti layar */
        overflow: hidden !important;     /* Ulah scroll sidebar-na */
        padding-bottom: 20px !important; /* Mere napas handap saeutik */
    }

    /* 2. AREA TENGAH (GAMBAR) JADI SCROLLABLE */
    /* Ieu kuncina: "flex: 1" bakal ngeusian sisa ruang kosong */
    .layout-sidebar > div[style*="overflow-y:auto"] {
        flex: 1 !important;             /* Ngeusian rohangan kosong */
        overflow-y: auto !important;    /* Muncul scrollbar mun pinuh */
        min-height: 0 !important;       /* Trik CSS supaya scroll jalan bener */
        border-bottom: 1px solid var(--border); /* Garis batas */
        margin-bottom: 10px !important;
    }

    /* 3. TOMBOL PRINT TETEP DI HANDAP */
    .layout-sidebar > button.btn-success {
        flex-shrink: 0 !important;      /* Tombol moal jadi gepeng */
        margin-top: 0 !important;       /* Jarak diatur ku elemen luhurna */
        z-index: 10 !important;         /* Pastikeun aya di luhur */
    }
    </style>
</head>
<body>

    <!-- Manggil file lokal dina hiji folder -->
    <audio id="notif-sound" src="notif.mp3"></audio>
    <audio id="conn-sound" src="conn.mp3"></audio>
    <audio id="done-sound" src="done.mp3"></audio>

    <!-- PROMPT CUSTOM -->
    <div id="kts-prompt">
        <div class="kts-prompt-box">
            <h3 id="p-title" style="margin-top:0; font-family:'Outfit'; color:#6366f1;">Input Required</h3>
            <p id="p-desc" style="font-size:0.8rem; color:#94a3b8; margin-bottom:20px;"></p>
            <input type="text" id="p-val" class="cyber-input" style="text-align:center;">
            <div style="display:flex; gap:10px; margin-top:25px;">
                <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('kts-prompt').style.display='none'">CANCEL</button>
                <button class="btn btn-primary" style="flex:1" onclick="confirmKts()">OK</button>
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box glass-panel">
            <h1 style="font-family: 'Outfit'; font-size: 2.5rem; margin: 0; background: linear-gradient(to right, #6366f1, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">KERTASES PRO</h1>
            <p style="color: var(--text-dim); font-size: 0.85rem; letter-spacing: 3px;">PRODUCTION FLOW V15.3</p>
            
            <div class="role-grid">
                <div class="role-card" onclick="enterRole('admin')"><i>üï∂Ô∏è</i><span>ADMIN</span></div>
                <div class="role-card" onclick="enterRole('designer')"><i>üé®</i><span>DESIGNER</span></div>
                <div class="role-card" onclick="enterRole('operator')"><i>üñ®Ô∏è</i><span>OPERATOR</span></div>
            </div>

            <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                <button id="btn-cloud" class="btn btn-primary" onclick="setMode('cloud')">CLOUD</button>
                <button id="btn-local" class="btn btn-outline" onclick="setMode('local')">LOCAL LAN</button>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-layout">
        <div class="sidebar glass-panel">
            <div style="padding: 20px; text-align: center;">
                <div id="active-role-display" class="btn btn-primary btn-mini" style="border-radius: 20px !important; padding: 5px 20px;">---</div>
                <div id="status-widget" class="status-widget" style="margin-top: 20px; text-align: left;">
                    <div style="font-weight: 700; font-size: 0.8rem; display: flex; align-items: center;">
                        <span class="status-dot"></span> <span id="status-text">OFFLINE</span>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 8px; cursor: pointer; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 10px;" onclick="changeId()">
                        MY ID: <span id="my-id-display" style="color: var(--accent); font-weight: bold;">...</span>
                    </div>
                </div>
            </div>

            <div style="padding: 0 20px;">
                <label style="font-size: 0.65rem; color: var(--text-dim); display: block; margin-bottom: 5px;">CONNECT PARTNER:</label>
                <input type="text" id="target-id" class="cyber-input" placeholder="ID partner...">
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="connectMulti()">LINK CONNECT</button>
            </div>
            
            <div id="active-conns" style="padding: 10px 20px; flex: 1; overflow-y: auto;"></div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-success btn-mini" style="width: 100%; margin-bottom: 8px;" onclick="location.reload()">üîÑ REFRESH SYSTEM</button>
                <button class="btn btn-outline" style="width: 100%; color: var(--accent); border-color: var(--accent);" onclick="toggleHistory()">PRODUCTION LOG</button>
                <button class="btn btn-mini btn-outline" style="width: 100%; margin-top: 10px; border:none; color: var(--danger);" onclick="doLogout()">LOGOUT</button>
            </div>
        </div>

        <div class="main-view">
            <!-- TIMELINE -->
            <div class="timeline glass-panel">
                <div id="batch-bar" class="batch-bar">
                    <span id="batch-count" style="font-size: 0.75rem; font-weight: 700;">0 ITEM DIPILIH</span>
                    <button class="btn btn-success btn-mini" onclick="openBatchPrint()">PROSES BATCH PDF</button>
                </div>
                <div class="timeline-header">
                    <span style="font-weight: 700; font-family: 'Outfit';">TIMELINE FLOW</span>
                    <button class="btn btn-danger btn-mini" onclick="clearTimeline()">CLEAR</button>
                </div>
                
                <div class="filter-bar">
                    <button class="btn btn-mini btn-outline active" onclick="setTimelineFilter('all', this)">ALL</button>
                    <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('admin', this)">FROM ADMIN</button>
                    <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('designer', this)">FROM DESIGNER</button>
                    <button class="btn btn-mini btn-outline" onclick="setTimelineFilter('printed', this)">DATA CETAK</button>
                </div>

                <div id="stream-area" class="stream-area"></div>
            </div>

            <!-- CONTROL PANEL -->
            <div class="control-panel glass-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-weight: 700; font-family: 'Outfit';">TRANSMIT ASSETS</span>
                        <button id="btn-open-layouter" class="btn btn-mini btn-outline" style="display:none;" onclick="openManualLayouter()">üß©</button>
                    </div>
                    <button class="btn btn-mini btn-outline" onclick="toggleSelectAllRows()">ALL</button>
                </div>
                <div id="job-list"></div>
                <button class="btn btn-outline" style="border-style: dashed; width: 100%; border-radius: 12px !important;" onclick="addNewJob()">+ ADD DATA ROW</button>
                <button id="btn-action-main" class="btn btn-primary" style="width: 100%; margin-top: 15px; height: 50px;" onclick="mainAction()">PROCESS DATA</button>
                <input type="file" id="job-file-in" multiple style="display:none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>

    <!-- MODAL: MANUAL LAYOUTER (OPERATOR) -->
    <div id="modal-manual-layout">
       <div class="layout-sidebar glass-panel" style="padding: 15px; width: 300px;">
    
    <!-- HEADER -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid var(--border);">
        <button class="btn btn-mini btn-outline" style="padding:4px 8px; font-size:0.6rem;" onclick="closeManualLayouter()">‚¨ÖÔ∏è BACK</button>
        <span style="font-family:'Outfit'; color:var(--accent); font-weight:bold; font-size:0.8rem;">LAYOUTER</span>
    </div>

    <!-- 1. UPLOAD (Compact) -->
    <div class="upload-zone" onclick="document.getElementById('manual-upload-in').click()">
        <span class="upload-icon">üìÇ</span>
        <span class="upload-text">IMPORT IMAGES</span>
        <input type="file" id="manual-upload-in" hidden multiple onchange="handleManualUpload(this)">
    </div>

    <!-- 2. UKURAN & ROTASI (Sabariseun Ameh Hemat Tempat) -->
    <div style="display:grid; grid-template-columns: 1fr 1fr 0.8fr; gap:5px; margin-bottom:8px;">
        <div>
            <label>WIDTH (CM)</label>
            <input type="number" id="m-w" value="10" step="0.1" class="cyber-input">
        </div>
        <div>
            <label>HEIGHT (CM)</label>
            <input type="number" id="m-h" value="10" step="0.1" class="cyber-input">
        </div>
        <div>
            <label>ROT</label>
            <select id="m-rot" class="cyber-input" style="padding:0 4px;">
                <option value="0">0¬∞</option><option value="90">90¬∞</option>
                <option value="180">180¬∞</option><option value="270">270¬∞</option>
            </select>
        </div>
    </div>

    <!-- 3. GAP & KRES (Disatukeun dina Box) -->
    <div style="background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px;">
        <!-- Gap -->
        <div style="display:flex; align-items:flex-end; gap:5px; margin-bottom:8px;">
            <div style="flex:1;">
                <label>GAP JARAK (CM)</label>
                <input type="number" id="m-gap" value="0.5" step="0.1" class="cyber-input">
            </div>
            <button class="btn btn-outline" style="height:28px; width:28px; padding:0; display:flex; align-items:center; justify-content:center; font-size:0.6rem;" onclick="document.getElementById('m-gap').value=0" title="Nol">0</button>
        </div>

        <!-- Kres Config -->
        <div style="border-top:1px dashed var(--border); padding-top:6px; margin-top:6px;">
            <div style="display:flex; align-items:center; gap:6px; margin-bottom:5px;">
                <input type="checkbox" id="m-use-kres" style="transform:scale(1);">
                <label for="m-use-kres" style="margin:0; cursor:pointer; color:var(--text);">CROP MARKS (KRES)</label>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <div><label>TEBAL (MM)</label><input type="number" id="m-kres-tebal" value="0.3" step="0.1" class="cyber-input"></div>
                <div><label>PANJANG (MM)</label><input type="number" id="m-kres-panjang" value="5" step="1" class="cyber-input"></div>
            </div>
        </div>
    </div>

    <!-- 4. LIST GAMBAR (Akan jadi 2 Kolom Besar) -->
    <div style="flex:1; overflow-y:auto; border-top:1px solid var(--border); padding-top:10px;">
        <label style="color:var(--accent); font-weight:bold; margin-bottom:5px;">ASSETS GALLERY:</label>
        <div id="manual-source-list">
            <!-- Gambar asup didieu -->
        </div>
    </div>

    <!-- 5. TOMBOL PRINT -->
    <button class="btn btn-success" style="width:100%; margin-top:10px; height:35px; font-size:0.75rem;" onclick="printManualCanvas()">üñ®Ô∏è PRINT LAYOUT</button>
</div>

        <div class="layout-main">
            <div style="margin-bottom:20px; display:flex; gap:15px; align-items:center; background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:50px; border:1px solid var(--border);">
                <select id="m-paper" class="cyber-input" style="width:150px;" onchange="updatePaperCanvas()">
                    <option value="32,48">A3+ (32x48)</option>
                    <option value="21,29.7">A4 (21x29.7)</option>
                </select>
                <button class="btn btn-mini btn-danger" onclick="clearManualCanvas()">üóëÔ∏è CLEAR ALL</button>
                <span style="font-size:0.7rem; color:var(--text-dim);">TIPS: KLIK GAMBAR DI KIRI UNTUK MENYUSUN KE KERTAS</span>
            </div>
            <div id="paper-canvas" class="paper-canvas"></div>
        </div>
    </div>

    <!-- MODAL: PRINT -->
    <div id="modal-print" class="modal">
        <div class="modal-box glass-panel" style="width: 700px; padding: 30px;">
            <h2 style="font-family: 'Outfit'; margin-top: 0;">Production Setup</h2>
            <div class="print-mode-tabs" style="display:flex; gap:10px; margin-bottom:20px;">
                <button id="mode-full-btn" class="btn btn-outline active" onclick="switchPrintMode('full')" style="flex:1;">Full Page</button>
                <button id="mode-grid-btn" class="btn btn-outline" onclick="switchPrintMode('grid')" style="flex:1;">Grid Tile</button>
            </div>
            <div style="display: flex; gap: 20px; margin-bottom: 25px;">
                <div class="glass-panel" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; position: relative; border-radius: 16px !important;">
                    <img id="p-img" style="width: 100%; height: 100%; object-fit: contain;">
                    <div id="p-pdf-badge" class="pdf-tag" style="display:none; position:absolute; bottom:5px; right:5px;">PDF</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                    <div><label style="font-size: 0.7rem; color: var(--text-dim);">INVOICE</label><input type="text" id="p-inv-edit" class="cyber-input" style="color: var(--warning); font-weight: 700;"></div>
                    <div><label style="font-size: 0.7rem; color: var(--text-dim);">BAHAN</label>
                        <select id="p-mat" class="cyber-input"><option>Chromo</option><option>Vinyl Glossy</option><option>Vinyl Matte</option><option>Transparan</option><option>Art Carton</option><option>HVS</option></select>
                    </div>
                </div>
            </div>
            <div class="glass-panel" style="padding: 20px; background: rgba(0,0,0,0.2);">
                <label style="font-size: 0.7rem; color: var(--text-dim);">UKURAN KERTAS</label>
                <select id="p-pdf-paper" class="cyber-input" onchange="toggleCustomPaper(this.value)">
                    <option value="32,48">A3+ (32x48 cm)</option><option value="29.7,42">A3</option><option value="21,29.7">A4</option><option value="custom">-- CUSTOM --</option>
                </select>
                <div id="custom-paper-box" style="display:none; gap: 10px; margin-top: 10px;">
                    <input type="number" id="p-custom-w" class="cyber-input" placeholder="W" oninput="calcGrid()"><input type="number" id="p-custom-h" class="cyber-input" placeholder="H" oninput="calcGrid()">
                </div>
                <div id="grid-controls" style="display:none; border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px;">
    <!-- BAGIAN LAMA (UKURAN & GAP) -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: flex-end;">
        <div><label style="font-size: 0.6rem;">L (cm)</label><input type="number" id="p-grid-w" value="5" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
        <div><label style="font-size: 0.6rem;">T (cm)</label><input type="number" id="p-grid-h" value="5" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
        <div><label style="font-size: 0.6rem;">GAP</label><input type="number" id="p-grid-gap" value="0" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
        <button class="btn btn-outline" onclick="physicalRotate()">üîÑ</button>
    </div>

    <!-- IEU TAMBAHAN ANYARNA (KRES SETTINGS) -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; padding-top:10px; border-top:1px dashed var(--border);">
        <div>
            <label style="font-size:0.6rem; color:var(--text-dim)">TEBAL KRES (mm)</label>
            <input type="number" id="p-grid-kres-thick" value="0.2" step="0.1" class="cyber-input">
        </div>
        <div>
            <label style="font-size:0.6rem; color:var(--text-dim)">PANJANG (mm)</label>
            <input type="number" id="p-grid-kres-len" value="5" step="1" class="cyber-input">
        </div>
    </div>
    
    <div id="grid-res-box" style="text-align: center; color: var(--success); font-size: 0.8rem; margin-top: 10px; font-weight: 700;">HASIL: -</div>
</div>
                <div style="margin-top: 20px; text-align: center;">
                    <label style="font-size: 0.7rem; color: var(--text-dim);">QTY LEMBAR</label>
                    <input type="number" id="p-pdf-target" value="1" class="cyber-input" style="font-size: 1.5rem; text-align: center; color: var(--success); font-weight: 800;" oninput="calcGrid()">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-top: 25px;">
                <button class="btn btn-danger" onclick="closeModal()">BATAL</button>
                <button id="btn-do-print" class="btn btn-primary" onclick="executePrint()">MULAI CETAK</button>
            </div>
        </div>
    </div>

    <!-- MODAL: LOG -->
    <div id="modal-hist" class="modal">
        <div class="modal-box glass-panel" style="width: 90%; max-width: 1000px; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="font-family: 'Outfit'; margin: 0;">System Log - <span id="hist-role-title" style="color: var(--accent);">...</span></h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-mini btn-success" onclick="exportLogToPDF()">üíæ EXPORT PDF</button>
                    <button class="btn btn-mini btn-danger" onclick="clearAllHistory()">CLEAR LOG</button>
                </div>
            </div>
            <div class="hist-tabs" style="display: flex; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; margin-bottom: 15px;">
                <button class="hist-tab-btn active" id="tab-1" onclick="switchHistTab(1)">INBOX / DATA MASUK</button>
                <button class="hist-tab-btn" id="tab-2" onclick="switchHistTab(2)">OUTBOX / RIWAYAT</button>
            </div>
            <div style="max-height: 450px; overflow-y: auto;" class="glass-panel">
                <table id="hist-table-real">
                    <thead>
                        <tr>
                            <th>WAKTU</th>
                            <th>FOTO</th>
                            <th>INV</th>
                            <th>QTY</th>
                            <th>STATUS & KETERANGAN</th>
                            <th>PARTNER</th>
                            <th>AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="hist-body"></tbody>
                </table>
            </div>
            <button class="btn btn-outline" style="width: 100%; margin-top: 25px;" onclick="toggleHistory()">CLOSE</button>
        </div>
    </div>

    <iframe id="p-frame" style="display:none;"></iframe>

    <script>
        const { ipcRenderer } = require('electron');

let audioFiles = {};

// Narima path audio ti main.js
ipcRenderer.on('audio-path', (event, paths) => {
    audioFiles = paths;
    console.log("Path audio siap:", audioFiles);
});

// Fungsi kanggo muter sora
function playNotification() {
    if (audioFiles.notif) {
        const audio = new Audio(audioFiles.notif);
        audio.play().catch(e => console.error("Gagal muter sora:", e));
    }
}
        const ROLES_KEYS = { admin: "calik", designer: "melengkung", operator: "nangtung" };
        let myId = localStorage.getItem('kts_id') || 'KTS-' + Math.floor(Math.random()*9999);
        let role, peer, db, activeConns = [], currentTab = 1, timelineFilter = 'all';
        let tempJobs = [], activeJobIdx = null, selectedInboxes = [], currentPrintMode = 'full', activeJob = null;
        let currentPromptTask = null;

        // STATE MANUAL LAYOUTER
        let manualSources = [], canvasItems = [], currentX = 0, currentY = 0, maxRowH = 0;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DATABASE
        let req = indexedDB.open("KertasesV15_3_DB", 1);
        req.onupgradeneeded = e => {
            let d = e.target.result;
            d.createObjectStore("stream", { keyPath: "id" });
            d.createObjectStore("history", { keyPath: "id", autoIncrement:true });
        };
        req.onsuccess = e => { db = e.target.result; checkAutoLogin(); };

        function checkAutoLogin() {
            const savedRole = localStorage.getItem('kts_active_role');
            if(savedRole) loadInterface(savedRole);
        }

        function doLogout() {
            if(confirm("Logout from system?")) {
                localStorage.removeItem('kts_active_role');
                location.reload();
            }
        }

        function openKtsPrompt(title, desc, type, callback) {
            document.getElementById('p-title').innerText = title;
            document.getElementById('p-desc').innerText = desc;
            const input = document.getElementById('p-val');
            input.type = type; input.value = "";
            document.getElementById('kts-prompt').style.display = 'flex';
            input.focus(); currentPromptTask = callback;
        }

        function confirmKts() {
            const val = document.getElementById('p-val').value;
            if(val && currentPromptTask) currentPromptTask(val);
            document.getElementById('kts-prompt').style.display = 'none';
        }

        function enterRole(r) {
            openKtsPrompt("Login " + r.toUpperCase(), "Masukkan Kode Akses:", "password", (pass) => {
                if(pass === ROLES_KEYS[r]) {
                    localStorage.setItem('kts_active_role', r);
                    loadInterface(r);
                } else { alert("SALAH KODE!"); }
            });
        }

        function loadInterface(r) {
            role = r;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-layout').style.display = 'flex';
            document.getElementById('active-role-display').innerText = role.toUpperCase();
            document.getElementById('my-id-display').innerText = myId;
            if(role === 'operator') {
                document.getElementById('batch-bar').style.display = 'flex';
                document.getElementById('btn-open-layouter').style.display = 'inline-flex';
            }
            initPeer(); 
            addNewJob(); 
            setTimeout(renderStream, 500);
        }

        function setMode(m) {
            if(m === 'local') {
                openKtsPrompt("Local LAN Setup", "Masukkan IP Server Lokal (Operator):", "text", (ip) => {
                    localStorage.setItem('kts_mode', 'local'); localStorage.setItem('kts_ip', ip); location.reload();
                });
            } else { localStorage.setItem('kts_mode', 'cloud'); location.reload(); }
        }

        function initPeer() {
            const mode = localStorage.getItem('kts_mode') || 'cloud';
            const savedIp = localStorage.getItem('kts_ip') || 'localhost';
            const opts = (mode === 'local') ? { host: savedIp, port: 9000, path: '/kertases-app', secure: false } : { debug: 1 };
            
            document.getElementById('btn-local').className = (mode==='local') ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('btn-cloud').className = (mode==='cloud') ? 'btn btn-primary' : 'btn btn-outline';

            peer = new Peer(myId, opts);
            peer.on('open', () => updateStatus('ready'));
            peer.on('connection', c => setupConn(c));
            peer.on('error', err => { if(err.type === 'peer-unavailable') alert("Partner Offline!"); updateStatus('offline'); });
        }

        function connectMulti() {
            const tid = document.getElementById('target-id').value.trim();
            if(!tid || tid === myId) return alert("ID Salah!");
            updateStatus('connecting...');
            setupConn(peer.connect(tid, { reliable: true }));
        }

       function setupConn(c) {
    // 1. PAS KONEKSI MUKA (ID Partner Nyambung)
    c.on('open', () => {
        // Pariksa bilih ID ieu tos aya dina daptar, supados teu numpuk
        if(!activeConns.find(x => x.peer === c.peer)) {
            // Lebatkeun kana daptar koneksi aktif
            activeConns.push(c); 
            
            // Ganti status widget janten ONLINE (Ijo)
            updateStatus('online'); 
            
            // Update tampilan daptar ID anu konek di sidebar
            updateConnUI();

            // --- LOGIKA MAENKEUN SORA KONEKSI LOKAL (conn.mp3) ---
            const connSound = document.getElementById('conn-sound');
            if (connSound) {
                // Reset sora bilih keur maen keneh
                connSound.pause();
                connSound.currentTime = 0;
                
                // Setel polumeu (1.0 = maksimal)
                connSound.volume = 1.0; 
                
                // Tabeuh sorana
                connSound.play().catch(err => {
                    // Browser biasana menta klik layar sakali heula
                    console.warn("Sora koneksi siap, klik layar sakali kanggo 'unlock' sora!");
                });
            }
        }
    });

    // 2. PAS NARIMA DATA (Kiriman ti Partner)
    c.on('data', d => {
        // Upami datana mangrupa Job/File anyar
        if(d.type === 'job') {
            handleIncoming(d, c.peer);
        }
        
        // Upami datana mangrupa update status (misal: beja geus dicetak)
        if(d.type === 'status_update') {
            handleStatusUpdate(d);
        }
    });

    // 3. PAS KONEKSI PUTUS (Partner Offline/Tutup Aplikasi)
    c.on('close', () => { 
        // Cabut ID partner tina daptar koneksi
        activeConns = activeConns.filter(x => x.peer !== c.peer); 
        
        // Refresh tampilan sidebar
        updateConnUI(); 
        
        // Upami tos teu aya hiji-hiji acan nu konek, balikkeun status jadi READY
        if(!activeConns.length) {
            updateStatus('ready');
        }
    });

    // 4. PAS AYA ERROR KONEKSI
    c.on('error', err => {
        console.error("Aya masalah koneksi:", err);
        updateStatus('offline');
    });
}

        function updateConnUI() { document.getElementById('active-conns').innerHTML = activeConns.map(x => `<div class="glass-panel" style="padding:8px; margin-bottom:5px; font-size:0.7rem; border-color:var(--success); border-radius:10px !important;">üü¢ ${x.peer}</div>`).join(''); }
        function updateStatus(s) { 
            const w = document.getElementById('status-widget');
            w.className = 'status-widget ' + (activeConns.length > 0 ? 'online' : s);
            document.getElementById('status-text').innerText = activeConns.length > 0 ? 'CONNECTED' : s.toUpperCase();
        }

        // --- CONTROL PANEL ---
        function addNewJob() { tempJobs.push({ files: [], inv: '', cap: '', selected: true }); renderJobs(); }
        
        // FITUR HAPUS ROW
        function removeJobRow(idx) {
            if(tempJobs.length > 1) {
                tempJobs.splice(idx, 1);
                renderJobs();
            } else { alert("Minimal 1 baris!"); }
        }

        function triggerFileSelect(idx) { activeJobIdx = idx; document.getElementById('job-file-in').click(); }
        async function handleFileSelect(input) {
            if(!input.files.length || activeJobIdx === null) return;
            for(let f of input.files) {
                let isPdf = f.type === 'application/pdf';
                let data = await toBase64(f);
                let thumb = isPdf ? await getPdfPreview(data) : data;
                tempJobs[activeJobIdx].files.push({ data, thumb, isPdf, name: f.name });
            }
            renderJobs(); input.value = '';
        }

        function renderJobs() {
            const list = document.getElementById('job-list'); list.innerHTML = '';
            tempJobs.forEach((job, jIdx) => {
                let row = document.createElement('div');
                row.className = `job-row ${job.selected ? 'checked' : ''}`;
                let thumbs = job.files.map((f, fIdx) => `<div class="thumb-box"><img src="${f.thumb}">${f.isPdf ? '<div class="pdf-tag">PDF</div>':''}<div onclick="removeFile(${jIdx}, ${fIdx})" style="position:absolute; top:2px; left:2px; background:var(--danger); color:white; font-size:10px; padding:2px; cursor:pointer; border-radius:50%; width:16px; height:16px; text-align:center; line-height:12px;">√ó</div></div>`).join('');
                row.innerHTML = `
                    <div onclick="removeJobRow(${jIdx})" style="position:absolute; top:12px; left:12px; background:var(--danger); color:white; font-size:0.6rem; font-weight:bold; padding:2px 6px; border-radius:6px; cursor:pointer; z-index:10;">HAPUS BARIS</div>
                    <input type="checkbox" style="position:absolute; top:15px; right:15px; transform:scale(1.4);" ${job.selected ? 'checked' : ''} onchange="tempJobs[${jIdx}].selected=this.checked; renderJobs()">
                    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; padding-top:20px;">${thumbs}<div class="thumb-box" style="cursor:pointer; border:1px dashed var(--accent); color:var(--accent); display:flex; align-items:center; justify-content:center; font-size:1.5rem;" onclick="triggerFileSelect(${jIdx})">+</div></div>
                    <input type="text" class="cyber-input" placeholder="INV #" value="${job.inv}" oninput="tempJobs[${jIdx}].inv=this.value" style="margin-bottom:8px; font-weight:700;">
                    <textarea class="cyber-input" placeholder="KETERANGAN..." oninput="tempJobs[${jIdx}].cap=this.value">${job.cap}</textarea>
                `;
                list.appendChild(row);
            });
        }

        function removeFile(jIdx, fIdx) { tempJobs[jIdx].files.splice(fIdx, 1); renderJobs(); }
        function toggleSelectAllRows() { let all = tempJobs.every(j => j.selected); tempJobs.forEach(j => j.selected = !all); renderJobs(); }

        function mainAction() {
            const sel = tempJobs.filter(j => j.selected);
            if(!sel.length) return alert("Pilih data!");
            
            if(role === 'operator') {
                let files = []; 
                sel.forEach(j => j.files.forEach(f => files.push({...f, inv: j.inv})));
                if(!files.length) return alert("Kosong!");
                openPrintLogic({ files, internalId: null }); 
            } else {
                if(!activeConns.length) return alert("Koneksikan Partner!");
                let d = { type: 'job', jobs: sel, id: Date.now(), senderRole: role, senderId: myId, status: 'pending' };
                activeConns.forEach(c => { if(c.open) c.send(d); });
                saveStream({ ...d, direction: 'out', hidden: false });
                sel.forEach(job => saveHistory({ inv: job.inv, cap: job.cap, thumb: job.files[0]?.thumb, typeLabel: role==='admin'?'ADM_SEND':'DSN_SEND', partner: activeConns.map(c=>c.peer).join(', ') }));
                alert("TERKIRIM!"); 
                tempJobs = tempJobs.filter(j => !j.selected); if(!tempJobs.length) addNewJob(); renderJobs(); renderStream();
            }
        }

      function handleIncoming(d, from) {
    let label = (role === 'designer') ? "DSN_RECV" : "OP_RECV";
    
    let streamData = { 
        ...d, 
        direction: 'in', 
        from: from, 
        hidden: false, 
        reprintCount: 0, 
        status: 'pending' 
    };

    saveStream(streamData);

    if (d.jobs && Array.isArray(d.jobs)) {
        d.jobs.forEach(job => {
            saveHistory({ 
                inv: job.inv || '-', 
                cap: job.cap || '-', 
                thumb: job.files[0]?.thumb || null, 
                typeLabel: label, 
                partner: from 
            });
        });
    }

    renderStream(); 

    // --- LOGIKA MANGGIL SORA LOKAL ---
    const notifSound = document.getElementById('notif-sound');
    if (notifSound) {
        // Reset sora bilih nuju jalan
        notifSound.pause();
        notifSound.currentTime = 0;
        
        // Maenkeun sora lokal
        notifSound.play().catch(err => {
            console.warn("Sora lokal siap, mangga klik layar sakali kanggo aktifkeun!");
        });
    }
}

        function handleStatusUpdate(d) {
            db.transaction("stream", "readwrite").objectStore("stream").get(d.msgId).onsuccess = e => {
                let data = e.target.result;
                if(data) {
                    data.status = 'printed';
                    db.transaction("stream", "readwrite").objectStore("stream").put(data).onsuccess = () => renderStream();
                }
            };
        }

        // --- TIMELINE ---
        function setTimelineFilter(f, btn) {
            timelineFilter = f;
            document.querySelectorAll('.filter-bar .btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderStream();
        }

        function renderStream() {
    const area = document.getElementById('stream-area');
    area.innerHTML = '';

    db.transaction("stream").objectStore("stream").getAll().onsuccess = e => {
        const results = e.target.result;

        results.forEach(msg => {
            if (msg.hidden) return;

            // Logika Tab (Sami sareng sateuacanna)
            if (timelineFilter === 'printed') {
                if (msg.status !== 'printed') return;
            } else {
                if (msg.status === 'printed') return;
                if (timelineFilter === 'admin' && msg.senderRole !== 'admin') return;
                if (timelineFilter === 'designer' && msg.senderRole !== 'designer') return;
            }

            if (role === 'admin' && msg.direction === 'in') return;

            const isSelected = selectedInboxes.includes(msg.id);
            let card = document.createElement('div');
            card.className = `msg-card ${msg.direction} ${msg.status === 'printed' ? 'printed' : ''} ${isSelected ? 'selected' : ''}`;
            
            // --- BAGIAN BADGE (Aya tambahan keur REPRINT) ---
            let printedMark = msg.status === 'printed' ? `<div class="printed-badge">DICETAK</div>` : '';
            // Mun aya reprint, munculkeun badge warna kon√©ng
            let reprintMark = (msg.reprintCount > 0) ? `<div class="printed-badge" style="background:var(--warning); margin-left:5px;">REPRINT [${msg.reprintCount}x]</div>` : '';
            
            let header = `
                <div class="msg-header">
                    <div style="display:flex; align-items:center;">
                        <span>FROM: ${msg.from || 'ME'} <span class="role-tag">${msg.senderRole}</span></span> 
                        ${printedMark} ${reprintMark}
                    </div>
                    <span onclick="hideStream(${msg.id})" style="cursor:pointer; color:var(--danger); font-weight:bold; padding:0 5px;">√ó</span>
                </div>`;
            
            // Body Card (Sami sareng nu sateuacanna)
            let body = document.createElement('div'); 
            body.className = 'msg-body';
            msg.jobs.forEach((job, jIdx) => {
                let jobWrap = document.createElement('div');
                jobWrap.style.marginBottom = "15px";
                jobWrap.innerHTML = `<input type="text" class="card-edit-inv" value="${job.inv||''}" onchange="updateStreamContent(${msg.id}, ${jIdx}, 'inv', this.value)"><textarea class="card-edit-cap" onchange="updateStreamContent(${msg.id}, ${jIdx}, 'cap', this.value)">${job.cap||''}</textarea>`;
                job.files.forEach((f, fIdx) => {
                    jobWrap.innerHTML += `<div class="thumb-row-wrap"><div class="thumb-box"><img src="${f.thumb}">${f.isPdf ? '<div class="pdf-tag">PDF</div>' : ''}</div><div style="flex:1; display:flex; flex-direction:column; gap:5px;"><span style="font-size:0.6rem; color:var(--text-dim); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:150px;">${f.name || 'file_asset'}</span><button class="btn btn-mini btn-outline" style="color:var(--success); border-color:rgba(16,185,129,0.3);" onclick="downloadAsset('${f.data}', '${job.inv||'file'}_${fIdx}')">üíæ SAVE</button></div></div>`;
                });
                body.appendChild(jobWrap);
            });
            
            // --- BAGIAN TOMBOL (Tambahan Tombol Cetak Ulang) ---
            let footer = document.createElement('div'); 
            footer.style.cssText = "padding:12px; display:flex; gap:10px; border-top:1px solid rgba(255,255,255,0.05);";
            
            if(msg.direction === 'in' && role === 'operator') {
                if(msg.status !== 'printed') {
                    // Tampilan Inbox Biasa
                    footer.innerHTML = `
                        <button class="btn btn-success btn-mini" style="flex:2;" onclick="openPrintSingle(${msg.id})">üñ®Ô∏è CETAK</button>
                        <button class="btn ${isSelected ? 'btn-primary' : 'btn-outline'} btn-mini" onclick="toggleSelect(${msg.id})">${isSelected ? '‚úÖ READY' : '‚ûï BATCH'}</button>
                    `;
                } else {
                    // Tampilan dina tab "DATA CETAK" (Aya Cetak Ulang)
                    footer.innerHTML = `
                        <button class="btn btn-outline btn-mini" style="flex:1; border-color:var(--warning); color:var(--warning);" onclick="openPrintSingle(${msg.id})">üîÑ CETAK ULANG</button>
                    `;
                }
            }
            
            card.innerHTML = header; 
            card.appendChild(body); 
            if(footer.innerHTML !== "") card.appendChild(footer);
            area.appendChild(card);
        });
        area.scrollTop = area.scrollHeight;
    };
}

        function updateStreamContent(msgId, jobIdx, field, value) {
            db.transaction("stream", "readwrite").objectStore("stream").get(msgId).onsuccess = e => {
                let d = e.target.result; d.jobs[jobIdx][field] = value;
                db.transaction("stream", "readwrite").objectStore("stream").put(d);
            };
        }

        // --- PRINT ENGINE ---
        function switchPrintMode(m) {
            currentPrintMode = m;
            document.getElementById('mode-full-btn').className = `btn btn-outline ${m==='full'?'active':''}`;
            document.getElementById('mode-grid-btn').className = `btn btn-outline ${m==='grid'?'active':''}`;
            document.getElementById('grid-controls').style.display = (m === 'grid') ? 'block' : 'none';
            calcGrid();
        }

        function openPrintSingle(id) {
            db.transaction("stream").objectStore("stream").get(id).onsuccess = e => {
                let d = e.target.result, files = [];
                d.jobs.forEach(j => j.files.forEach(f => files.push({...f, inv: j.inv})));
                openPrintLogic({ files, internalId: id, senderId: d.senderId });
            };
        }

        function openPrintLogic(job) {
            activeJob = job;
            document.getElementById('modal-print').style.display = 'flex';
            document.getElementById('p-img').src = job.files[0].thumb;
            document.getElementById('p-pdf-badge').style.display = job.files[0].isPdf ? 'block' : 'none';
            document.getElementById('p-inv-edit').value = job.files[0].inv;
            switchPrintMode(job.files[0].isPdf ? 'full' : 'grid');
        }

        function toggleCustomPaper(val) { document.getElementById('custom-paper-box').style.display = (val === 'custom') ? 'flex' : 'none'; calcGrid(); }

        function calcGrid() {
            if(currentPrintMode !== 'grid') { document.getElementById('grid-res-box').innerText = "FULL PAGE MODE"; return; }
            let pw, ph;
            if(document.getElementById('p-pdf-paper').value === 'custom') {
                pw = parseFloat(document.getElementById('p-custom-w').value) || 0; ph = parseFloat(document.getElementById('p-custom-h').value) || 0;
            } else {
                let p = document.getElementById('p-pdf-paper').value.split(','); pw = parseFloat(p[0]); ph = parseFloat(p[1]);
            }
            let w = parseFloat(document.getElementById('p-grid-w').value) || 1, h = parseFloat(document.getElementById('p-grid-h').value) || 1, gap = parseFloat(document.getElementById('p-grid-gap').value) || 0, target = parseInt(document.getElementById('p-pdf-target').value) || 1;
            let nx = Math.floor((pw + gap) / (w + gap)), ny = Math.floor((ph + gap) / (h + gap));
            document.getElementById('grid-res-box').innerText = `HASIL: ${nx * ny} pcs/lbr | TOTAL: ${nx * ny * target} PCS`;
        }

        async function physicalRotate() {
            let f = activeJob.files[0]; if(f.isPdf) return;
            let img = new Image(); img.src = f.data; await img.decode();
            let cvs = document.createElement('canvas'); cvs.width = img.height; cvs.height = img.width;
            let ctx = cvs.getContext('2d'); ctx.translate(cvs.width/2, cvs.height/2); ctx.rotate(90 * Math.PI / 180);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            f.data = f.thumb = cvs.toDataURL('image/jpeg', 0.9);
            document.getElementById('p-img').src = f.thumb;
            let ow = document.getElementById('p-grid-w').value;
            document.getElementById('p-grid-w').value = document.getElementById('p-grid-h').value;
            document.getElementById('p-grid-h').value = ow;
            calcGrid();
        }

        function executePrint() { if(currentPrintMode === 'full') executeFullPrint(); else executeGridPrint(); }

        async function executeFullPrint() {
            const btn = document.getElementById('btn-do-print'); btn.innerText = "RENDERING..."; btn.disabled = true;
            try {
                let pw, ph;
                if(document.getElementById('p-pdf-paper').value === 'custom') {
                    pw = document.getElementById('p-custom-w').value; ph = document.getElementById('p-custom-h').value;
                } else {
                    let p = document.getElementById('p-pdf-paper').value.split(','); pw = p[0]; ph = p[1];
                }
                let target = parseInt(document.getElementById('p-pdf-target').value) || 1, mat = document.getElementById('p-mat').value, inv = document.getElementById('p-inv-edit').value;
                let html = `<style>@page { size: ${pw}cm ${ph}cm; margin: 0; } body { margin: 0; } .sheet { width: ${pw}cm; height: ${ph}cm; page-break-after: always; display: flex; flex-direction: column; align-items: center; justify-content: center; } .p-img { width: 100%; height: calc(100% - 1.2cm); object-fit: contain; } .footer { height: 1.2cm; font-size: 11pt; font-family: sans-serif; font-weight: bold; display: flex; align-items: center; justify-content: center; border-top: 1px solid #eee; }</style>`;
                let content = "";
                for(let f of activeJob.files) {
                    const img = f.isPdf ? await getPdfPreview(f.data, true) : f.data;
                    for(let i=0; i<target; i++) content += `<div class="sheet"><img src="${img}" class="p-img"><div class="footer">${inv} - ${mat}</div></div>`;
                }
                finishPrint(html + content, inv, target, 'FULL PAGE');
            } catch(e) { alert("Error!"); btn.innerText = "MULAI CETAK"; btn.disabled = false; }
        }

        function executeGridPrint() {
    const btn = document.getElementById('btn-do-print'); btn.innerText = "PROSES GRID..."; btn.disabled = true;
    
    // NYANDAK DATA KERTAS
    let pw, ph;
    if(document.getElementById('p-pdf-paper').value === 'custom') {
        pw = parseFloat(document.getElementById('p-custom-w').value); 
        ph = parseFloat(document.getElementById('p-custom-h').value);
    } else {
        let p = document.getElementById('p-pdf-paper').value.split(','); 
        pw = parseFloat(p[0]); ph = parseFloat(p[1]);
    }

    // NYANDAK DATA UKURAN
    let w = parseFloat(document.getElementById('p-grid-w').value), 
        h = parseFloat(document.getElementById('p-grid-h').value), 
        gap = parseFloat(document.getElementById('p-grid-gap').value) || 0, 
        target = parseInt(document.getElementById('p-pdf-target').value) || 1, 
        inv = document.getElementById('p-inv-edit').value, 
        mat = document.getElementById('p-mat').value;

    // NYANDAK SETTINGAN KRES (ANYAR)
    let kresTebal = parseFloat(document.getElementById('p-grid-kres-thick').value) || 0.2;
    let kresPanjang = parseFloat(document.getElementById('p-grid-kres-len').value) || 5;

    let nx = Math.floor((pw + gap) / (w + gap)), 
        ny = Math.floor((ph + gap) / (h + gap)), 
        halfGap = gap / 2;

    // FUNGSI NYIEUN GARIS KRES (UPDATE RUMUS)
    const mk = (t, l, dir) => {
        // Horizontal: Panjang = kresPanjang, Tinggi = kresTebal
        // Vertical: Lebar = kresTebal, Tinggi = kresPanjang
        // Urang make logic centering sakedik (top: -halfTebal)
        
        let halfTebal = kresTebal / 2;
        
        let hStyle = `position:absolute; top:-${halfTebal}mm; width:${kresPanjang}mm; height:${kresTebal}mm; background:#000;`;
        let vStyle = `position:absolute; left:-${halfTebal}mm; width:${kresTebal}mm; height:${kresPanjang}mm; background:#000;`;
        
        let parts = "";
        
        // Logic arah garis (Kanan, Kiri, Bawah, Atas)
        // Lamun ka kiri (l), geser posisi left sajauh panjang garis (minus)
        // Lamun ka atas (u), geser posisi top sajauh panjang garis (minus)
        
        if(dir.includes('r')) parts += `<div style="${hStyle} left:0;"></div>`;
        if(dir.includes('l')) parts += `<div style="${hStyle} left:-${kresPanjang}mm;"></div>`; 
        if(dir.includes('d')) parts += `<div style="${vStyle} top:0;"></div>`;
        if(dir.includes('u')) parts += `<div style="${vStyle} top:-${kresPanjang}mm;"></div>`;

        return `<div style="position:absolute; top:${t}; left:${l}; width:0; height:0; z-index:100;">${parts}</div>`;
    };

    // CSS UTAMA
    let html = `<style>
        @page { size: ${pw}cm ${ph}cm; margin: 0; } 
        body { margin: 0; } 
        .sheet { width: ${pw}cm; height: ${ph}cm; display: flex; align-items: center; justify-content: center; page-break-after: always; position: relative; } 
        .grid-container { display: grid; grid-template-columns: repeat(${nx}, ${w}cm); grid-gap: ${gap}cm; position: relative; } 
        .cell { position: relative; width: ${w}cm; height: ${h}cm; } 
        .cell img { width: 100%; height: 100%; object-fit: fill; } 
        .footer { position: absolute; bottom: 0.3cm; width: 100%; text-align: center; font-weight: bold; font-family: sans-serif; font-size: 10pt; }
    </style>`;

    let cells = ""; 
    for(let row=0; row<ny; row++) {
        for(let col=0; col<nx; col++) {
            let offset = halfGap > 0 ? `-${halfGap}cm` : "0";
            
            // Logic nunjukkeun jenis kres dumasar posisi (Pojok/Tengah)
            const getType = (r, c) => { 
                if(r===0 && c===0) return "rd"; 
                if(r===0 && c===nx) return "ld"; 
                if(r===ny && c===0) return "ru"; 
                if(r===ny && c===nx) return "lu"; 
                if(r===0) return "lrd"; 
                if(r===ny) return "lru"; 
                if(c===0) return "rdu"; 
                if(c===nx) return "ldu"; 
                return "lrdu"; 
            };
            
            let marks = mk(offset, offset, getType(row, col));
            
            if(col === nx-1) marks += mk(offset, `calc(100% + ${halfGap}cm)`, getType(row, col+1));
            
            if(row === ny-1) {
                marks += mk(`calc(100% + ${halfGap}cm)`, offset, getType(row+1, col));
                if(col === nx-1) marks += mk(`calc(100% + ${halfGap}cm)`, `calc(100% + ${halfGap}cm)`, getType(row+1, col+1));
            }
            cells += `<div class="cell"><img src="${activeJob.files[0].data}">${marks}</div>`;
        }
    }
    
    let content = ""; 
    for(let i=0; i<target; i++) content += `<div class="sheet"><div class="grid-container">${cells}</div><div class="footer">${inv} - ${mat}</div></div>`;
    
    finishPrint(html + content, inv, target, `GRID (${nx*ny}x${target})`);
}

        function finishPrint(fullHtml, inv, qty, mode) {
    let f = document.getElementById('p-frame');
    f.style.display = "block";
    f.contentWindow.document.open();
    f.contentWindow.document.write(fullHtml);
    f.contentWindow.document.close();

    // Jeda sakedik kanggo nunggu browser nyiapkeun tampilan print
    setTimeout(() => {
        f.contentWindow.print();
        f.style.display = "none";
        
        // Reset tombol
        document.getElementById('btn-do-print').innerText = "MULAI CETAK";
        document.getElementById('btn-do-print').disabled = false;
        
        // --- LOGIKA UPDATE DATA ---
        if(activeJob.internalId) {
            db.transaction("stream", "readwrite").objectStore("stream").get(activeJob.internalId).onsuccess = e => {
                let d = e.target.result;
                
                // Cek bilih ieu cetak ulang atanapi munggaran
                if(d.status === 'printed') {
                    d.reprintCount = (d.reprintCount || 0) + 1;
                } else {
                    d.status = 'printed';
                    d.reprintCount = 0;
                }
                
                db.transaction("stream", "readwrite").objectStore("stream").put(d).onsuccess = () => renderStream();
            };
            
            // Bejaan partner (Designer/Admin) yen data geus dicetak
            let conn = activeConns.find(x => x.peer === activeJob.senderId);
            if(conn) conn.send({ type: 'status_update', msgId: activeJob.internalId });
        } 
        else if(role === 'operator') {
            // Upami input lokal operator
            let localJob = {
                id: Date.now(), direction: 'in', from: 'LOKAL (MANUAL)', senderRole: 'operator', senderId: myId, status: 'printed', reprintCount: 0,
                jobs: [{ inv: inv, cap: mode, files: activeJob.files }], hidden: false
            };
            saveStream(localJob);
            renderStream();
        }

        // Simpen ka History
        saveHistory({ inv, typeLabel: 'PRODUKSI_SELESAI', qty, cap: mode, thumb: activeJob.files[0].thumb, partner: activeJob.internalId ? activeJob.senderId : 'MANUAL' });

        // --- LOGIKA SORA BERES CETAK (done.mp3) ---
        const doneSound = document.getElementById('done-sound');
        if (doneSound) {
            doneSound.pause();
            doneSound.currentTime = 0;
            doneSound.volume = 1.0;
            doneSound.play().catch(e => console.warn("Klik layar sakali kanggo aktifkeun sora!"));
        }

        closeModal();
    }, 1000);
}

        // --- HISTORY & UTILS ---
        function saveHistory(obj) { 
            db.transaction("history", "readwrite").objectStore("history").add({ time: new Date().toLocaleString('id-ID'), inv: obj.inv || '-', cap: obj.cap || '-', partner: obj.partner || '?', typeLabel: obj.typeLabel, role: role, qty: obj.qty || 1, thumb: obj.thumb || null }); 
        }
        
        function refreshHistBody() {
            const b = document.getElementById('hist-body'); b.innerHTML = '';
            const labelMap = {
                'ADM_SEND': 'üì§ Terkirim ke Desainer', 'DSN_RECV': 'üì• Diterima dari Admin',
                'DSN_SEND': 'üì§ Terkirim ke Operator', 'OP_RECV': 'üì• Diterima dari Desainer',
                'PRODUKSI_SELESAI': '‚úÖ Produksi Selesai', 'OP_PROD': '‚úÖ Produksi Selesai'
            };

            db.transaction("history").objectStore("history").getAll().onsuccess = e => {
                e.target.result.reverse().forEach(h => {
                    let show = false;
                    if(role === 'admin' && h.typeLabel === 'ADM_SEND') show = true;
                    else if(role === 'designer') {
                        if(currentTab === 1 && h.typeLabel === 'DSN_RECV') show = true;
                        if(currentTab === 2 && h.typeLabel === 'DSN_SEND') show = true;
                    } else if(role === 'operator') {
                        if(currentTab === 1 && h.typeLabel === 'OP_RECV') show = true;
                        if(currentTab === 2 && (h.typeLabel === 'PRODUKSI_SELESAI' || h.typeLabel === 'OP_PROD')) show = true;
                    }

                    if(show) {
                        let statusText = labelMap[h.typeLabel] || h.typeLabel;
                        let im = h.thumb ? `<img src="${h.thumb}" style="width:40px; height:40px; object-fit:contain; background:#000; border-radius:6px; border:1px solid var(--border);">` : '-';
                        b.innerHTML += `<tr>
                            <td style="font-size:0.7rem;">${h.time}</td><td>${im}</td>
                            <td style="color:var(--accent); font-weight:700;">${h.inv}</td>
                            <td style="color:var(--success); font-weight:800;">${h.qty}</td>
                            <td style="text-align:left; font-size:0.75rem;">
                                <div style="font-weight:bold; color:var(--text);">${statusText}</div>
                                <div style="color:var(--text-dim); font-size:0.65rem;">${h.cap}</div>
                            </td>
                            <td style="color:var(--text-dim);">${h.partner}</td>
                            <td><button class="btn btn-mini btn-danger btn-outline" style="border:none;" onclick="deleteHistory(${h.id})">DEL</button></td>
                        </tr>`;
                    }
                });
            };
        }

        function switchHistTab(n) { 
            currentTab = n; 
            document.querySelectorAll('.hist-tab-btn').forEach((b, i) => b.classList.toggle('active', i === n-1)); 
            refreshHistBody(); 
        }

        function toggleHistory() { 
            let m = document.getElementById('modal-hist'); 
            m.style.display = m.style.display==='flex'?'none':'flex'; 
            if(m.style.display==='flex') { 
                document.getElementById('hist-role-title').innerText = role.toUpperCase(); 
                switchHistTab(1); 
            } 
        }

        async function getPdfPreview(base64, high = false) {
            try {
                const pdfData = atob(base64.split(',')[1]);
                const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({scale: high ? 3.0 : 0.5});
                const cvs = document.createElement('canvas'); cvs.height = viewport.height; cvs.width = viewport.width;
                await page.render({canvasContext: cvs.getContext('2d'), viewport: viewport}).promise;
                return cvs.toDataURL('image/jpeg', high ? 0.9 : 0.5);
            } catch(e) { return null; }
        }

        function clearAllHistory() { if(confirm("Hapus log?")) { let tx = db.transaction("history", "readwrite"); tx.objectStore("history").openCursor().onsuccess = e => { let c = e.target.result; if(c && c.value.role === role) c.delete(); c?.continue(); }; setTimeout(refreshHistBody, 300); } }
        function deleteHistory(id) { db.transaction("history", "readwrite").objectStore("history").delete(id).onsuccess = () => refreshHistBody(); }
        function downloadAsset(data, name) { const a = document.createElement('a'); a.href = data; a.download = name; a.click(); }
        function clearTimeline() { if(confirm("Hapus Timeline?")) { db.transaction("stream", "readwrite").objectStore("stream").clear().onsuccess = () => renderStream(); } }
        function saveStream(o) { db.transaction("stream", "readwrite").objectStore("stream").put(o); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        function hideStream(id) { db.transaction("stream", "readwrite").objectStore("stream").get(id).onsuccess = e => { let d = e.target.result; d.hidden = true; db.transaction("stream", "readwrite").objectStore("stream").put(d); renderStream(); }; }
        function toBase64(f) { return new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }); }
        function toggleSelect(id) { if(selectedInboxes.includes(id)) selectedInboxes = selectedInboxes.filter(x => x !== id); else selectedInboxes.push(id); document.getElementById('batch-count').innerText = `${selectedInboxes.length} ITEM DIPILIH`; renderStream(); }
        function openBatchPrint() { if(!selectedInboxes.length) return; let all = [], count = 0; selectedInboxes.forEach(id => { db.transaction("stream").objectStore("stream").get(id).onsuccess = e => { e.target.result.jobs.forEach(j => j.files.forEach(f => { if(f.isPdf) all.push({...f, inv: j.inv}); })); count++; if(count === selectedInboxes.length) openPrintLogic({ files: all, internalId: null }); } }); }
        function changeId() { openKtsPrompt("Admin Access", "Masukkan kode reset:", "password", (code) => { if(code === "4869") { openKtsPrompt("Ganti ID", "Masukkan ID Baru:", "text", (nid) => { if(nid) { localStorage.setItem('kts_id', nid); location.reload(); } }); } }); }
        async function exportLogToPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("KERTASES PRODUCTION LOG - " + role.toUpperCase(), 14, 15); doc.autoTable({ html: '#hist-table-real', columns: [{ header: 'WAKTU', dataKey: 'time' }, { header: 'INV', dataKey: 'inv' }, { header: 'QTY', dataKey: 'qty' }, { header: 'KET', dataKey: 'cap' }, { header: 'PARTNER', dataKey: 'partner' }], margin: { top: 25 } }); doc.save('log_kertases.pdf'); }

        // --- JS BARU: MANUAL LAYOUT LOGIC (FIXED ROTATION) ---
        function openManualLayouter() { document.getElementById('modal-manual-layout').style.display = 'grid'; updatePaperCanvas(); }
        function closeManualLayouter() { document.getElementById('modal-manual-layout').style.display = 'none'; }

        async function handleManualUpload(input) {
            for(let f of input.files) {
                let data = await toBase64(f);
                manualSources.push({ id: Date.now() + Math.random(), data, name: f.name });
            }
            renderManualSourceList();
        }

      function renderManualSourceList() {
    const list = document.getElementById('manual-source-list'); 
    list.innerHTML = ''; 

    // Tampilan kosong (Empty State)
    if(manualSources.length === 0) {
        list.innerHTML = `
            <div style="grid-column: 1/-1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; opacity:0.3;">
                <span style="font-size:2rem; margin-bottom:10px;">üñºÔ∏è</span>
                <span style="font-size:0.7rem; color:var(--text);">NO ASSETS</span>
            </div>
        `;
        return;
    }

    manualSources.forEach((src, idx) => {
        let card = document.createElement('div');
        card.className = 'asset-card';
        card.onclick = () => addToCanvas(src.id);
        
        // Ieu HTML pikeun kartu per item
        card.innerHTML = `
            <div class="asset-thumb">
                <img src="${src.data}">
            </div>
            <div class="asset-info">
                <span class="asset-name" title="${src.name}">${src.name}</span>
                <span class="asset-del" onclick="event.stopPropagation(); manualSources.splice(${idx}, 1); renderManualSourceList();" title="Hapus">üóëÔ∏è</span>
            </div>
        `;
        list.appendChild(card);
    });
}

        function updatePaperCanvas() {
            const paper = document.getElementById('paper-canvas');
            const dim = document.getElementById('m-paper').value.split(',');
            const scale = 10; // 1cm = 10px
            paper.style.width = (dim[0] * scale) + 'px';
            paper.style.minHeight = (dim[1] * scale) + 'px';
            paper.style.height = 'auto'; // Scrollable vertically
            renderCanvasItems();
        }

        function addToCanvas(srcId) {
    const src = manualSources.find(s => s.id === srcId);
    const w = parseFloat(document.getElementById('m-w').value);
    const h = parseFloat(document.getElementById('m-h').value);
    const rot = parseInt(document.getElementById('m-rot').value);
    const gap = parseFloat(document.getElementById('m-gap').value) || 0; // Nyandak nilai gap
    const paperDim = document.getElementById('m-paper').value.split(',');
    const pW = parseFloat(paperDim[0]);

    let renderW = (rot === 90 || rot === 270) ? h : w;
    let renderH = (rot === 90 || rot === 270) ? w : h;

    if(currentX + renderW > pW) { 
        currentX = 0; 
        currentY += maxRowH + gap; 
        maxRowH = 0; 
    }
    
    canvasItems.push({ 
        id: Date.now(), 
        srcId, 
        data: src.data, 
        x: currentX, 
        y: currentY, 
        w, 
        h, 
        rot, 
        renderW, 
        renderH 
    });
    
    currentX += renderW + gap;
    if(renderH > maxRowH) maxRowH = renderH;
    
    renderCanvasItems();
}

        function renderCanvasItems() {
            const paper = document.getElementById('paper-canvas');
            const scale = 10;
            paper.innerHTML = '';
            canvasItems.forEach((item, idx) => {
                let div = document.createElement('div');
                div.className = 'canvas-item';
                // Ukuran div kedah "renderW" (bounding box)
                div.style.left = (item.x * scale) + 'px';
                div.style.top = (item.y * scale) + 'px';
                div.style.width = (item.renderW * scale) + 'px';
                div.style.height = (item.renderH * scale) + 'px';
                
                // Gambar di tengah div
                div.innerHTML = `
                    <div style="position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; overflow:visible;">
                        <img src="${item.data}" style="
                            width:${item.w * scale}px; 
                            height:${item.h * scale}px; 
                            transform:rotate(${item.rot}deg);
                            object-fit:fill;
                        ">
                        <div class="item-del" onclick="canvasItems.splice(${idx}, 1); renderCanvasItems();">√ó</div>
                    </div>
                `;
                paper.appendChild(div);
            });
        }

        function clearManualCanvas() { canvasItems = []; currentX = 0; currentY = 0; maxRowH = 0; renderCanvasItems(); }

function printManualCanvas() {
    if(!canvasItems.length) return alert("Canvas kosong!");
    
    // 1. Candak Data Kertas & Settingan
    const dim = document.getElementById('m-paper').value.split(',');
    const pw = parseFloat(dim[0]), ph = parseFloat(dim[1]); 
    const useKres = document.getElementById('m-use-kres').checked;
    
    // 2. Candak Ukuran Kres tina Input (Default mun kosong)
    // Pastikeun input id 'm-kres-tebal' jeung 'm-kres-panjang' geus aya di HTML
    const tebalVal = document.getElementById('m-kres-tebal').value || 0.2;
    const panjangVal = document.getElementById('m-kres-panjang').value || 5;
    
    // Konversi ka string 'mm' keur CSS
    const kThick = tebalVal + 'mm';
    const kLen = panjangVal + 'mm';
    const kOff = '2mm'; // Jarak aman (offset) ti gambar ka kres

    // 3. Setup CSS Kertas & Style Kres
    let html = `<style>
        @page { size: ${pw}cm ${ph}cm; margin: 0; } 
        body { margin: 0; padding: 0; background: white; width: ${pw}cm; min-height: ${ph}cm; }
        .page-container { position: relative; width: ${pw}cm; height: ${ph}cm; overflow: hidden; }
        
        /* STYLE KHUSUS KRES */
        .k-mark { position: absolute; background: #000; z-index: 999; }
        
        /* Vertical & Horizontal Definitions */
        .k-v { width: ${kThick}; height: ${kLen}; }
        .k-h { height: ${kThick}; width: ${kLen}; }

        /* Posisi Kres (Relative ka Wrapper Gambar) */
        /* Juru Kenca-Luhur (Top-Left) */
        .tl-v { bottom: 100%; left: 0; margin-bottom: ${kOff}; } 
        .tl-h { right: 100%; top: 0; margin-right: ${kOff}; }

        /* Juru Katuhu-Luhur (Top-Right) */
        .tr-v { bottom: 100%; right: 0; margin-bottom: ${kOff}; }
        .tr-h { left: 100%; top: 0; margin-left: ${kOff}; }

        /* Juru Kenca-Handap (Bottom-Left) */
        .bl-v { top: 100%; left: 0; margin-top: ${kOff}; }
        .bl-h { right: 100%; bottom: 0; margin-right: ${kOff}; }

        /* Juru Katuhu-Handap (Bottom-Right) */
        .br-v { top: 100%; right: 0; margin-top: ${kOff}; }
        .br-h { left: 100%; bottom: 0; margin-left: ${kOff}; }

        .img-wrap { position: absolute; display: flex; align-items: center; justify-content: center; }
    </style>`;

    html += `<div class="page-container">`;

    // 4. Loop Unggal Item Gambar
    canvasItems.forEach(item => {
        let marks = '';
        
        if(useKres) {
            // Urang nyieun 8 garis (2 per juru) nu arahna kaluar
            // Ieu teknik pang amanna ameh mun rapet (gap 0) jadi nyampur, mun renggang jadi papisah
            
            // Top-Left
            marks += `<div class="k-mark k-v tl-v"></div><div class="k-mark k-h tl-h"></div>`;
            // Top-Right
            marks += `<div class="k-mark k-v tr-v"></div><div class="k-mark k-h tr-h"></div>`;
            // Bottom-Left
            marks += `<div class="k-mark k-v bl-v"></div><div class="k-mark k-h bl-h"></div>`;
            // Bottom-Right
            marks += `<div class="k-mark k-v br-v"></div><div class="k-mark k-h br-h"></div>`;
        }

        // Render Item
        html += `
        <div class="img-wrap" style="left:${item.x}cm; top:${item.y}cm; width:${item.renderW}cm; height:${item.renderH}cm;">
            ${marks}
            <img src="${item.data}" style="width:${item.w}cm; height:${item.h}cm; transform:rotate(${item.rot}deg); object-fit:fill; display:block;">
        </div>`;
    });

    html += `</div>`;

    // 5. Eksekusi Print
    const f = document.getElementById('p-frame');
    f.style.display = "block";
    f.contentWindow.document.open();
    f.contentWindow.document.write(html);
    f.contentWindow.document.close();
    
    const btn = document.querySelector('#modal-manual-layout .btn-success');
    const oldText = btn.innerText;
    btn.innerText = "RENDERING...";
    
    setTimeout(() => { 
        f.contentWindow.print(); 
        f.style.display="none"; 
        btn.innerText = oldText;
    }, 1000);
}
    </script>
</body>
</html>
